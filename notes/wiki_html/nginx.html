<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=cp936">

<script type="text/javascript" src="../../vimwiki-theme/code/theme/scripts/jquery-1.4.2.min.js"></script>

<link type="text/css" rel="stylesheet" href="../../vimwiki-theme/hightlight-code/styles/shCore.css"/>
<link type="text/css" rel="stylesheet" href="../../vimwiki-theme/hightlight-code/styles/shCoreRDark.css"/>
<link type="text/css" rel="stylesheet" href="../../vimwiki-theme/hightlight-code/styles/shThemeRDark.css"/>
<script type="text/javascript" src="../../vimwiki-theme/hightlight-code/scripts/shCore.js"></script>
<script type="text/javascript" src="../../vimwiki-theme/hightlight-code/scripts/shAutoloader.js"></script>

<link type="text/css" rel="stylesheet" href="../../vimwiki-theme/code/theme/styles/style.css" />

<script type="text/javascript" src="../../vimwiki-theme/code/theme/scripts/script.js"></script>


<title>Nginx</title>
</head>
<body>



<h1>Nginx</h1>
<div class="toc">
<ul>
<li><a href="#toc_1">安装与配置</a>
<ul>
<li><a href="#toc_1.1">安装</a>
<li><a href="#toc_1.2">启动、停止、重启</a>
</ul>
<li><a href="#toc_2">基本配置</a>
<ul>
<li><a href="#toc_2.1">虚拟主机的配置</a>
<ul>
<li><a href="#toc_2.1.1">虚拟主机</a>
<li><a href="#toc_2.1.2">基于IP的虚拟主机</a>
<li><a href="#toc_2.1.3">基于子域名的虚拟主机</a>
</ul>
<li><a href="#toc_2.2">日志文件配置与切割</a>
</ul>
</ul>
</div>

<h1 id="toc_1">安装与配置</h1>

<h2 id="toc_1.1">安装</h2>

<h2 id="toc_1.2">启动、停止、重启</h2>

<p>
先看一下help：
</p>

<pre class="brush: bash">
$ nginx -h    
nginx version: nginx/1.1.19
Usage: nginx [-?hvVtq] [-s signal] [-c filename] [-p prefix] [-g directives]

Options:
  -?,-h         : this help
  -v            : show version and exit
  -V            : show version and configure options then exit
  -t            : test configuration and exit
  -q            : suppress non-error messages during configuration testing
  -s signal     : send signal to a master process: stop, quit, reopen, reload
  -p prefix     : set prefix path (default: /etc/nginx/)
  -c filename   : set configuration file (default: /etc/nginx/nginx.conf)
  -g directives : set global directives out of configuration file
</pre>

<p>
从上面可以看出来配置文件都在<code>/etc/nginx</code>目录下。
</p>

<p>
先检查配置文件是否正确：
</p>

<pre class="brush: bash">
$ sudo nginx -t -c /etc/nginx/nginx.conf
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
</pre>

<p>
如果有错的话会报错在第几行。
</p>

<p>
ubuntu环境下基本命令：
</p>

<pre class="brush: bash">
sudo /etc/init.d/nginx stop
sudo /etc/init.d/nginx start
sudo /etc/init.d/nginx restart
</pre>

<p>
其他方法：
</p>

<p>
启动：
</p>

<pre class="brush: bash">
nginx -c /etc/nginx/nginx.conf
</pre>

<p>
停止用<code>kill</code>：
</p>

<pre class="brush: bash">
// 等待退出
kill - QUIT &lt;进程号&gt;
// 或
kill - QUIT `/usr/local/webserver/nginx/logs/nginx.pid`

// 马上退出
kill - TERM &lt;进程号&gt;
// 或
kill - TERM `/usr/local/webserver/nginx/logs/nginx.pid`
// 或
kill - INT &lt;进程号&gt;
// 或
kill - INT `/usr/local/webserver/nginx/logs/nginx.pid`

// 强杀
kill -9 &lt;进程号&gt;
</pre>



<h1 id="toc_2">基本配置</h1>

<p>
配置文件<code>nginx.conf</code>基本结构：
</p>

<pre class="brush: bash">
...

events { ...  }

http {
	...
	server { ...  }
	server { ...  }
	...
}
</pre>

<p>
实际的例子：
</p>

<pre class="brush: bash">
user www-data;                                                                                                                             
worker_processes 4;                                                             
pid /var/run/nginx.pid;                                                         
                                                                                
events {                                                                        
  worker_connections 768;                                                       
  # multi_accept on;                                                            
}                                                                               
                                                                                
http {                                                                          
                                                                                
  ##                                                                            
  # Basic Settings                                                              
  ##                                                                            
                                                                                
  sendfile on;                                                                  
  tcp_nopush on;                                                                
  tcp_nodelay on;                                                               
  keepalive_timeout 65;                                                         
  types_hash_max_size 2048;                                                     
  # server_tokens off;                                                          
                                                                                
  # server_names_hash_bucket_size 64;                                           
  # server_name_in_redirect off;                                                
                                                                                
  include /etc/nginx/mime.types;                                                
  default_type application/octet-stream;                                        
                                                                                
  ##                                                                            
  # Logging Settings                                                            
  ##                                                                            
                                                                                
  access_log /var/log/nginx/access.log;                                         
  error_log /var/log/nginx/error.log;         
                                                                                
  ##                                                                            
  # Gzip Settings                                                               
  ##                                                                            
                                                                                
  gzip on;                                                                      
  gzip_disable "msie6";                                                         
                                                                                
  # gzip_vary on;                                                               
  # gzip_proxied any;                                                           
  # gzip_comp_level 6;                                                          
  # gzip_buffers 16 8k;                                                         
  # gzip_http_version 1.1;                                                      
  # gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;
                                                                                
  ##                                                                            
  # nginx-naxsi config                                                          
  ##                                                                            
  # Uncomment it if you installed nginx-naxsi                                   
  ##                                                                            
                                                                                
  #include /etc/nginx/naxsi_core.rules;                                         
                                                                                
  ##                                                                            
  # nginx-passenger config                                                      
  ##                                                                            
  # Uncomment it if you installed nginx-passenger                               
  ##                                                                            
                                                                                
  #passenger_root /usr;                                                         
  #passenger_ruby /usr/bin/ruby;                                                
                                                                                
  ##                                                                            
  # Virtual Host Configs                                                        
  ##                                                                            
                 
  include /etc/nginx/conf.d/*.conf;                                             
  include /etc/nginx/sites-enabled/*;                                           
}                                                                               
                                                                                
                                                                                
#mail {                                                                         
# # See sample authentication script at:                                        
# # http://wiki.nginx.org/ImapAuthenticateWithApachePhpScript                   
#                                                                               
# # auth_http localhost/auth.php;                                               
# # pop3_capabilities "TOP" "USER";                                             
# # imap_capabilities "IMAP4rev1" "UIDPLUS";                                    
#                                                                               
# server {                                                                      
#   listen     localhost:110;                                                   
#   protocol   pop3;                                                            
#   proxy      on;                                                              
# }                                                                             
#                                                                               
# server {                                                                      
#   listen     localhost:143;                                                   
#   protocol   imap;                                                            
#   proxy      on;                                                              
# }                                                                             
#}  
</pre>


<h2 id="toc_2.1">虚拟主机的配置</h2>

<h3 id="toc_2.1.1">虚拟主机</h3>

<p>
在同一台服务器、同一组Nginx进程作为多台虚拟的主机，最简配置：
</p>

<pre class="brush: bash">
http 
{
	server
	{
		listen				80 default;
		server_name   _  *;
		access_log		logs/default.access.log combined;
		location / {
			index index.html;
			root	/data0/htdocs/htdocs;
		}
	}
}
</pre>

<p>
与Apache一样虚拟主机可以通过三种方式实现：基于IP、基于子域名、基于端口。
</p>

<h3 id="toc_2.1.2">基于IP的虚拟主机</h3>

<p>
绑定两个IP地址到eth0网卡：
</p>

<pre class="brush: bash">
ifconfig eth0:1 192.168.8.43 broadcast 192.168.8.255 netmask 255.255.255.0 up
route add -host 192.168.8.43 dev eth0:1

ifconfig eth0:1 192.168.8.44 broadcast 192.168.8.255 netmask 255.255.255.0 up
route add -host 192.168.8.44 dev eth0:1
</pre>

<p>
现在根据在个IP地址<code>192.168.8.43-45</code>三个地址搞三个虚拟主机：
</p>

<pre class="brush: bash">
http
{
	server
	{
		listen			192.168.8.43:80
		server_name 192.168.8.43;
		# log file
		assess_log	logs/server1.assess.log combined;
		location /
		{
			# default home page
			index index.html index.htm
			# root path of web
			root /data0/htdocs/server1;
		}
	}
	server
	{
		listen			192.168.8.44:80
		server_name 192.168.8.44;
		# log file
		assess_log	logs/server2.assess.log combined;
		location /
		{
			# default home page
			index index.html index.htm
			# root path of web
			root /data0/htdocs/server2;
		}
	}
	server
	{
		listen			192.168.8.45:80
		server_name 192.168.8.45;
		# log file
		assess_log	logs/server3.assess.log combined;
		location /
		{
			# default home page
			index index.html index.htm
			# root path of web
			root /data0/htdocs/server3;
		}
	}
}
</pre>

<h3 id="toc_2.1.3">基于子域名的虚拟主机</h3>

<p>
通过dns域名来节约IP地址。现在同一个地址被在个域名映射：
</p>

<p>
<code>aaa.domain.com</code>、<code>bbb.domain.com</code>为两个不同的目录，
</p>

<p>
<code>www.domain.com</code>、<code>*.domain.com</code>或是<code>domain.com</code>都被映射到第三个目录。
</p>

<pre class="brush: bash">
http
{
	server
	{
		listen			80
		server_name aaa.domain.com;
		# log file
		assess_log	logs/aaa.domain.com.assess.log combined;
		location /
		{
			# default home page
			index index.html index.htm
			# root path of web
			root /data0/htdocs/aaa.domain.com;
		}
	}
	server
	{
		listen			80
		server_name bbb.domain.com;
		# log file
		assess_log	logs/bbb.domain.com.assess.log combined;
		location /
		{
			# default home page
			index index.html index.htm
			# root path of web
			root /data0/htdocs/bbb.domain.com;
		}
	}
	server
	{
		listen			80
		server_name www.domain.com domain.com *.domain.com;
		# log file
		assess_log	logs/www.domain.com.assess.log combined;
		location /
		{
			# default home page
			index index.html index.htm
			# root path of web
			root /data0/htdocs/ccc.domain.com;
		}
	}
}
</pre>

<h2 id="toc_2.2">日志文件配置与切割</h2>

<p>
<code>log_format</code>设置日志格式；<code>access_log</code>设置存放的位置、格式与缓存大小。
</p>

<p>
这两条在<code>http{...}</code>与<code>server{...}</code>块中都可以放置。
</p>

<pre class="brush: bash">
</pre>


<pre class="brush: bash">
</pre>


<pre class="brush: bash">
</pre>


<pre class="brush: bash">
</pre>


<pre class="brush: bash">
</pre>


</body>
</html>
