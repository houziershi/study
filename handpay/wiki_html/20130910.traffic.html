<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

<script type="text/javascript" src="../../vimwiki-theme/code/theme/scripts/jquery-1.4.2.min.js"></script>

<link type="text/css" rel="stylesheet" href="../../vimwiki-theme/hightlight-code/styles/shCore.css"/>
<link type="text/css" rel="stylesheet" href="../../vimwiki-theme/hightlight-code/styles/shThemeDefault.css"/>
<script type="text/javascript" src="../../vimwiki-theme/hightlight-code/scripts/shCore.js"></script>
<script type="text/javascript" src="../../vimwiki-theme/hightlight-code/scripts/shAutoloader.js"></script>

<script type="text/javascript" src="../../vimwiki-theme/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

<script type="text/javascript" src="../../vimwiki-theme/code/theme/scripts/script.js"></script>
<link type="text/css" rel="stylesheet" href="../../vimwiki-theme/code/theme/styles/style.css" />


<title>交罚</title>
</head>
<body  onresize='changeTocSize()'>
	<div class="note-main"> 


<h1>交罚</h1>
<div class="toc">
<ul>
<li><a href="#toc_1">设计</a>
<ul>
<li><a href="#toc_1.1">表结构</a>
<ul>
<li><a href="#toc_1.1.1">查询记录 r</a>
<li><a href="#toc_1.1.2">违章记录 v</a>
<li><a href="#toc_1.1.3">订单 o</a>
<li><a href="#toc_1.1.4">订单详情 d</a>
<li><a href="#toc_1.1.5">瀚银订单 m</a>
</ul>
<li><a href="#toc_1.2">主要类</a>
</ul>
<li><a href="#toc_2">功能</a>
<ul>
<li><a href="#toc_2.1">交易明细报表</a>
<li><a href="#toc_2.2">查询费用报表</a>
</ul>
</ul>
</div>

<pre class="brush: scala">
scp ./*.jar  dsdev15@dev1.hpdev.com:~/server/default/deploy/handpay
</pre>

<h1 id="toc_1">设计</h1>

<h2 id="toc_1.1">表结构</h2>

<h3 id="toc_1.1.1">查询记录 r</h3>

<p>
traffic_violation_query_record 
</p>

<table>
<tr>
<td>
SEQUENCE
</td>
<td>
NOT NULL
</td>
<td>
NUMBER(38)
</td>
<td>
序号
</td>
</tr>
<tr>
<td>
UserId
</td>
<td>
&nbsp;
</td>
<td>
NUMBER(38)
</td>
<td>
用户
</td>
</tr>
<tr>
<td>
QueryDate
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(8)
</td>
<td>
查询日期
</td>
</tr>
<tr>
<td>
QueryTime
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(6)
</td>
<td>
查询时间
</td>
</tr>
<tr>
<td>
CarNo
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(20)
</td>
<td>
车牌号
</td>
</tr>
<tr>
<td>
City
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(200)
</td>
<td>
查询城市名
</td>
</tr>
<tr>
<td>
QueryFee
</td>
<td>
&nbsp;
</td>
<td>
NUMBER(8,2)
</td>
<td>
每次查询费用
</td>
</tr>
<tr>
<td>
EngineNo
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(40)
</td>
<td>
发动机号
</td>
</tr>
<tr>
<td>
CarFrameNo
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(40)
</td>
<td>
车身号
</td>
</tr>
<tr>
<td>
ViolationSn
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(40)
</td>
<td>
罚单号
</td>
</tr>
</table>

<h3 id="toc_1.1.2">违章记录 v</h3>

<p>
traffic_violation 
</p>

<table>
<tr>
<td>
InnerSeq
</td>
<td>
NOT NULL
</td>
<td>
NUMBER(38)
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
SupplierCode
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(20)
</td>
<td>
供应商代码
</td>
</tr>
<tr>
<td>
TempId
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(40)
</td>
<td>
供应商那边的流水号
</td>
</tr>
<tr>
<td>
ViolationSn
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(40)
</td>
<td>
罚单号
</td>
</tr>
<tr>
<td>
CarNo
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(20)
</td>
<td>
车牌号
</td>
</tr>
<tr>
<td>
CarType
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(10)
</td>
<td>
车辆类型
</td>
</tr>
<tr>
<td>
ProvinceCode
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(20)
</td>
<td>
省代码
</td>
</tr>
<tr>
<td>
ProvinceName
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(40)
</td>
<td>
省名称
</td>
</tr>
<tr>
<td>
CityCode
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(20)
</td>
<td>
市代码
</td>
</tr>
<tr>
<td>
CityName
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(40)
</td>
<td>
市名称
</td>
</tr>
<tr>
<td>
AreaCode
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(20)
</td>
<td>
区代码
</td>
</tr>
<tr>
<td>
AreaName
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(40)
</td>
<td>
区名称
</td>
</tr>
<tr>
<td>
RegulationId
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(20)
</td>
<td>
违章条例id
</td>
</tr>
<tr>
<td>
RegulationCode
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(20)
</td>
<td>
违章条例代码
</td>
</tr>
<tr>
<td>
RegulationName
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(500)
</td>
<td>
违章条例名称
</td>
</tr>
<tr>
<td>
FineAmount
</td>
<td>
&nbsp;
</td>
<td>
NUMBER(8,2)
</td>
<td>
罚款金额
</td>
</tr>
<tr>
<td>
Point
</td>
<td>
&nbsp;
</td>
<td>
NUMBER(38)
</td>
<td>
扣分
</td>
</tr>
<tr>
<td>
ViolationRoad
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(500)
</td>
<td>
违章路段
</td>
</tr>
<tr>
<td>
ViolationTime
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(14)
</td>
<td>
违章时间
</td>
</tr>
<tr>
<td>
Authority
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(100)
</td>
<td>
执法机关
</td>
</tr>
<tr>
<td>
DealAddress
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(100)
</td>
<td>
违章办理地址
</td>
</tr>
<tr>
<td>
IsOnsit
</td>
<td>
&nbsp;
</td>
<td>
NUMBER(38)
</td>
<td>
是否现场单
</td>
</tr>
<tr>
<td>
OverdueFine
</td>
<td>
&nbsp;
</td>
<td>
NUMBER(8,2)
</td>
<td>
滞纳金
</td>
</tr>
<tr>
<td>
DealStatus
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(10)
</td>
<td>
办理状态
</td>
</tr>
<tr>
<td>
NeedDays
</td>
<td>
&nbsp;
</td>
<td>
NUMBER(38)
</td>
<td>
代办周期
</td>
</tr>
<tr>
<td>
PayCharge
</td>
<td>
&nbsp;
</td>
<td>
NUMBER(8,2)
</td>
<td>
代办费
</td>
</tr>
<tr>
<td>
EngineNo
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(40)
</td>
<td>
发动机号（后六位）（必填）
</td>
</tr>
<tr>
<td>
CarFrameNo
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(40)
</td>
<td>
车身号（后六位）（必填）
</td>
</tr>
</table>

<p>
罚单状态：
</p>

<ul>
<li>
<code>0</code>不可办理

<li>
<code>1</code>可办理

<li>
<code>2</code>处理中

<li>
<code>3</code>已完成

<li>
<code>4</code>待支付

</ul>


<h3 id="toc_1.1.3">订单 o</h3>

<p>
traffic_violation_order 
</p>

<table>
<tr>
<td>
Id
</td>
<td>
NOT NULL
</td>
<td>
NUMBER(38)
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
SupplierCode
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(20)
</td>
<td>
供应商
</td>
</tr>
<tr>
<td>
FineamoUnt
</td>
<td>
&nbsp;
</td>
<td>
NUMBER(8,2)
</td>
<td>
罚款金额
</td>
</tr>
<tr>
<td>
OverdueFine
</td>
<td>
&nbsp;
</td>
<td>
NUMBER(8,2)
</td>
<td>
滞纳金
</td>
</tr>
<tr>
<td>
ServiceFee
</td>
<td>
&nbsp;
</td>
<td>
NUMBER(8,2)
</td>
<td>
服务费
</td>
</tr>
<tr>
<td>
PayCharge
</td>
<td>
&nbsp;
</td>
<td>
NUMBER(8,2)
</td>
<td>
代办费
</td>
</tr>
<tr>
<td>
DealStatus
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(10)
</td>
<td>
交易状态
</td>
</tr>
<tr>
<td>
MerchantTransSeq
</td>
<td>
&nbsp;
</td>
<td>
NUMBER(38)
</td>
<td>
瀚银订单号
</td>
</tr>
<tr>
<td>
MerchantTransDate
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(14)
</td>
<td>
瀚银订单时间
</td>
</tr>
<tr>
<td>
MerchantOrderSeq
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(40)
</td>
<td>
供应商订单号
</td>
</tr>
<tr>
<td>
MerchantOrderDate
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(14)
</td>
<td>
供应商订单时间
</td>
</tr>
<tr>
<td>
ContactName
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(20)
</td>
<td>
交易人姓名
</td>
</tr>
<tr>
<td>
ContactMobile
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(20)
</td>
<td>
交易人手机
</td>
</tr>
<tr>
<td>
UserId
</td>
<td>
&nbsp;
</td>
<td>
NUMBER(38)
</td>
<td>
用户
</td>
</tr>
<tr>
<td>
RealCharge
</td>
<td>
&nbsp;
</td>
<td>
NUMBER(8,2)
</td>
<td>
供应商那里的实际金额
</td>
</tr>
<tr>
<td>
ViolationSmlateFee
</td>
<td>
&nbsp;
</td>
<td>
NUMBER(8,2)
</td>
<td>
供应商那边的滞纳金总费用
</td>
</tr>
<tr>
<td>
TotalAmount
</td>
<td>
&nbsp;
</td>
<td>
NUMBER(8,2)
</td>
<td>
供应商那边的总计金额
</td>
</tr>
<tr>
<td>
ZhizunCustomerId
</td>
<td>
&nbsp;
</td>
<td>
NUMBER(38)
</td>
<td>
至尊那边的会员id 在提前支付接口用到
</td>
</tr>
</table>

<h3 id="toc_1.1.4">订单详情 d</h3>

<p>
traffic_violation_order_detail 
</p>

<table>
<tr>
<td>
Id
</td>
<td>
NOT NULL
</td>
<td>
NUMBER(38)
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
OrderId
</td>
<td>
&nbsp;
</td>
<td>
NUMBER(38)
</td>
<td>
罚单交纳记录 FK:traffic_violation_order
</td>
</tr>
<tr>
<td>
InnerViolationId
</td>
<td>
&nbsp;
</td>
<td>
NUMBER(38)
</td>
<td>
罚单内部序号 FK: traffic_violation
</td>
</tr>
<tr>
<td>
ViolationSn
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(40)
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
CarNo
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(20)
</td>
<td>
车牌号
</td>
</tr>
<tr>
<td>
IsOnsite
</td>
<td>
&nbsp;
</td>
<td>
NUMBER(38)
</td>
<td>
是否现场单
</td>
</tr>
<tr>
<td>
FineAmount
</td>
<td>
&nbsp;
</td>
<td>
NUMBER(8,2)
</td>
<td>
罚款金额
</td>
</tr>
<tr>
<td>
OverdueFine
</td>
<td>
&nbsp;
</td>
<td>
NUMBER(8,2)
</td>
<td>
滞纳金
</td>
</tr>
<tr>
<td>
ServiceFee
</td>
<td>
&nbsp;
</td>
<td>
NUMBER(8,2)
</td>
<td>
服务费
</td>
</tr>
<tr>
<td>
PayCharge
</td>
<td>
&nbsp;
</td>
<td>
NUMBER(8,2)
</td>
<td>
代办费
</td>
</tr>
<tr>
<td>
DealStatus
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(10)
</td>
<td>
交易状态
</td>
</tr>
<tr>
<td>
MerchantTransSeq
</td>
<td>
&nbsp;
</td>
<td>
NUMBER(38)
</td>
<td>
瀚银订单号
</td>
</tr>
<tr>
<td>
MerchantTransDate
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(14)
</td>
<td>
瀚银订单时间
</td>
</tr>
<tr>
<td>
MerchantOrderSeq
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(40)
</td>
<td>
供应商订单号
</td>
</tr>
<tr>
<td>
MerchantOrderDate
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(14)
</td>
<td>
供应商订单时间
</td>
</tr>
<tr>
<td>
ViolationId
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(20)
</td>
<td>
应商明细流水ID
</td>
</tr>
<tr>
<td>
MLateFee
</td>
<td>
&nbsp;
</td>
<td>
NUMBER(8,2)
</td>
<td>
应商那边的MlateFee滞纳金
</td>
</tr>
</table>

<h3 id="toc_1.1.5">瀚银订单 m</h3>

<p>
MERCH_TRANSACTION_LOG
</p>

<table>
<tr>
<td>
MerchantTransSeq
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(20)
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
DeliveryTime
</td>
<td>
&nbsp;
</td>
<td>
VARCHAR2(20)
</td>
<td>
发货时间
</td>
</tr>
</table>



<h2 id="toc_1.2">主要类</h2>

<p>
ITrafficService.queryViolationOrder
</p>

<p>
VposViolationDetailAction.java
</p>

<p>
vposViolationDetail.jsp
</p>

<p>
TrafficServiceImpl.queryViolations(..)
</p>

<h1 id="toc_2">功能</h1>

<h2 id="toc_2.1">交易明细报表</h2>

<p>
用于和供应商进行清结算核对，报表包含字段如下：
</p>

<table>
<tr>
<td>
序号
</td>
<td>
&nbsp;
</td>
<td>
rownum
</td>
</tr>
<tr>
<td>
订单生成日期
</td>
<td>
用户下单时间
</td>
<td>
m.merchantTransDate
</td>
</tr>
<tr>
<td>
订单支付时间
</td>
<td>
用户支付时间
</td>
<td>
m.paymentTransDate
</td>
</tr>
<tr>
<td>
订单完成时间
</td>
<td>
供应商返回处理状态的时间
</td>
<td>
m.deliveryTime
</td>
</tr>
<tr>
<td>
瀚银订单号
</td>
<td>
用户在瀚银下单后生成的订单号
</td>
<td>
d.MerchantTransDate
</td>
</tr>
<tr>
<td>
商户订单号
</td>
<td>
商户返回给我们的订单号
</td>
<td>
d.MerchantOrderSeq
</td>
</tr>
<tr>
<td>
商户订单明细编号
</td>
<td>
一笔订单中包含的罚单号
</td>
<td>
d.InnerViolationId
</td>
</tr>
<tr>
<td>
罚金
</td>
<td>
罚单金额
</td>
<td>
d.FineAmount
</td>
</tr>
<tr>
<td>
代办费
</td>
<td>
显示罚单代办费用
</td>
<td>
d.PayCharge
</td>
</tr>
<tr>
<td>
滞纳金
</td>
<td>
罚单需缴纳的滞纳金
</td>
<td>
d.OverdueFine
</td>
</tr>
<tr>
<td>
特单费
</td>
<td>
加急处理的费用
</td>
<td>
去掉
</td>
</tr>
<tr>
<td>
邮寄
</td>
<td>
发票邮寄金额
</td>
<td>
去掉
</td>
</tr>
<tr>
<td>
总计
</td>
<td>
用户实际支付金额
</td>
<td>
d.FineAmount + d.PayCharge + d.OverdueFine
</td>
</tr>
<tr>
<td>
返佣金额
</td>
<td>
每笔罚单的返佣金额
</td>
<td>
去掉
</td>
</tr>
<tr>
<td>
佣金单号
</td>
<td>
每笔罚单对应的订单号
</td>
<td>
去掉
</td>
</tr>
</table>

<pre class="brush: scala">
select 
  rownum , m.merchantTransDate , m.paymentTransDate , 
  m.deliveryTime , d.MerchantTransDate , d.MerchantOrderSeq, 
  d.InnerViolationId , d.FineAmount , d.PayCharge, 
  d.OverdueFine, d.FineAmount + d.PayCharge + d.OverdueFine
from
	traffic_violation_order_detail d 
		left join traffic_violation_order o 
			on d.orderId = o.id
		left join traffic_violation v 
			on d.innerviolationid = v.innerseq
		left join	MERCH_TRANSACTION_LOG m
			on d.MerchantTransSeq  = m.MerchantTransSeq;
</pre>


<h2 id="toc_2.2">查询费用报表</h2>

<p>
查询费用报表记录每次发起查询请求的详情，用于和供应商结算查询费用进行核对。报表
包含字段如下：
</p>

<table>
<tr>
<td>
序号
</td>
<td>
&nbsp;
</td>
<td>
rownum
</td>
</tr>
<tr>
<td>
城市
</td>
<td>
查询时填写的城市名
</td>
<td>
r.city
</td>
</tr>
<tr>
<td>
车牌号
</td>
<td>
查询时填写的车牌号
</td>
<td>
r.CarNo
</td>
</tr>
<tr>
<td>
查询时间
</td>
<td>
显示查询发起的时间
</td>
<td>
r.querydate 接 r.querytime
</td>
</tr>
<tr>
<td>
查询费用
</td>
<td>
固定为每次0.05元
</td>
<td>
r.QueryFee
</td>
</tr>
<tr>
<td>
车架号
</td>
<td>
显示用户填写的发动机号
</td>
<td>
r.CarFrameNo
</td>
</tr>
<tr>
<td>
发动机号
</td>
<td>
显示用户填写的发动机号
</td>
<td>
r.EngineNo
</td>
</tr>
<tr>
<td>
违章单号
</td>
<td>
显示查询的违章单号---支持多个记录
</td>
<td>
r.ViolationSn
</td>
</tr>
</table>

<pre class="brush: scala">
select 
	rownum, r.city, r.CarNo , r.querydate || r.querytime,
	r.QueryFee, r.CarFrameNo, r.EngineNo, r.ViolationSn 
from 
	traffic_violation_query_record r
</pre>
 </div>
</body>
</html>
