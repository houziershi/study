<!DOCTYPE html>
<html><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<title>AngularJS学习笔记 - 进出自由,我的分享</title>
<meta name="generator" content="http://txt2tags.org">
<meta name="author" content="Yesheng Zou,YS.Zou,邹业盛">
<meta name="keywords" content="AngularJS学习笔记,Yesheng Zou,YS.Zou,邹业盛,孤高天使,AceFantasy">
<meta name="description" content="AngularJS学习笔记,Yesheng Zou,YS.Zou,邹业盛,孤高天使,AceFantasy的个人网站">
<script src="AngularJS.note_files/ga.js" async="" type="text/javascript"></script><script src="AngularJS.note_files/embed.js" async="" type="text/javascript"></script></head>
<body onload="prettyPrint()" style=" margin: 0px; padding: 0px; background-image: url(http://zouyesheng.com/static/bg.jpg); font-family: Arial,Helvetica,sans-serif; ">
<div id="zys-wrapper" style=" width: 700px; margin: auto; font-size: 15px; line-height: 1.6em; color: #333; letter-spacing: 1px; padding: 30px; background-color: white; ">

<h1 style=" color: black; letter-spacing: 0.2em; text-align: center; font-size: x-large; font-weight: bold; text-shadow: 2px 2px 2px gray; margin: 30px auto 30px auto; ">AngularJS学习笔记</h1>

<div style=" float: right; font-size: 13px; color: #777; ">
    <ul style=" text-align: right; ">
        <li style=" list-style-type: none; border-right: 4px solid rgb(0, 120, 181); padding-right: 10px; ">2013-08-09 00:19 更新</li>
        <li style=" list-style-type: none; border-right: 4px solid rgb(0, 120, 181); padding-right: 10px; ">邹业盛</li>
    </ul>
</div>


  <ol style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
  <li><a href="#toc1" style="color: #0184b7; text-decoration: none">关于AngularJS</a>
  </li>
  <li><a href="#toc2" style="color: #0184b7; text-decoration: none">关于本文档</a>
  </li>
  <li><a href="#toc3" style="color: #0184b7; text-decoration: none">开始的例子</a>
  </li>
  <li><a href="#toc4" style="color: #0184b7; text-decoration: none">依赖注入</a>
  </li>
  <li><a href="#toc5" style="color: #0184b7; text-decoration: none">作用域</a>
  </li>
  <li><a href="#toc6" style="color: #0184b7; text-decoration: none">数据绑定与模板</a>
    <ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
    <li><a href="#toc7" style="color: #0184b7; text-decoration: none">6.1. 数据-&gt;模板</a>
    </li>
    <li><a href="#toc8" style="color: #0184b7; text-decoration: none">6.2. 模板-&gt;数据</a>
    </li>
    <li><a href="#toc9" style="color: #0184b7; text-decoration: none">6.3. 数据-&gt;模板-&gt;数据-&gt;模板</a>
    </li>
    </ul>
  </li>
  <li><a href="#toc10" style="color: #0184b7; text-decoration: none">模板</a>
    <ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
    <li><a href="#toc11" style="color: #0184b7; text-decoration: none">7.1. 定义模板内容</a>
    </li>
    <li><a href="#toc12" style="color: #0184b7; text-decoration: none">7.2. 内容渲染控制</a>
    </li>
    <li><a href="#toc15" style="color: #0184b7; text-decoration: none">7.3. 节点控制</a>
    </li>
    <li><a href="#toc20" style="color: #0184b7; text-decoration: none">7.4. 事件绑定</a>
    </li>
    <li><a href="#toc21" style="color: #0184b7; text-decoration: none">7.5. 表单控件</a>
    </li>
    </ul>
  </li>
  <li><a href="#toc28" style="color: #0184b7; text-decoration: none">模板中的过滤器</a>
    <ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
    <li><a href="#toc29" style="color: #0184b7; text-decoration: none">8.1. 排序 orderBy</a>
    </li>
    <li><a href="#toc30" style="color: #0184b7; text-decoration: none">8.2. 过滤列表 filter</a>
    </li>
    <li><a href="#toc31" style="color: #0184b7; text-decoration: none">8.3. 其它</a>
    </li>
    <li><a href="#toc32" style="color: #0184b7; text-decoration: none">8.4. 例子：表头排序</a>
    </li>
    <li><a href="#toc33" style="color: #0184b7; text-decoration: none">8.5. 例子：搜索</a>
    </li>
    </ul>
  </li>
  <li><a href="#toc34" style="color: #0184b7; text-decoration: none">锚点路由</a>
    <ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
    <li><a href="#toc35" style="color: #0184b7; text-decoration: none">9.1. 路由定义</a>
    </li>
    <li><a href="#toc36" style="color: #0184b7; text-decoration: none">9.2. 参数定义</a>
    </li>
    <li><a href="#toc37" style="color: #0184b7; text-decoration: none">9.3. 业务处理</a>
    </li>
    </ul>
  </li>
  <li><a href="#toc38" style="color: #0184b7; text-decoration: none">定义模板变量标识标签</a>
  </li>
  <li><a href="#toc39" style="color: #0184b7; text-decoration: none">AJAX</a>
    <ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
    <li><a href="#toc40" style="color: #0184b7; text-decoration: none">11.1. HTTP请求</a>
    </li>
    <li><a href="#toc41" style="color: #0184b7; text-decoration: none">11.2. 广义回调管理</a>
    </li>
    </ul>
  </li>
  <li><a href="#toc45" style="color: #0184b7; text-decoration: none">工具函数</a>
    <ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
    <li><a href="#toc46" style="color: #0184b7; text-decoration: none">12.1. 上下文绑定</a>
    </li>
    <li><a href="#toc47" style="color: #0184b7; text-decoration: none">12.2. 对象处理</a>
    </li>
    <li><a href="#toc48" style="color: #0184b7; text-decoration: none">12.3. 类型判定</a>
    </li>
    </ul>
  </li>
  <li><a href="#toc49" style="color: #0184b7; text-decoration: none">其它服务</a>
    <ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
    <li><a href="#toc50" style="color: #0184b7; text-decoration: none">13.1. 日志</a>
    </li>
    <li><a href="#toc51" style="color: #0184b7; text-decoration: none">13.2. 缓存</a>
    </li>
    <li><a href="#toc52" style="color: #0184b7; text-decoration: none">13.3. 计时器</a>
    </li>
    <li><a href="#toc53" style="color: #0184b7; text-decoration: none">13.4. 表达式函数化</a>
    </li>
    <li><a href="#toc54" style="color: #0184b7; text-decoration: none">13.5. 模板单独使用</a>
    </li>
    </ul>
  </li>
  <li><a href="#toc55" style="color: #0184b7; text-decoration: none">自定义模块和服务</a>
    <ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
    <li><a href="#toc56" style="color: #0184b7; text-decoration: none">14.1. 模块和服务的概念与关系</a>
    </li>
    <li><a href="#toc57" style="color: #0184b7; text-decoration: none">14.2. 定义模块</a>
    </li>
    <li><a href="#toc58" style="color: #0184b7; text-decoration: none">14.3. 定义服务</a>
    </li>
    <li><a href="#toc59" style="color: #0184b7; text-decoration: none">14.4. 引入模块并使用服务</a>
    </li>
    </ul>
  </li>
  <li><a href="#toc60" style="color: #0184b7; text-decoration: none">附加模块 ngResource</a>
    <ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
    <li><a href="#toc61" style="color: #0184b7; text-decoration: none">15.1. 使用引入与整体概念</a>
    </li>
    <li><a href="#toc62" style="color: #0184b7; text-decoration: none">15.2. 基本定义</a>
    </li>
    <li><a href="#toc63" style="color: #0184b7; text-decoration: none">15.3. 基本使用</a>
    </li>
    <li><a href="#toc64" style="color: #0184b7; text-decoration: none">15.4. 定义和使用时的占位量</a>
    </li>
    <li><a href="#toc65" style="color: #0184b7; text-decoration: none">15.5. 实例</a>
    </li>
    </ul>
  </li>
  <li><a href="#toc66" style="color: #0184b7; text-decoration: none">AngularJS与其它框架的混用(jQuery, Dojo)</a>
  </li>
  <li><a href="#toc67" style="color: #0184b7; text-decoration: none">自定义过滤器</a>
  </li>
  <li><a href="#toc68" style="color: #0184b7; text-decoration: none">自定义指令directive</a>
    <ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
    <li><a href="#toc69" style="color: #0184b7; text-decoration: none">18.1. 指令的使用</a>
    </li>
    <li><a href="#toc70" style="color: #0184b7; text-decoration: none">18.2. 指令的执行过程</a>
    </li>
    <li><a href="#toc71" style="color: #0184b7; text-decoration: none">18.3. 基本的自定义方法</a>
    </li>
    <li><a href="#toc72" style="color: #0184b7; text-decoration: none">18.4. 属性值类型的自定义</a>
    </li>
    <li><a href="#toc73" style="color: #0184b7; text-decoration: none">18.5. Compile的细节</a>
    </li>
    <li><a href="#toc74" style="color: #0184b7; text-decoration: none">18.6. transclude的细节</a>
    </li>
    <li><a href="#toc75" style="color: #0184b7; text-decoration: none">18.7. 把节点内容作为变量处理的类型</a>
    </li>
    <li><a href="#toc76" style="color: #0184b7; text-decoration: none">18.8. 指令定义时的参数</a>
    </li>
    <li><a href="#toc77" style="color: #0184b7; text-decoration: none">18.9. Attributes的细节</a>
    </li>
    <li><a href="#toc78" style="color: #0184b7; text-decoration: none">18.10. 预定义的 NgModelController</a>
    </li>
    <li><a href="#toc79" style="color: #0184b7; text-decoration: none">18.11. 预定义的 FormController</a>
    </li>
    <li><a href="#toc80" style="color: #0184b7; text-decoration: none">18.12. 示例：文本框</a>
    </li>
    <li><a href="#toc81" style="color: #0184b7; text-decoration: none">18.13. 示例：模板控制语句 for</a>
    </li>
    <li><a href="#toc82" style="color: #0184b7; text-decoration: none">18.14. 示例：模板控制语句 if/else</a>
    </li>
    </ul>
  </li>
  </ol>


<a id="toc1" name="toc1"></a>
<h1 style=" -moz-border-radius: 5px; -webkit-border-radius: 5px; -moz-box-shadow: 3px 3px 5px #333; -webkit-box-shadow: 3px 3px 5px #333; box-shadow: 3px 3px 5px #333;  border-radius: 5px; background-color: #69ab01; padding: 4px; color: white; line-height: 1.3em; text-shadow: 2px 2px 2px black; margin: 20px auto; font-size: medium; clear: both;">1. 关于AngularJS</h1>

<p style="margin: 15px 0;">
<a href="http://angularjs.org/" style="color: #0184b7; text-decoration: none">AngularJS</a> 是 Google 开源出来的一套 js 工具。下面简称其为 <a href="http://docs.angularjs.org/misc/faq" style="color: #0184b7; text-decoration: none">ng</a> 。这里只说它是“工具”，没说它是完整的“框架”，是因为它并不是定位于去完成一套框架要做的事。更重要的，是它给我们揭示了一种新的应用组织与开发方式。
</p>
<p style="margin: 15px 0;">
ng 
最让我称奇的，是它的数据双向绑定。其实想想，我们一直在提数据与表现的分离，但是这里的“双向绑定”从某方面来说，是把数据与表现完全绑定在一起——数
据变化，表现也变化。反之，表现变化了，内在的数据也变化。有过开发经验的人能体会到这种机制对于前端应用来说，是很有必要的，能带来维护上的巨大优势。
当然，这里的绑定与提倡的分离并不是矛盾的。
</p>
<p style="margin: 15px 0;">
ng 可以和 jQuery 集成工作，事实上，如果没有 jQuery ， ng 自己也做了一个轻量级的 jQuery ，主要实现了元素操作部分的 API 。
</p>
<p style="margin: 15px 0;">
关于 ng 的几点：
</p>

<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li>对 IE 方面，它兼容 IE8 及以上的版本。
</li>
<li>与 jQuery 集成工作，它的一些对象与 jQuery 相关对象表现是一致的。
</li>
<li>使用 ng 时不要冒然去改变相关 DOM 的结构。
</li>
</ul>

<a id="toc2" name="toc2"></a>
<h1 style=" -moz-border-radius: 5px; -webkit-border-radius: 5px; -moz-box-shadow: 3px 3px 5px #333; -webkit-box-shadow: 3px 3px 5px #333; box-shadow: 3px 3px 5px #333;  border-radius: 5px; background-color: #69ab01; padding: 4px; color: white; line-height: 1.3em; text-shadow: 2px 2px 2px black; margin: 20px auto; font-size: medium; clear: both;">2. 关于本文档</h1>

<p style="margin: 15px 0;">
这份文档如其名，是我自己学习 ng 
的过程记录。只是过程记录，没有刻意像教程那样去做。所以呢，从前至后，中间不免有一些概念不清不明的地方。因为事实上，在某个阶段对于一些概念本来就不
可能明白。所以，整个过程只求在形式上的能用即可——直到最后的“自定义”那几章，特别是“自定义指令”，那几章过完，你才能看清 ng 
本来的面貌。前面就不要太纠结概念，本质，知道怎么用就好。
</p>

<a id="toc3" name="toc3"></a>
<h1 style=" -moz-border-radius: 5px; -webkit-border-radius: 5px; -moz-box-shadow: 3px 3px 5px #333; -webkit-box-shadow: 3px 3px 5px #333; box-shadow: 3px 3px 5px #333;  border-radius: 5px; background-color: #69ab01; padding: 4px; color: white; line-height: 1.3em; text-shadow: 2px 2px 2px black; margin: 20px auto; font-size: medium; clear: both;">3. 开始的例子</h1>

<p style="margin: 15px 0;">
我们从一个完整的例子开始认识 ng ：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;"><span style="color: gray; padding: 0 5px 0 5px"> 1</span>   <span style="color: #507080">&lt;!DOCTYPE html&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 2</span>   <span style="color: #e0eee0">&lt;html&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 3</span>   <span style="color: #e0eee0">&lt;head&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 4</span>   <span style="color: #e0eee0">&lt;meta</span> <span style="color: #e0eee0">charset=</span><span style="color: #00e5ee">"utf-8"</span> <span style="color: #e0eee0">/&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 5</span>   
<span style="color: gray; padding: 0 5px 0 5px"> 6</span>   <span style="color: #e0eee0">&lt;title&gt;</span>试验<span style="color: #e0eee0">&lt;/title&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 7</span>   
<span style="color: gray; padding: 0 5px 0 5px"> 8</span>   <span style="color: #e0eee0">&lt;script type=</span><span style="color: #00e5ee">"text/javascript"</span> <span style="color: #e0eee0">src=</span><span style="color: #00e5ee">"jquery-1.8.3.js"</span><span style="color: #e0eee0">&gt;&lt;/script&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 9</span>   <span style="color: #e0eee0">&lt;script type=</span><span style="color: #00e5ee">"text/javascript"</span> <span style="color: #e0eee0">src=</span><span style="color: #00e5ee">"angular.js"</span><span style="color: #e0eee0">&gt;&lt;/script&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">10</span>   
<span style="color: gray; padding: 0 5px 0 5px">11</span>   <span style="color: #e0eee0">&lt;/head&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">12</span>   <span style="color: #e0eee0">&lt;body&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">13</span>     <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"BoxCtrl"</span><span style="color: #e0eee0">&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">14</span>       <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">style=</span><span style="color: #00e5ee">"width: 100px; height: 100px; background-color: red;"</span>
<span style="color: gray; padding: 0 5px 0 5px">15</span>            <span style="color: #e0eee0">ng-click=</span><span style="color: #00e5ee">"click()"</span><span style="color: #e0eee0">&gt;&lt;/div&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">16</span>       <span style="color: #e0eee0">&lt;p&gt;</span>{{ w }} x {{ h }}<span style="color: #e0eee0">&lt;/p&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">17</span>       <span style="color: #e0eee0">&lt;p&gt;</span>W: <span style="color: #e0eee0">&lt;input</span> <span style="color: #e0eee0">type=</span><span style="color: #00e5ee">"text"</span> <span style="color: #e0eee0">ng-model=</span><span style="color: #00e5ee">"w"</span> <span style="color: #e0eee0">/&gt;&lt;/p&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">18</span>       <span style="color: #e0eee0">&lt;p&gt;</span>H: <span style="color: #e0eee0">&lt;input</span> <span style="color: #e0eee0">type=</span><span style="color: #00e5ee">"text"</span> <span style="color: #e0eee0">ng-model=</span><span style="color: #00e5ee">"h"</span> <span style="color: #e0eee0">/&gt;&lt;/p&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">19</span>     <span style="color: #e0eee0">&lt;/div&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">20</span>   
<span style="color: gray; padding: 0 5px 0 5px">21</span>   
<span style="color: gray; padding: 0 5px 0 5px">22</span>   <span style="color: #e0eee0">&lt;script type=</span><span style="color: #00e5ee">"text/javascript"</span> <span style="color: #e0eee0">charset=</span><span style="color: #00e5ee">"utf-8"</span><span style="color: #e0eee0">&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">23</span>   
<span style="color: gray; padding: 0 5px 0 5px">24</span>   
<span style="color: gray; padding: 0 5px 0 5px">25</span>   <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">BoxCtrl</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">$element</span>){
<span style="color: gray; padding: 0 5px 0 5px">26</span>   
<span style="color: gray; padding: 0 5px 0 5px">27</span>     <span style="color: #507080">//$element 就是一个 jQuery 对象</span>
<span style="color: gray; padding: 0 5px 0 5px">28</span>     <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">e</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$element</span>.<span style="color: #e0eee0">children</span>().<span style="color: #e0eee0">eq</span>(<span style="color: #00ffff">0</span>);
<span style="color: gray; padding: 0 5px 0 5px">29</span>     <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">w</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">e</span>.<span style="color: #e0eee0">width</span>();
<span style="color: gray; padding: 0 5px 0 5px">30</span>     <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">h</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">e</span>.<span style="color: #e0eee0">height</span>();
<span style="color: gray; padding: 0 5px 0 5px">31</span>   
<span style="color: gray; padding: 0 5px 0 5px">32</span>     <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">click</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(){
<span style="color: gray; padding: 0 5px 0 5px">33</span>       <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">w</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">parseInt</span>(<span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">w</span>) <span style="color: #7fff00">+</span> <span style="color: #00ffff">10</span>;
<span style="color: gray; padding: 0 5px 0 5px">34</span>       <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">h</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">parseInt</span>(<span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">h</span>) <span style="color: #7fff00">+</span> <span style="color: #00ffff">10</span>;
<span style="color: gray; padding: 0 5px 0 5px">35</span>     }
<span style="color: gray; padding: 0 5px 0 5px">36</span>   
<span style="color: gray; padding: 0 5px 0 5px">37</span>     <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">$watch</span>(<span style="color: #00e5ee">'w'</span>,
<span style="color: gray; padding: 0 5px 0 5px">38</span>       <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">to</span>, <span style="color: #e0eee0">from</span>){
<span style="color: gray; padding: 0 5px 0 5px">39</span>         <span style="color: #e0eee0">e</span>.<span style="color: #e0eee0">width</span>(<span style="color: #e0eee0">to</span>);
<span style="color: gray; padding: 0 5px 0 5px">40</span>       }
<span style="color: gray; padding: 0 5px 0 5px">41</span>     );
<span style="color: gray; padding: 0 5px 0 5px">42</span>   
<span style="color: gray; padding: 0 5px 0 5px">43</span>     <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">$watch</span>(<span style="color: #00e5ee">'h'</span>,
<span style="color: gray; padding: 0 5px 0 5px">44</span>       <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">to</span>, <span style="color: #e0eee0">from</span>){
<span style="color: gray; padding: 0 5px 0 5px">45</span>         <span style="color: #e0eee0">e</span>.<span style="color: #e0eee0">height</span>(<span style="color: #e0eee0">to</span>);
<span style="color: gray; padding: 0 5px 0 5px">46</span>       }
<span style="color: gray; padding: 0 5px 0 5px">47</span>     );
<span style="color: gray; padding: 0 5px 0 5px">48</span>   }
<span style="color: gray; padding: 0 5px 0 5px">49</span>   
<span style="color: gray; padding: 0 5px 0 5px">50</span>   <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">bootstrap</span>(<span style="color: #e0eee0">document</span>.<span style="color: #e0eee0">documentElement</span>);
<span style="color: gray; padding: 0 5px 0 5px">51</span>   <span style="color: #e0eee0">&lt;/script&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">52</span>   <span style="color: #e0eee0">&lt;/body&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">53</span>   <span style="color: #e0eee0">&lt;/html&gt;</span>
</pre></div>


<p style="margin: 15px 0;">
从上面的代码中，我们看到在通常的 HTML 代码当中，引入了一些标记，这些就是 ng 的模板机制，它不光完成数据渲染的工作，还实现了数据绑定的功能。
</p>
<p style="margin: 15px 0;">
同时，在 HTML 中的本身的 DOM 层级结构，被 ng 利用起来，直接作为它的内部机制中，上下文结构的判断依据。比如例子中 <i style=" color: #d75100; font-style: normal; ">p</i> 是 <i style=" color: #d75100; font-style: normal; ">div</i> 的子节点，那么 <i style=" color: #d75100; font-style: normal; ">p</i> 中的那些模板标记就是在 <i style=" color: #d75100; font-style: normal; ">div</i> 的 <i style=" color: #d75100; font-style: normal; ">Ctrl</i> 的作用范围之内。
</p>
<p style="margin: 15px 0;">
其它的，也同样写一些 js 代码，里面重要的是作一些数据的操作，事件的绑定定义等。这样，数据的变化就会和页面中的 DOM 
表现联系起来。一旦这种联系建立起来，也即完成了我们所说的“双向绑定”。然后，这里说的“事件”，除了那些“点击”等通常的 DOM 
事件之外，我们还更关注“数据变化”这个事件。
</p>
<p style="margin: 15px 0;">
最后，可以使用：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">angular</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">bootstrap</span>(<span style="color: #e0eee0">document</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">documentElement</span>);
</pre></div>


<p style="margin: 15px 0;">
来把整个页面驱动起来了。（你可以看到一个可被控制大小的红色方块）
</p>
<p style="margin: 15px 0;">
更完整的方法是定义一个 APP ：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;"><span style="color: gray; padding: 0 5px 0 5px"> 1</span>   <span style="color: #507080">&lt;!DOCTYPE html&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 2</span>   <span style="color: #e0eee0">&lt;html</span> <span style="color: #e0eee0">ng-app=</span><span style="color: #00e5ee">"MyApp"</span><span style="color: #e0eee0">&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 3</span>   <span style="color: #e0eee0">&lt;head&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 4</span>   <span style="color: #e0eee0">&lt;meta</span> <span style="color: #e0eee0">charset=</span><span style="color: #00e5ee">"utf-8"</span> <span style="color: #e0eee0">/&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 5</span>   
<span style="color: gray; padding: 0 5px 0 5px"> 6</span>   <span style="color: #e0eee0">&lt;title&gt;</span>数据正向绑定<span style="color: #e0eee0">&lt;/title&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 7</span>   
<span style="color: gray; padding: 0 5px 0 5px"> 8</span>   <span style="color: #e0eee0">&lt;script type=</span><span style="color: #00e5ee">"text/javascript"</span> <span style="color: #e0eee0">src=</span><span style="color: #00e5ee">"jquery-1.8.3.js"</span><span style="color: #e0eee0">&gt;&lt;/script&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 9</span>   <span style="color: #e0eee0">&lt;script type=</span><span style="color: #00e5ee">"text/javascript"</span> <span style="color: #e0eee0">src=</span><span style="color: #00e5ee">"angular.js"</span><span style="color: #e0eee0">&gt;&lt;/script&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">10</span>   
<span style="color: gray; padding: 0 5px 0 5px">11</span>   <span style="color: #e0eee0">&lt;/head&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">12</span>   <span style="color: #e0eee0">&lt;body&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">13</span>   
<span style="color: gray; padding: 0 5px 0 5px">14</span>   <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span><span style="color: #e0eee0">&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">15</span>     <span style="color: #e0eee0">&lt;input</span> <span style="color: #e0eee0">type=</span><span style="color: #00e5ee">"text"</span> <span style="color: #e0eee0">value=</span><span style="color: #00e5ee">""</span> <span style="color: #e0eee0">id=</span><span style="color: #00e5ee">"a"</span> <span style="color: #e0eee0">/&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">16</span>   <span style="color: #e0eee0">&lt;/div&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">17</span>   
<span style="color: gray; padding: 0 5px 0 5px">18</span>   
<span style="color: gray; padding: 0 5px 0 5px">19</span>   <span style="color: #e0eee0">&lt;script type=</span><span style="color: #00e5ee">"text/javascript"</span><span style="color: #e0eee0">&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">20</span>   <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">TestCtrl</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(){
<span style="color: gray; padding: 0 5px 0 5px">21</span>     <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #00e5ee">'ok'</span>);
<span style="color: gray; padding: 0 5px 0 5px">22</span>   }
<span style="color: gray; padding: 0 5px 0 5px">23</span>   
<span style="color: gray; padding: 0 5px 0 5px">24</span>   <span style="color: #507080">//angular.bootstrap(document.documentElement);</span>
<span style="color: gray; padding: 0 5px 0 5px">25</span>   <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'MyApp'</span>, [], <span style="color: #bcd2ee">function</span>(){<span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #00e5ee">'here'</span>)});
<span style="color: gray; padding: 0 5px 0 5px">26</span>   <span style="color: #e0eee0">&lt;/script&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">27</span>   
<span style="color: gray; padding: 0 5px 0 5px">28</span>   <span style="color: #e0eee0">&lt;/body&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">29</span>   <span style="color: #e0eee0">&lt;/html&gt;</span>
</pre></div>


<p style="margin: 15px 0;">
这里说的一个 App 就是 <i style=" color: #d75100; font-style: normal; ">ng</i> 概念中的一个 <i style=" color: #d75100; font-style: normal; ">Module</i> 。对于 <i style=" color: #d75100; font-style: normal; ">Controller</i> 来说， 如果不想使用全局函数，也可以在 app 中定义：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">app</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'MyApp'</span>, [], <span style="color: #bcd2ee">function</span>(){<span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #00e5ee">'here'</span>)});
  <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">controller</span>(<span style="color: #00e5ee">'TestCtrl'</span>,
    <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>){
      <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #00e5ee">'ok'</span>);
    }
  );
</pre></div>


<p style="margin: 15px 0;">
上面我们使用 <i style=" color: #d75100; font-style: normal; ">ng-app</i> 来指明要使用的 App ，这样的话可以把显式的初始化工作省了。一般完整的过程是：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">var</span> <span style="color: #e0eee0">app</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'Demo'</span>, <span style="color: #7fff00">[]</span>, <span style="color: #e0eee0">angular</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">noop</span>);
  <span style="color: #e0eee0">angular</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">bootstrap</span>(<span style="color: #e0eee0">document</span>, [<span style="color: #00e5ee">'Demo'</span>]);
</pre></div>


<p style="margin: 15px 0;">
使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">angular.bootstrap</code> 来显示地做初始化工具，参数指明了根节点，装载的模块（可以是多个模块）。
</p>

<a id="toc4" name="toc4"></a>
<h1 style=" -moz-border-radius: 5px; -webkit-border-radius: 5px; -moz-box-shadow: 3px 3px 5px #333; -webkit-box-shadow: 3px 3px 5px #333; box-shadow: 3px 3px 5px #333;  border-radius: 5px; background-color: #69ab01; padding: 4px; color: white; line-height: 1.3em; text-shadow: 2px 2px 2px black; margin: 20px auto; font-size: medium; clear: both;">4. 依赖注入</h1>

<p style="margin: 15px 0;">
<b style=" color: red; font-weight: normal; ">injector</b> ， 我从 ng 的文档中得知这个概念，之后去翻看源码时了解了一下这个机制的工作原理。感觉就是虽然与自己的所想仅差那么一点点，但就是这么一点点，让我感慨想象力之神奇。
</p>
<p style="margin: 15px 0;">
先看我们之前代码中的一处函数定义：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">var</span> <span style="color: #e0eee0">BoxCtrl</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">function</span>(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">$element</span>){}
</pre></div>


<p style="margin: 15px 0;">
在这个函数定义中，注意那两个参数： <i style=" color: #d75100; font-style: normal; ">$scope</i> ， <i style=" color: #d75100; font-style: normal; ">$element</i> ，这是两个很有意思的东西。总的来说，它们是参数，这没什么可说的。但又不仅仅是参数——你换个名字代码就不能正常运行了。
</p>
<p style="margin: 15px 0;">
事实上，这两个参数，除了完成“参数”的本身任务之外，还作为一种语法糖完成了“依赖声明”的任务。本来这个函数定义，完整的写法应该像 AMD 声明一样，写成：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">var</span> <span style="color: #e0eee0">BoxCtrl</span> <span style="color: #7fff00">=</span> [<span style="color: #00e5ee">'$scope'</span>, <span style="color: #00e5ee">'$element'</span>, <span style="color: #e0eee0">function</span>(<span style="color: #e0eee0">s</span>, <span style="color: #e0eee0">e</span>){}];
</pre></div>


<p style="margin: 15px 0;">
这样就很明显，表示有一个函数，它依赖于两个东西，然后这两个东西会依次作为参数传入。
</p>
<p style="margin: 15px 0;">
简单起见，就写成了一个函数定义原本的样子，然后在定义参数的名字上作文章，来起到依赖声明的作用。
</p>
<p style="margin: 15px 0;">
在处理时，通过函数对象的 <i style=" color: #d75100; font-style: normal; ">toString()</i> 方法可以知道这个函数定义代码的字符串表现形式，然后就知道它的参数是 <i style=" color: #d75100; font-style: normal; ">$scope</i> 和 <i style=" color: #d75100; font-style: normal; ">$element</i> 。通过名字判断出这是两个外部依赖，然后就去获取资源，最后把资源作为参数，调用定义的函数。
</p>
<p style="margin: 15px 0;">
所以，参数的名字是不能随便写的，这里也充分利用了 js 的特点来尽量做到“反省”了。
</p>
<p style="margin: 15px 0;">
在 Python 中受限于函数名的命名规则，写出来不太好看。不过也得利于反省机制，做到这点也很容易：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #507080"># -*- coding: utf-8 -*-</span>
  
  <span style="color: #90ee90">def</span> <span style="color: #9bcd9b">f</span>(<span style="color: #e0eee0">Ia</span>, <span style="color: #e0eee0">Ib</span>):
      <span style="color: #90ee90">print</span> <span style="color: #e0eee0">Ia</span>, <span style="color: #e0eee0">Ib</span>
  
  <span style="color: #e0eee0">args</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">f</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">func_code</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">co_varnames</span>
  <span style="color: #e0eee0">SRV_MAP</span> <span style="color: #7fff00">=</span> {
      <span style="color: #00e5ee">'Ia'</span>: <span style="color: #00e5ee">'123'</span>,
      <span style="color: #00e5ee">'Ib'</span>: <span style="color: #00e5ee">'456'</span>,
  }
  
  <span style="color: #e0eee0">srv</span> <span style="color: #7fff00">=</span> {}
  <span style="color: #90ee90">for</span> <span style="color: #e0eee0">a</span> <span style="color: #7fff00">in</span> <span style="color: #e0eee0">args</span>:
      <span style="color: #90ee90">if</span> <span style="color: #e0eee0">a</span> <span style="color: #7fff00">in</span> <span style="color: #e0eee0">SRV_MAP</span>:
          <span style="color: #e0eee0">srv</span>[<span style="color: #e0eee0">a</span>] <span style="color: #7fff00">=</span> <span style="color: #e0eee0">SRV_MAP</span>[<span style="color: #e0eee0">a</span>]
  <span style="color: #e0eee0">f</span>(<span style="color: #7fff00">**</span><span style="color: #e0eee0">srv</span>)
</pre></div>


<a id="toc5" name="toc5"></a>
<h1 style=" -moz-border-radius: 5px; -webkit-border-radius: 5px; -moz-box-shadow: 3px 3px 5px #333; -webkit-box-shadow: 3px 3px 5px #333; box-shadow: 3px 3px 5px #333;  border-radius: 5px; background-color: #69ab01; padding: 4px; color: white; line-height: 1.3em; text-shadow: 2px 2px 2px black; margin: 20px auto; font-size: medium; clear: both;">5. 作用域</h1>

<p style="margin: 15px 0;">
这里提到的“作用域”的概念，是一个在范围上与 DOM 结构一致，数据上相对于某个 <i style=" color: #d75100; font-style: normal; ">$scope</i> 对象的属性的概念。我们还是从 HTML 代码上来入手：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"BoxCtrl"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">style=</span><span style="color: #00e5ee">"width: 100px; height: 100px; background-color: red;"</span>
         <span style="color: #e0eee0">ng-click=</span><span style="color: #00e5ee">"click()"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;/div&gt;</span>
    <span style="color: #e0eee0">&lt;p&gt;</span>{{ w }} x {{ h }}<span style="color: #e0eee0">&lt;/p&gt;</span>
    <span style="color: #e0eee0">&lt;p&gt;</span>W: <span style="color: #e0eee0">&lt;input</span> <span style="color: #e0eee0">type=</span><span style="color: #00e5ee">"text"</span> <span style="color: #e0eee0">ng-model=</span><span style="color: #00e5ee">"w"</span> <span style="color: #e0eee0">/&gt;&lt;/p&gt;</span>
    <span style="color: #e0eee0">&lt;p&gt;</span>H: <span style="color: #e0eee0">&lt;input</span> <span style="color: #e0eee0">type=</span><span style="color: #00e5ee">"text"</span> <span style="color: #e0eee0">ng-model=</span><span style="color: #00e5ee">"h"</span> <span style="color: #e0eee0">/&gt;&lt;/p&gt;</span>
  <span style="color: #e0eee0">&lt;/div&gt;</span>
</pre></div>


<p style="margin: 15px 0;">
上面的代码中，我们给一个 <i style=" color: #d75100; font-style: normal; ">div</i> 元素指定了一个 <i style=" color: #d75100; font-style: normal; ">BoxCtrl</i> ，那么， <i style=" color: #d75100; font-style: normal; ">div</i> 元素之内，就是 <i style=" color: #d75100; font-style: normal; ">BoxCtrl</i> 这个函数运行时， <i style=" color: #d75100; font-style: normal; ">$scope</i> 这个注入资源的控制范围。在代码中我们看到的 <i style=" color: #d75100; font-style: normal; ">click()</i> ， <i style=" color: #d75100; font-style: normal; ">w</i> ， <i style=" color: #d75100; font-style: normal; ">h</i> 这些东西，它们本来的位置对应于 <i style=" color: #d75100; font-style: normal; ">$scope.click</i> ， <i style=" color: #d75100; font-style: normal; ">$scope.w</i> ， <i style=" color: #d75100; font-style: normal; ">$scope.h</i> 。
</p>
<p style="margin: 15px 0;">
我们在后面的 js 代码中，也可以看到我们就是在操作这些变量。依赖于 ng 的数据绑定机制，操作变量的结果直接在页面上表现出来了。
</p>

<a id="toc6" name="toc6"></a>
<h1 style=" -moz-border-radius: 5px; -webkit-border-radius: 5px; -moz-box-shadow: 3px 3px 5px #333; -webkit-box-shadow: 3px 3px 5px #333; box-shadow: 3px 3px 5px #333;  border-radius: 5px; background-color: #69ab01; padding: 4px; color: white; line-height: 1.3em; text-shadow: 2px 2px 2px black; margin: 20px auto; font-size: medium; clear: both;">6. 数据绑定与模板</h1>

<p style="margin: 15px 0;">
我纠结了半天，“数据绑定”与“模板”这两个东西还真没办法分开来说。因为数据绑定需要以模板为载体，离开了模板，数据还绑个毛啊。
</p>
<p style="margin: 15px 0;">
ng 的一大特点，就是数据双向绑定。双向绑定是一体，为了描述方便，下面分别介绍。
</p>

<a id="toc7" name="toc7"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">6.1. 数据-&gt;模板</h2>

<p style="margin: 15px 0;">
数据到表现的绑定，主要是使用模板标记直接完成的：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;p&gt;</span>{{ w }} x {{ h }}<span style="color: #e0eee0">&lt;/p&gt;</span>
</pre></div>


<p style="margin: 15px 0;">
使用 <i style=" color: #d75100; font-style: normal; ">{{ }}</i> 这个标记，就可以直接引用，并绑定一个作用域内的变量。在实现上， ng 自动创建了一个 <i style=" color: #d75100; font-style: normal; ">watcher</i> 。效果就是，不管因为什么，如果作用域的变量发生了改变，我们随时可以让相应的页面表现也随之改变。我们可以看一个更纯粹的例子：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;p</span> <span style="color: #e0eee0">id=</span><span style="color: #00e5ee">"test"</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span><span style="color: #e0eee0">&gt;</span>{{ a }}<span style="color: #e0eee0">&lt;/p&gt;</span>
  
  <span style="color: #e0eee0">&lt;script type=</span><span style="color: #00e5ee">"text/javascript"</span><span style="color: #e0eee0">&gt;</span>
  var TestCtrl = function($scope){
    $scope.a = '123';
  }
  angular.bootstrap(document.documentElement);
</pre></div>


<p style="margin: 15px 0;">
上面的例子在页面载入之后，我们可以在页面上看到 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">123</code> 。这时，我们可以打开一个终端控制器，输入：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">$(</span><span style="color: #00e5ee">'#test'</span>)<span style="color: #7fff00">.</span><span style="color: #e0eee0">scope</span>()<span style="color: #7fff00">.</span><span style="color: #e0eee0">a</span> <span style="color: #7fff00">=</span> <span style="color: #00e5ee">'12345'</span>;
  <span style="color: #e0eee0">$(</span><span style="color: #00e5ee">'#test'</span>)<span style="color: #7fff00">.</span><span style="color: #e0eee0">scope</span>()<span style="color: #7fff00">.</span><span style="color: #e0eee0">$digest</span>();
</pre></div>


<p style="margin: 15px 0;">
上面的代码执行之后，就可以看到页面变化了。
</p>
<p style="margin: 15px 0;">
对于使用 ng 进行的事件绑定，在处理函数中就不需要去关心 <i style=" color: #d75100; font-style: normal; ">$digest()</i> 的调用了。因为 ng 会自己处理。源码中，对于 ng 的事件绑定，真正的处理函数不是指定名字的函数，而是经过 <i style=" color: #d75100; font-style: normal; ">$apply()</i> 包装过的一个函数。这个 <i style=" color: #d75100; font-style: normal; ">$apply()</i> 做的一件事，就是调用根作用域 <i style=" color: #d75100; font-style: normal; ">$rootScope</i> 的 <i style=" color: #d75100; font-style: normal; ">$digest()</i> ，这样整个世界就清净了：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;p</span> <span style="color: #e0eee0">id=</span><span style="color: #00e5ee">"test"</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span> <span style="color: #e0eee0">ng-click=</span><span style="color: #00e5ee">"click()"</span><span style="color: #e0eee0">&gt;</span>{{ a }}<span style="color: #e0eee0">&lt;/p&gt;</span>
  
  <span style="color: #e0eee0">&lt;script type=</span><span style="color: #00e5ee">"text/javascript"</span> <span style="color: #e0eee0">charset=</span><span style="color: #00e5ee">"utf-8"</span><span style="color: #e0eee0">&gt;</span>
  var TestCtrl = function($scope){
    $scope.a = '123';
  
    $scope.click = function(){
      $scope.a = '456';
    }
  }
  angular.bootstrap(document.documentElement);
</pre></div>


<p style="margin: 15px 0;">
那个 <i style=" color: #d75100; font-style: normal; ">click</i> 函数的定义，绑定时变成了类似于：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">function</span>(){
    <span style="color: #e0eee0">$scope</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">$apply</span>(
      <span style="color: #e0eee0">function</span>(){
        <span style="color: #e0eee0">$scope</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">click</span>();
      }
    )
  }
</pre></div>


<p style="margin: 15px 0;">
这里的 <i style=" color: #d75100; font-style: normal; ">$scope.$apply()</i> 中做的一件事：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">$rootScope</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">$digest</span>();
</pre></div>


<a id="toc8" name="toc8"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">6.2. 模板-&gt;数据</h2>

<p style="margin: 15px 0;">
模板到数据的绑定，主要是通过 <i style=" color: #d75100; font-style: normal; ">ng-model</i> 来完成的：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #7fff00">&lt;</span><span style="color: #e0eee0">input</span> <span style="color: #e0eee0">type</span><span style="color: #7fff00">=</span><span style="color: #00e5ee">"text"</span> <span style="color: #e0eee0">id</span><span style="color: #7fff00">=</span><span style="color: #00e5ee">"test"</span> <span style="color: #e0eee0">ng</span><span style="color: #7fff00">-</span><span style="color: #e0eee0">controller</span><span style="color: #7fff00">=</span><span style="color: #00e5ee">"TestCtrl"</span> <span style="color: #e0eee0">ng</span><span style="color: #7fff00">-</span><span style="color: #e0eee0">model</span><span style="color: #7fff00">=</span><span style="color: #00e5ee">"a"</span> <span style="color: #7fff00">/&gt;</span>
  
  <span style="color: #7fff00">&lt;</span><span style="color: #e0eee0">script</span> <span style="color: #e0eee0">type</span><span style="color: #7fff00">=</span><span style="color: #00e5ee">"text/javascript"</span> <span style="color: #e0eee0">charset</span><span style="color: #7fff00">=</span><span style="color: #00e5ee">"utf-8"</span><span style="color: #7fff00">&gt;</span>
  <span style="color: #e0eee0">var</span> <span style="color: #e0eee0">TestCtrl</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">function</span>(<span style="color: #e0eee0">$scope</span>){
    <span style="color: #e0eee0">$scope</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">a</span> <span style="color: #7fff00">=</span> <span style="color: #00e5ee">'123'</span>;
  }
</pre></div>


<p style="margin: 15px 0;">
这时修改 <i style=" color: #d75100; font-style: normal; ">input</i> 中的值，然后再在控制终端中使用：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">$(</span><span style="color: #00e5ee">'#test'</span>)<span style="color: #7fff00">.</span><span style="color: #e0eee0">scope</span>()<span style="color: #7fff00">.</span><span style="color: #e0eee0">a</span>
</pre></div>


<p style="margin: 15px 0;">
查看，发现变量 <i style=" color: #d75100; font-style: normal; ">a</i> 的值已经更改了。
</p>
<p style="margin: 15px 0;">
实际上， <i style=" color: #d75100; font-style: normal; ">ng-model</i> 是把两个方向的绑定都做了。它不光显示出变量的值，也把显示上的数值变化反映给了变量。这个在实现上就简单多了，只是绑定 <i style=" color: #d75100; font-style: normal; ">change</i> 事件，然后做一些赋值操作即可。不过 ng 里，还要区分对待不同的控件。
</p>

<a id="toc9" name="toc9"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">6.3. 数据-&gt;模板-&gt;数据-&gt;模板</h2>

<p style="margin: 15px 0;">
现在要考虑的是一种在现实中很普遍的一个需求。比如就是我们可以输入数值，来控制一个矩形的长度。在这里，数据与表现的关系是：
</p>

<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li>长度数值保存在变量中
</li>
<li>变量显示于某个 input 中
</li>
<li>变量的值即是矩形的长度
</li>
<li>input 中的值变化时，变量也要变化
</li>
<li>input 中的值变化时，矩形的长度也要变化
</li>
</ul>

<p style="margin: 15px 0;">
当然，要实现目的在这里可能就不止一种方案了。按照以前的做法，很自然地会想法，绑定 <i style=" color: #d75100; font-style: normal; ">input</i> 的 <i style=" color: #d75100; font-style: normal; ">change</i> 事件，然后去做一些事就好了。但是，我们前面提到过 <i style=" color: #d75100; font-style: normal; ">ng-model</i> 这个东西，利用它就可以在不手工处理 <i style=" color: #d75100; font-style: normal; ">change</i> 的条件下完成数据的展现需求，在此基础之上，我们还需要做的一点，就是把变化后的数据应用到矩形的长度之上。
</p>
<p style="margin: 15px 0;">
最开始，我们面对的应该是这样一个东西：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">style=</span><span style="color: #00e5ee">"width: 100px; height: 10px; background-color: red"</span><span style="color: #e0eee0">&gt;&lt;/div&gt;</span>
    <span style="color: #e0eee0">&lt;input</span> <span style="color: #e0eee0">type=</span><span style="color: #00e5ee">"text"</span> <span style="color: #e0eee0">name=</span><span style="color: #00e5ee">"width"</span> <span style="color: #e0eee0">ng-model=</span><span style="color: #00e5ee">"width"</span> <span style="color: #e0eee0">/&gt;</span>
  <span style="color: #e0eee0">&lt;/div&gt;</span>
  
  <span style="color: #e0eee0">&lt;script type=</span><span style="color: #00e5ee">"text/javascript"</span> <span style="color: #e0eee0">charset=</span><span style="color: #00e5ee">"utf-8"</span><span style="color: #e0eee0">&gt;</span>
  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">TestCtrl</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>){
    <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">width</span> <span style="color: #7fff00">=</span> <span style="color: #00ffff">100</span>;
  }
  <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">bootstrap</span>(<span style="color: #e0eee0">document</span>.<span style="color: #e0eee0">documentElement</span>);
  <span style="color: #e0eee0">&lt;/script&gt;</span>
</pre></div>


<p style="margin: 15px 0;">
我们从响应数据变化，但又不使用 <i style=" color: #d75100; font-style: normal; ">change</i> 事件的角度来看，可以这样处理宽度变化：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">TestCtrl</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">$element</span>){
    <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">width</span> <span style="color: #7fff00">=</span> <span style="color: #00ffff">100</span>;
    <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">$watch</span>(<span style="color: #00e5ee">'width'</span>,
      <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">to</span>, <span style="color: #e0eee0">from</span>){
        <span style="color: #e0eee0">$element</span>.<span style="color: #e0eee0">children</span>(<span style="color: #00e5ee">':first'</span>).<span style="color: #e0eee0">width</span>(<span style="color: #e0eee0">to</span>);
      }
    );
  }
</pre></div>


<p style="margin: 15px 0;">
使用 <i style=" color: #d75100; font-style: normal; ">$watch()</i> 来绑定数据变化。
</p>
<p style="margin: 15px 0;">
当然，这种样式的问题，有更直接有效的手段， ng 的数据绑定总是让人惊异：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">style=</span><span style="color: #00e5ee">"width: 10px; height: 10px; background-color: red"</span> <span style="color: #e0eee0">ng-style=</span><span style="color: #00e5ee">"style"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;/div&gt;</span>
    <span style="color: #e0eee0">&lt;input</span> <span style="color: #e0eee0">type=</span><span style="color: #00e5ee">"text"</span> <span style="color: #e0eee0">name=</span><span style="color: #00e5ee">"width"</span> <span style="color: #e0eee0">ng-model=</span><span style="color: #00e5ee">"style.width"</span> <span style="color: #e0eee0">/&gt;</span>
  <span style="color: #e0eee0">&lt;/div&gt;</span>
  
  
  <span style="color: #e0eee0">&lt;script type=</span><span style="color: #00e5ee">"text/javascript"</span> <span style="color: #e0eee0">charset=</span><span style="color: #00e5ee">"utf-8"</span><span style="color: #e0eee0">&gt;</span>
  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">TestCtrl</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>){
    <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">style</span> <span style="color: #7fff00">=</span> {<span style="color: #e0eee0">width</span><span style="color: #7fff00">:</span> <span style="color: #00ffff">100</span>};
  }
  <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">bootstrap</span>(<span style="color: #e0eee0">document</span>.<span style="color: #e0eee0">documentElement</span>);
  <span style="color: #e0eee0">&lt;/script&gt;</span>
</pre></div>


<a id="toc10" name="toc10"></a>
<h1 style=" -moz-border-radius: 5px; -webkit-border-radius: 5px; -moz-box-shadow: 3px 3px 5px #333; -webkit-box-shadow: 3px 3px 5px #333; box-shadow: 3px 3px 5px #333;  border-radius: 5px; background-color: #69ab01; padding: 4px; color: white; line-height: 1.3em; text-shadow: 2px 2px 2px black; margin: 20px auto; font-size: medium; clear: both;">7. 模板</h1>

<p style="margin: 15px 0;">
前面讲了数据绑定之后，现在可以单独讲讲模板了。
</p>
<p style="margin: 15px 0;">
作为一套能称之谓“模板”的系统，除了能干一些模板的常规的事之外（好吧，即使是常规的逻辑判断现在它也做不了的），配合作用域 <i style=" color: #d75100; font-style: normal; ">$scope</i> 和 ng 的数据双向绑定机制， ng 的模板系统就变得比较神奇了。
</p>

<a id="toc11" name="toc11"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">7.1. 定义模板内容</h2>

<p style="margin: 15px 0;">
定义模板的内容现在有三种方式：
</p>

<ol style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li>在需要的地方直接写字符串
</li>
<li>外部文件
</li>
<li>使用 <i style=" color: #d75100; font-style: normal; ">script</i> 标签定义的“内部文件”
</li>
</ol>

<p style="margin: 15px 0;">
第一种不需要多说。第二种和第三种都可以和 <i style=" color: #d75100; font-style: normal; ">ng-include</i> 一起工作，来引入一段模板。
</p>
<p style="margin: 15px 0;">
直接引入同域的外部文件作为模板的一部分：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;div</span> ng-include <span style="color: #e0eee0">src=</span><span style="color: #00e5ee">"'tpl.html'"</span><span style="color: #e0eee0">&gt;</span>
  <span style="color: #e0eee0">&lt;/div&gt;</span>
  
  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-include=</span><span style="color: #00e5ee">"'tpl.html'"</span><span style="color: #e0eee0">&gt;</span>
  <span style="color: #e0eee0">&lt;/div&gt;</span>
</pre></div>


<p style="margin: 15px 0;">
注意， <i style=" color: #d75100; font-style: normal; ">src</i> 中的字符串会作为表达式处理（可以是 <i style=" color: #d75100; font-style: normal; ">$scope</i> 中的变量），所以，直接写名字的话需要使用引号。
</p>
<p style="margin: 15px 0;">
引入 <i style=" color: #d75100; font-style: normal; ">script</i> 定义的“内部文件”：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;script</span> <span style="color: #e0eee0">type=</span><span style="color: #00e5ee">"text/ng-template"</span> <span style="color: #e0eee0">id=</span><span style="color: #00e5ee">"tpl"</span><span style="color: #e0eee0">&gt;</span>
  here, {{ 1 + 1 }}
  <span style="color: #e0eee0">&lt;/script&gt;</span>
  
  <span style="color: #e0eee0">&lt;div</span> ng-include <span style="color: #e0eee0">src=</span><span style="color: #00e5ee">"'tpl'"</span><span style="color: #e0eee0">&gt;&lt;/div&gt;</span>
  
</pre></div>


<p style="margin: 15px 0;">
配合变量使用：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;script</span> <span style="color: #e0eee0">type=</span><span style="color: #00e5ee">"text/ng-template"</span> <span style="color: #e0eee0">id=</span><span style="color: #00e5ee">"tpl"</span><span style="color: #e0eee0">&gt;</span>
  here, {{ 1 + 1 }}
  <span style="color: #e0eee0">&lt;/script&gt;</span>
  
  <span style="color: #e0eee0">&lt;a</span> <span style="color: #e0eee0">ng-click=</span><span style="color: #00e5ee">"v='tpl'"</span><span style="color: #e0eee0">&gt;</span>Load<span style="color: #e0eee0">&lt;/a&gt;</span>
  <span style="color: #e0eee0">&lt;div</span> ng-include <span style="color: #e0eee0">src=</span><span style="color: #00e5ee">"v"</span><span style="color: #e0eee0">&gt;&lt;/div&gt;</span>
</pre></div>


<a id="toc12" name="toc12"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">7.2. 内容渲染控制</h2>

<a id="toc13" name="toc13"></a>
<h3 style=" font-size: small; margin: 0 auto; text-shadow: 1px 1px 1px gray; padding: 2px; color: #555;">7.2.1. 重复 ng-repeat</h3>

<p style="margin: 15px 0;">
这算是唯一的一个控制标签么……，它的使用方法类型于：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;ul</span> <span style="color: #e0eee0">ng-repeat=</span><span style="color: #00e5ee">"member in obj_list"</span><span style="color: #e0eee0">&gt;</span>
      <span style="color: #e0eee0">&lt;li&gt;</span>{{ member }}<span style="color: #e0eee0">&lt;/li&gt;</span>
    <span style="color: #e0eee0">&lt;/ul&gt;</span>
  <span style="color: #e0eee0">&lt;/div&gt;</span>
  
  
  var TestCtrl = function($scope){
    $scope.obj_list = [1,2,3,4];
  }
</pre></div>


<p style="margin: 15px 0;">
除此之外，它还提供了几个变量可供使用：
</p>

<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li><i style=" color: #d75100; font-style: normal; ">$index</i> 当前索引
</li>
<li><i style=" color: #d75100; font-style: normal; ">$first</i> 是否为头元素
</li>
<li><i style=" color: #d75100; font-style: normal; ">$middle</i> 是否为非头非尾元素
</li>
<li><i style=" color: #d75100; font-style: normal; ">$last</i> 是否为尾元素
</li>
</ul>


<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;ul</span> <span style="color: #e0eee0">ng-repeat=</span><span style="color: #00e5ee">"member in obj_list"</span><span style="color: #e0eee0">&gt;</span>
      <span style="color: #e0eee0">&lt;li&gt;</span>{{ $index }}, {{ member.name }}<span style="color: #e0eee0">&lt;/li&gt;</span>
    <span style="color: #e0eee0">&lt;/ul&gt;</span>
  <span style="color: #e0eee0">&lt;/div&gt;</span>
  
  var TestCtrl = function($scope){
    $scope.obj_list = [{name: 'A'}, {name: 'B'}, {name: 'C'}];
  }
</pre></div>


<a id="toc14" name="toc14"></a>
<h3 style=" font-size: small; margin: 0 auto; text-shadow: 1px 1px 1px gray; padding: 2px; color: #555;">7.2.2. 赋值 ng-init</h3>

<p style="margin: 15px 0;">
这个指令可以在模板中直接赋值，它作用于 <i style=" color: #d75100; font-style: normal; ">angular.bootstrap</i> 之前，并且，定义的变量与 <i style=" color: #d75100; font-style: normal; ">$scope</i> 作用域无关。
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span> <span style="color: #e0eee0">ng-init=</span><span style="color: #00e5ee">"a=[1,2,3,4];"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;ul</span> <span style="color: #e0eee0">ng-repeat=</span><span style="color: #00e5ee">"member in a"</span><span style="color: #e0eee0">&gt;</span>
      <span style="color: #e0eee0">&lt;li&gt;</span>{{ member }}<span style="color: #e0eee0">&lt;/li&gt;</span>
    <span style="color: #e0eee0">&lt;/ul&gt;</span>
  <span style="color: #e0eee0">&lt;/div&gt;</span>
</pre></div>


<a id="toc15" name="toc15"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">7.3. 节点控制</h2>

<a id="toc16" name="toc16"></a>
<h3 style=" font-size: small; margin: 0 auto; text-shadow: 1px 1px 1px gray; padding: 2px; color: #555;">7.3.1. 样式 ng-style</h3>

<p style="margin: 15px 0;">
可以使用一个结构直接表示当前节点的样式：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-style=</span><span style="color: #00e5ee">"{width: 100, height: 100, backgroundColor: 'red'}"</span><span style="color: #e0eee0">&gt;</span>
  <span style="color: #e0eee0">&lt;/div&gt;</span>
</pre></div>


<p style="margin: 15px 0;">
同样地，绑定一个变量的话，威力大了。
</p>

<a id="toc17" name="toc17"></a>
<h3 style=" font-size: small; margin: 0 auto; text-shadow: 1px 1px 1px gray; padding: 2px; color: #555;">7.3.2. 类 ng-class</h3>

<p style="margin: 15px 0;">
就是直接地设置当前节点的类，同样，配合数据绑定作用就大了：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span> <span style="color: #e0eee0">ng-class=</span><span style="color: #00e5ee">"cls"</span><span style="color: #e0eee0">&gt;</span>
  <span style="color: #e0eee0">&lt;/div&gt;</span>
</pre></div>


<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">ng-class-even</i> 和 <i style=" color: #d75100; font-style: normal; ">ng-class-odd</i> 是和 <i style=" color: #d75100; font-style: normal; ">ng-repeat</i> 配合使用的：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;ul</span> <span style="color: #e0eee0">ng-init=</span><span style="color: #00e5ee">"l=[1,2,3,4]"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;li</span> <span style="color: #e0eee0">ng-class-odd=</span><span style="color: #00e5ee">"'odd'"</span> <span style="color: #e0eee0">ng-class-even=</span><span style="color: #00e5ee">"'even'"</span> <span style="color: #e0eee0">ng-repeat=</span><span style="color: #00e5ee">"m in l"</span><span style="color: #e0eee0">&gt;</span>{{ m }}<span style="color: #e0eee0">&lt;/li&gt;</span>
  <span style="color: #e0eee0">&lt;/ul&gt;</span>
</pre></div>


<p style="margin: 15px 0;">
注意里面给的还是表示式，别少了引号。
</p>

<a id="toc18" name="toc18"></a>
<h3 style=" font-size: small; margin: 0 auto; text-shadow: 1px 1px 1px gray; padding: 2px; color: #555;">7.3.3. 显示和隐藏 ng-show ng-hide ng-switch</h3>

<p style="margin: 15px 0;">
前两个是控制 <i style=" color: #d75100; font-style: normal; ">display</i> 的指令：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-show=</span><span style="color: #00e5ee">"true"</span><span style="color: #e0eee0">&gt;</span>1<span style="color: #e0eee0">&lt;/div&gt;</span>
  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-show=</span><span style="color: #00e5ee">"false"</span><span style="color: #e0eee0">&gt;</span>2<span style="color: #e0eee0">&lt;/div&gt;</span>
  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-hide=</span><span style="color: #00e5ee">"true"</span><span style="color: #e0eee0">&gt;</span>3<span style="color: #e0eee0">&lt;/div&gt;</span>
  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-hide=</span><span style="color: #00e5ee">"false"</span><span style="color: #e0eee0">&gt;</span>4<span style="color: #e0eee0">&lt;/div&gt;</span>
</pre></div>


<p style="margin: 15px 0;">
后一个 <i style=" color: #d75100; font-style: normal; ">ng-switch</i> 是根据一个值来决定哪个节点显示，其它节点移除：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-init=</span><span style="color: #00e5ee">"a=2"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;ul</span> <span style="color: #e0eee0">ng-switch</span> <span style="color: #e0eee0">on=</span><span style="color: #00e5ee">"a"</span><span style="color: #e0eee0">&gt;</span>
      <span style="color: #e0eee0">&lt;li</span> <span style="color: #e0eee0">ng-switch-when=</span><span style="color: #00e5ee">"1"</span><span style="color: #e0eee0">&gt;</span>1<span style="color: #e0eee0">&lt;/li&gt;</span>
      <span style="color: #e0eee0">&lt;li</span> <span style="color: #e0eee0">ng-switch-when=</span><span style="color: #00e5ee">"2"</span><span style="color: #e0eee0">&gt;</span>2<span style="color: #e0eee0">&lt;/li&gt;</span>
      <span style="color: #e0eee0">&lt;li</span> <span style="color: #e0eee0">ng-switch-default&gt;</span>other<span style="color: #e0eee0">&lt;/li&gt;</span>
    <span style="color: #e0eee0">&lt;/ul&gt;</span>
  <span style="color: #e0eee0">&lt;/div&gt;</span>
</pre></div>


<a id="toc19" name="toc19"></a>
<h3 style=" font-size: small; margin: 0 auto; text-shadow: 1px 1px 1px gray; padding: 2px; color: #555;">7.3.4. 其它属性控制</h3>

<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">ng-src</i> 控制 <i style=" color: #d75100; font-style: normal; ">src</i> 属性：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #7fff00">&lt;</span><span style="color: #e0eee0">img</span> <span style="color: #e0eee0">ng</span><span style="color: #7fff00">-</span><span style="color: #e0eee0">src</span><span style="color: #7fff00">=</span><span style="color: #00e5ee">"{{ 'h' + 'ead.png' }}"</span> <span style="color: #7fff00">/&gt;</span>
</pre></div>


<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">ng-href</i> 控制 <i style=" color: #d75100; font-style: normal; ">href</i> 属性：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;a</span> <span style="color: #e0eee0">ng-href=</span><span style="color: #00e5ee">"{{ '#' + '123' }}"</span><span style="color: #e0eee0">&gt;</span>here<span style="color: #e0eee0">&lt;/a&gt;</span>
</pre></div>


<p style="margin: 15px 0;">
总的来说：
</p>

<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li><i style=" color: #d75100; font-style: normal; ">ng-src</i> src属性
</li>
<li><i style=" color: #d75100; font-style: normal; ">ng-href</i> href属性
</li>
<li><i style=" color: #d75100; font-style: normal; ">ng-checked</i> 选中状态
</li>
<li><i style=" color: #d75100; font-style: normal; ">ng-selected</i> 被选择状态
</li>
<li><i style=" color: #d75100; font-style: normal; ">ng-disabled</i> 禁用状态
</li>
<li><i style=" color: #d75100; font-style: normal; ">ng-multiple</i> 多选状态
</li>
<li><i style=" color: #d75100; font-style: normal; ">ng-readonly</i> 只读状态
</li>
</ul>

<p style="margin: 15px 0;">
<b style=" color: red; font-weight: normal; ">注意：</b> 上面的这些只是单向绑定，即只是从数据到展示，不能反作用于数据。要双向绑定，还是要使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">ng-model</code> 。
</p>

<a id="toc20" name="toc20"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">7.4. 事件绑定</h2>

<p style="margin: 15px 0;">
事件绑定是模板指令中很好用的一部分。我们可以把相关事件的处理函数直接写在 DOM 中，这样做的最大好处就是可以从 DOM 结构上看出业务处理的形式，你知道当你点击这个节点时哪个函数被执行了。
</p>

<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li><i style=" color: #d75100; font-style: normal; ">ng-change</i>
</li>
<li><i style=" color: #d75100; font-style: normal; ">ng-click</i>
</li>
<li><i style=" color: #d75100; font-style: normal; ">ng-dblclick</i>
</li>
<li><i style=" color: #d75100; font-style: normal; ">ng-mousedown</i>
</li>
<li><i style=" color: #d75100; font-style: normal; ">ng-mouseenter</i>
</li>
<li><i style=" color: #d75100; font-style: normal; ">ng-mouseleave</i>
</li>
<li><i style=" color: #d75100; font-style: normal; ">ng-mousemove</i>
</li>
<li><i style=" color: #d75100; font-style: normal; ">ng-mouseover</i>
</li>
<li><i style=" color: #d75100; font-style: normal; ">ng-mouseup</i>
</li>
<li><i style=" color: #d75100; font-style: normal; ">ng-submit</i>
</li>
</ul>

<p style="margin: 15px 0;">
对于事件对象本身，在函数调用时可以直接使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">$event</code> 进行传递：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;p</span> <span style="color: #e0eee0">ng-click=</span><span style="color: #00e5ee">"click($event)"</span><span style="color: #e0eee0">&gt;</span>点击<span style="color: #e0eee0">&lt;/p&gt;</span>
  <span style="color: #e0eee0">&lt;p</span> <span style="color: #e0eee0">ng-click=</span><span style="color: #00e5ee">"click($event.target)"</span><span style="color: #e0eee0">&gt;</span>点击<span style="color: #e0eee0">&lt;/p&gt;</span>
</pre></div>


<a id="toc21" name="toc21"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">7.5. 表单控件</h2>

<p style="margin: 15px 0;">
表单控件类的模板指令，最大的作用是它预定义了需要绑定的数据的格式。这样，就可以对于既定的数据进行既定的处理。
</p>

<a id="toc22" name="toc22"></a>
<h3 style=" font-size: small; margin: 0 auto; text-shadow: 1px 1px 1px gray; padding: 2px; color: #555;">7.5.1. form</h3>

<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">form</i> 是核心的一个控件。 ng 对 <i style=" color: #d75100; font-style: normal; ">form</i> 这个标签作了包装。事实上， ng 自己的指令是叫 <i style=" color: #d75100; font-style: normal; ">ng-form</i> 的，区别在于， <i style=" color: #d75100; font-style: normal; ">form</i> 标签不能嵌套，而使用 <i style=" color: #d75100; font-style: normal; ">ng-form</i> 指令就可以做嵌套的表单了。
</p>
<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">form</i> 的行为中依赖它里面的各个输入控制的状态的，在这里，我们主要关心的是 <i style=" color: #d75100; font-style: normal; ">form</i> 自己的一些方法和属性。从 ng 的角度来说， <i style=" color: #d75100; font-style: normal; ">form</i> 标签，是一个模板指令，也创建了一个 <i style=" color: #d75100; font-style: normal; ">FormController</i> 的实例。这个实例就提供了相应的属性和方法。同时，它里面的控件也是一个 <i style=" color: #d75100; font-style: normal; ">NgModelController</i> 实例。
</p>
<p style="margin: 15px 0;">
很重要的一点， <i style=" color: #d75100; font-style: normal; ">form</i> 的相关方法要生效，必须为 <i style=" color: #d75100; font-style: normal; ">form</i> 标签指定 <i style=" color: #d75100; font-style: normal; ">name</i> 和 <i style=" color: #d75100; font-style: normal; ">ng-controller</i> ，并且每个控件都要绑定一个变量。 <i style=" color: #d75100; font-style: normal; ">form</i> 和控件的名字，即是 <i style=" color: #d75100; font-style: normal; ">$scope</i> 中的相关实例的引用变量名。
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;form</span> <span style="color: #e0eee0">name=</span><span style="color: #00e5ee">"test_form"</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;input</span> <span style="color: #e0eee0">type=</span><span style="color: #00e5ee">"text"</span> <span style="color: #e0eee0">name=</span><span style="color: #00e5ee">"a"</span> <span style="color: #e0eee0">required</span> <span style="color: #e0eee0">ng-model=</span><span style="color: #00e5ee">"a"</span>  <span style="color: #e0eee0">/&gt;</span>
    <span style="color: #e0eee0">&lt;span</span> <span style="color: #e0eee0">ng-click=</span><span style="color: #00e5ee">"see()"</span><span style="color: #e0eee0">&gt;</span>{{ test_form.$valid }}<span style="color: #e0eee0">&lt;/span&gt;</span>
  <span style="color: #e0eee0">&lt;/form&gt;</span>
  
  var TestCtrl = function($scope){
  
    $scope.see = function(){
      console.log($scope.test_form);
      console.log($scope.test_form.a);
    }
  
  }
</pre></div>


<p style="margin: 15px 0;">
除去对象的方法与属性， <i style=" color: #d75100; font-style: normal; ">form</i> 这个标签本身有一些动态类可以使用：
</p>

<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li><i style=" color: #d75100; font-style: normal; ">ng-valid</i> 当表单验证通过时的设置
</li>
<li><i style=" color: #d75100; font-style: normal; ">ng-invalid</i> 当表单验证失败时的设置
</li>
<li><i style=" color: #d75100; font-style: normal; ">ng-pristine</i> 表单的未被动之前拥有
</li>
<li><i style=" color: #d75100; font-style: normal; ">ng-dirty</i> 表单被动过之后拥有
</li>
</ul>

<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">form</i> 对象的属性有：
</p>

<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li><i style=" color: #d75100; font-style: normal; ">$pristine</i> 表单是否未被动过
</li>
<li><i style=" color: #d75100; font-style: normal; ">$dirty</i> 表单是否被动过
</li>
<li><i style=" color: #d75100; font-style: normal; ">$valid</i> 表单是否验证通过
</li>
<li><i style=" color: #d75100; font-style: normal; ">$invalid</i> 表单是否验证失败
</li>
<li><i style=" color: #d75100; font-style: normal; ">$error</i> 表单的验证错误
</li>
</ul>

<p style="margin: 15px 0;">
其中的 <i style=" color: #d75100; font-style: normal; ">$error</i> 对象包含有所有字段的验证信息，及对相关字段的 <i style=" color: #d75100; font-style: normal; ">NgModelController</i> 实例的引用。它的结构是一个对象， <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">key</code> 是失败信息， <i style=" color: #d75100; font-style: normal; ">required</i> ， <i style=" color: #d75100; font-style: normal; ">minlength</i> 之类的， <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">value</code> 是对应的字段实例列表。
</p>
<p style="margin: 15px 0;">
注意，这里的失败信息是按序列取的一个。比如，如果一个字段既要求 <i style=" color: #d75100; font-style: normal; ">required</i> ，也要求 <i style=" color: #d75100; font-style: normal; ">minlength</i> ，那么当它为空时， <i style=" color: #d75100; font-style: normal; ">$error</i> 中只有 <i style=" color: #d75100; font-style: normal; ">required</i> 的失败信息。只输入一个字符之后， <i style=" color: #d75100; font-style: normal; ">required</i> 条件满足了，才可能有 <i style=" color: #d75100; font-style: normal; ">minlength</i> 这个失败信息。
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;form</span> <span style="color: #e0eee0">name=</span><span style="color: #00e5ee">"test_form"</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;input</span> <span style="color: #e0eee0">type=</span><span style="color: #00e5ee">"text"</span> <span style="color: #e0eee0">name=</span><span style="color: #00e5ee">"a"</span> <span style="color: #e0eee0">required</span> <span style="color: #e0eee0">ng-model=</span><span style="color: #00e5ee">"a"</span>  <span style="color: #e0eee0">/&gt;</span>
    <span style="color: #e0eee0">&lt;input</span> <span style="color: #e0eee0">type=</span><span style="color: #00e5ee">"text"</span> <span style="color: #e0eee0">name=</span><span style="color: #00e5ee">"b"</span> <span style="color: #e0eee0">required</span> <span style="color: #e0eee0">ng-model=</span><span style="color: #00e5ee">"b"</span> <span style="color: #e0eee0">ng-minlength=</span><span style="color: #00e5ee">"2"</span> <span style="color: #e0eee0">/&gt;</span>
    <span style="color: #e0eee0">&lt;span</span> <span style="color: #e0eee0">ng-click=</span><span style="color: #00e5ee">"see()"</span><span style="color: #e0eee0">&gt;</span>{{ test_form.$error }}<span style="color: #e0eee0">&lt;/span&gt;</span>
  <span style="color: #e0eee0">&lt;/form&gt;</span>
  
  var TestCtrl = function($scope){
    $scope.see = function(){
      console.log($scope.test_form.$error);
    }
  }
</pre></div>


<a id="toc23" name="toc23"></a>
<h3 style=" font-size: small; margin: 0 auto; text-shadow: 1px 1px 1px gray; padding: 2px; color: #555;">7.5.2. input</h3>

<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">input</i> 是数据的最主要入口。 ng 支持 HTML5 中的相关属性，同时对旧浏览器也做了兼容性处理。最重要的， <i style=" color: #d75100; font-style: normal; ">input</i> 的规则定义，是所属表单的相关行为的参照（比如表单是否验证成功）。
</p>
<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">input</i> 控件的相关可用属性为：
</p>

<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li><i style=" color: #d75100; font-style: normal; ">name</i> 名字
</li>
<li><i style=" color: #d75100; font-style: normal; ">ng-model</i> 绑定的数据
</li>
<li><i style=" color: #d75100; font-style: normal; ">required</i> 是否必填
</li>
<li><i style=" color: #d75100; font-style: normal; ">ng-required</i> 是否必填
</li>
<li><i style=" color: #d75100; font-style: normal; ">ng-minlength</i> 最小长度
</li>
<li><i style=" color: #d75100; font-style: normal; ">ng-maxlength</i> 最大长度
</li>
<li><i style=" color: #d75100; font-style: normal; ">ng-pattern</i> 匹配模式
</li>
<li><i style=" color: #d75100; font-style: normal; ">ng-change</i> 值变化时的回调
</li>
</ul>


<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;form</span> <span style="color: #e0eee0">name=</span><span style="color: #00e5ee">"test_form"</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;input</span> <span style="color: #e0eee0">type=</span><span style="color: #00e5ee">"text"</span> <span style="color: #e0eee0">name=</span><span style="color: #00e5ee">"a"</span> <span style="color: #e0eee0">ng-model=</span><span style="color: #00e5ee">"a"</span> required <span style="color: #e0eee0">ng-pattern=</span><span style="color: #00e5ee">"/abc/"</span> <span style="color: #e0eee0">/&gt;</span>
    <span style="color: #e0eee0">&lt;span</span> <span style="color: #e0eee0">ng-click=</span><span style="color: #00e5ee">"see()"</span><span style="color: #e0eee0">&gt;</span>{{ test_form.$error }}<span style="color: #e0eee0">&lt;/span&gt;</span>
  <span style="color: #e0eee0">&lt;/form&gt;</span>
</pre></div>


<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">input</i> 控件，它还有一些扩展，这些扩展有些有自己的属性：
</p>

<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li><i style=" color: #d75100; font-style: normal; ">input type="number"</i> 多了 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">number</code> 错误类型，多了 <i style=" color: #d75100; font-style: normal; ">max</i> ， <i style=" color: #d75100; font-style: normal; ">min</i> 属性。
</li>
<li><i style=" color: #d75100; font-style: normal; ">input type="url"</i> 多了 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">url</code> 错误类型。
</li>
<li><i style=" color: #d75100; font-style: normal; ">input type="email"</i> 多了 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">email</code> 错误类型。
</li>
</ul>

<a id="toc24" name="toc24"></a>
<h3 style=" font-size: small; margin: 0 auto; text-shadow: 1px 1px 1px gray; padding: 2px; color: #555;">7.5.3. checkbox</h3>

<p style="margin: 15px 0;">
它也算是 <i style=" color: #d75100; font-style: normal; ">input</i> 的扩展，不过，它没有验证相关的东西，只有选中与不选中两个值：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;form</span> <span style="color: #e0eee0">name=</span><span style="color: #00e5ee">"test_form"</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;input</span> <span style="color: #e0eee0">type=</span><span style="color: #00e5ee">"checkbox"</span> <span style="color: #e0eee0">name=</span><span style="color: #00e5ee">"a"</span> <span style="color: #e0eee0">ng-model=</span><span style="color: #00e5ee">"a"</span> <span style="color: #e0eee0">ng-true-value=</span><span style="color: #00e5ee">"AA"</span> <span style="color: #e0eee0">ng-false-value=</span><span style="color: #00e5ee">"BB"</span> <span style="color: #e0eee0">/&gt;</span>
    <span style="color: #e0eee0">&lt;span&gt;</span>{{ a }}<span style="color: #e0eee0">&lt;/span&gt;</span>
  <span style="color: #e0eee0">&lt;/form&gt;</span>
  
  var TestCtrl = function($scope){
    $scope.a = 'AA';
  }
</pre></div>


<p style="margin: 15px 0;">
两点：
</p>

<ol style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li>controller 要初始化变量值。
</li>
<li>controller 中的初始化值会关系到控件状态（双向绑定）。
</li>
</ol>

<a id="toc25" name="toc25"></a>
<h3 style=" font-size: small; margin: 0 auto; text-shadow: 1px 1px 1px gray; padding: 2px; color: #555;">7.5.4. radio</h3>

<p style="margin: 15px 0;">
也是 <i style=" color: #d75100; font-style: normal; ">input</i> 的扩展。和 <i style=" color: #d75100; font-style: normal; ">checkbox</i> 一样，但它只有一个值了：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;form</span> <span style="color: #e0eee0">name=</span><span style="color: #00e5ee">"test_form"</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;input</span> <span style="color: #e0eee0">type=</span><span style="color: #00e5ee">"radio"</span> <span style="color: #e0eee0">name=</span><span style="color: #00e5ee">"a"</span> <span style="color: #e0eee0">ng-model=</span><span style="color: #00e5ee">"a"</span> <span style="color: #e0eee0">value=</span><span style="color: #00e5ee">"AA"</span> <span style="color: #e0eee0">/&gt;</span>
    <span style="color: #e0eee0">&lt;input</span> <span style="color: #e0eee0">type=</span><span style="color: #00e5ee">"radio"</span> <span style="color: #e0eee0">name=</span><span style="color: #00e5ee">"a"</span> <span style="color: #e0eee0">ng-model=</span><span style="color: #00e5ee">"a"</span> <span style="color: #e0eee0">value=</span><span style="color: #00e5ee">"BB"</span> <span style="color: #e0eee0">/&gt;</span>
    <span style="color: #e0eee0">&lt;span&gt;</span>{{ a }}<span style="color: #e0eee0">&lt;/span&gt;</span>
  <span style="color: #e0eee0">&lt;/form&gt;</span>
</pre></div>


<a id="toc26" name="toc26"></a>
<h3 style=" font-size: small; margin: 0 auto; text-shadow: 1px 1px 1px gray; padding: 2px; color: #555;">7.5.5. textarea</h3>

<p style="margin: 15px 0;">
同 <i style=" color: #d75100; font-style: normal; ">input</i> 。
</p>

<a id="toc27" name="toc27"></a>
<h3 style=" font-size: small; margin: 0 auto; text-shadow: 1px 1px 1px gray; padding: 2px; color: #555;">7.5.6. select</h3>

<p style="margin: 15px 0;">
这是一个比较牛B的控件。它里面的一个叫做 <i style=" color: #d75100; font-style: normal; ">ng-options</i> 的属性用于数据呈现。
</p>
<p style="margin: 15px 0;">
对于给定列表时的使用。
</p>
<p style="margin: 15px 0;">
最简单的使用方法， <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">x for x in list</code> ：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;form</span> <span style="color: #e0eee0">name=</span><span style="color: #00e5ee">"test_form"</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span> <span style="color: #e0eee0">ng-init=</span><span style="color: #00e5ee">"o=[0,1,2,3]; a=o[1];"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;select</span> <span style="color: #e0eee0">ng-model=</span><span style="color: #00e5ee">"a"</span> <span style="color: #e0eee0">ng-options=</span><span style="color: #00e5ee">"x for x in o"</span> <span style="color: #e0eee0">ng-change=</span><span style="color: #00e5ee">"show()"</span><span style="color: #e0eee0">&gt;</span>
      <span style="color: #e0eee0">&lt;option</span> <span style="color: #e0eee0">value=</span><span style="color: #00e5ee">""</span><span style="color: #e0eee0">&gt;</span>可以加这个空值<span style="color: #e0eee0">&lt;/option&gt;</span>
    <span style="color: #e0eee0">&lt;/select&gt;</span>
  <span style="color: #e0eee0">&lt;/form&gt;</span>
  
  <span style="color: #e0eee0">&lt;script type=</span><span style="color: #00e5ee">"text/javascript"</span><span style="color: #e0eee0">&gt;</span>
  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">TestCtrl</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>){
    <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">show</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(){
      <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">a</span>);
    }
  }
  
  <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">bootstrap</span>(<span style="color: #e0eee0">document</span>.<span style="color: #e0eee0">documentElement</span>);
  <span style="color: #e0eee0">&lt;/script&gt;</span>
</pre></div>


<p style="margin: 15px 0;">
在 <i style=" color: #d75100; font-style: normal; ">$scope</i> 中， <i style=" color: #d75100; font-style: normal; ">select</i> 绑定的变量，其值和普通的 <i style=" color: #d75100; font-style: normal; ">value</i> 无关，可以是一个对象：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;form</span> <span style="color: #e0eee0">name=</span><span style="color: #00e5ee">"test_form"</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span>
        <span style="color: #e0eee0">ng-init=</span><span style="color: #00e5ee">"o=[{name: 'AA'}, {name: 'BB'}]; a=o[1];"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;select</span> <span style="color: #e0eee0">ng-model=</span><span style="color: #00e5ee">"a"</span> <span style="color: #e0eee0">ng-options=</span><span style="color: #00e5ee">"x.name for x in o"</span> <span style="color: #e0eee0">ng-change=</span><span style="color: #00e5ee">"show()"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;/select&gt;</span>
  <span style="color: #e0eee0">&lt;/form&gt;</span>
</pre></div>


<p style="margin: 15px 0;">
显示与值分别指定， <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">x.v as x.name for x in o</code> ：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;form</span> <span style="color: #e0eee0">name=</span><span style="color: #00e5ee">"test_form"</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span>
        <span style="color: #e0eee0">ng-init=</span><span style="color: #00e5ee">"o=[{name: 'AA', v: '00'}, {name: 'BB', v: '11'}]; a=o[1].v;"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;select</span> <span style="color: #e0eee0">ng-model=</span><span style="color: #00e5ee">"a"</span> <span style="color: #e0eee0">ng-options=</span><span style="color: #00e5ee">"x.v as x.name for x in o"</span> <span style="color: #e0eee0">ng-change=</span><span style="color: #00e5ee">"show()"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;/select&gt;</span>
  <span style="color: #e0eee0">&lt;/form&gt;</span>
</pre></div>


<p style="margin: 15px 0;">
加入分组的， <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">x.name group by x.g for x in o</code> ：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;form</span> <span style="color: #e0eee0">name=</span><span style="color: #00e5ee">"test_form"</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span>
        <span style="color: #e0eee0">ng-init=</span><span style="color: #00e5ee">"o=[{name: 'AA', g: '00'}, {name: 'BB', g: '11'}, {name: 'CC', g: '00'}]; a=o[1];"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;select</span> <span style="color: #e0eee0">ng-model=</span><span style="color: #00e5ee">"a"</span> <span style="color: #e0eee0">ng-options=</span><span style="color: #00e5ee">"x.name group by x.g for x in o"</span> <span style="color: #e0eee0">ng-change=</span><span style="color: #00e5ee">"show()"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;/select&gt;</span>
  <span style="color: #e0eee0">&lt;/form&gt;</span>
</pre></div>


<p style="margin: 15px 0;">
分组了还分别指定显示与值的， <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">x.v as x.name group by x.g for x in o</code> ：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;form</span> <span style="color: #e0eee0">name=</span><span style="color: #00e5ee">"test_form"</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span> <span style="color: #e0eee0">ng-init=</span><span style="color: #00e5ee">"o=[{name: 'AA', g: '00', v: '='}, {name: 'BB', g: '11', v: '+'}, {name: 'CC', g: '00', v: '!'}]; a=o[1].v;"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;select</span> <span style="color: #e0eee0">ng-model=</span><span style="color: #00e5ee">"a"</span> <span style="color: #e0eee0">ng-options=</span><span style="color: #00e5ee">"x.v as x.name group by x.g for x in o"</span> <span style="color: #e0eee0">ng-change=</span><span style="color: #00e5ee">"show()"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;/select&gt;</span>
  <span style="color: #e0eee0">&lt;/form&gt;</span>
</pre></div>


<p style="margin: 15px 0;">
如果参数是对象的话，基本也是一样的，只是把遍历的对象改成 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">(key, value)</code> ：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;form</span> <span style="color: #e0eee0">name=</span><span style="color: #00e5ee">"test_form"</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span> <span style="color: #e0eee0">ng-init=</span><span style="color: #00e5ee">"o={a: 0, b: 1}; a=o.a;"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;select</span> <span style="color: #e0eee0">ng-model=</span><span style="color: #00e5ee">"a"</span> <span style="color: #e0eee0">ng-options=</span><span style="color: #00e5ee">"k for (k, v) in o"</span> <span style="color: #e0eee0">ng-change=</span><span style="color: #00e5ee">"show()"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;/select&gt;</span>
  <span style="color: #e0eee0">&lt;/form&gt;</span>
  
  <span style="color: #e0eee0">&lt;form</span> <span style="color: #e0eee0">name=</span><span style="color: #00e5ee">"test_form"</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span>
        <span style="color: #e0eee0">ng-init=</span><span style="color: #00e5ee">"o={a: {name: 'AA', v: '00'}, b: {name: 'BB', v: '11'}}; a=o.a.v;"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;select</span> <span style="color: #e0eee0">ng-model=</span><span style="color: #00e5ee">"a"</span> <span style="color: #e0eee0">ng-options=</span><span style="color: #00e5ee">"v.v as v.name for (k, v) in o"</span> <span style="color: #e0eee0">ng-change=</span><span style="color: #00e5ee">"show()"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;/select&gt;</span>
  <span style="color: #e0eee0">&lt;/form&gt;</span>
  
  <span style="color: #e0eee0">&lt;form</span> <span style="color: #e0eee0">name=</span><span style="color: #00e5ee">"test_form"</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span>
        <span style="color: #e0eee0">ng-init=</span><span style="color: #00e5ee">"o={a: {name: 'AA', v: '00', g: '=='}, b: {name: 'BB', v: '11', g: '=='}}; a=o.a;"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;select</span> <span style="color: #e0eee0">ng-model=</span><span style="color: #00e5ee">"a"</span> <span style="color: #e0eee0">ng-options=</span><span style="color: #00e5ee">"v.name group by v.g for (k, v) in o"</span> <span style="color: #e0eee0">ng-change=</span><span style="color: #00e5ee">"show()"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;/select&gt;</span>
  <span style="color: #e0eee0">&lt;/form&gt;</span>
  
  <span style="color: #e0eee0">&lt;form</span> <span style="color: #e0eee0">name=</span><span style="color: #00e5ee">"test_form"</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span>
        <span style="color: #e0eee0">ng-init=</span><span style="color: #00e5ee">"o={a: {name: 'AA', v: '00', g: '=='}, b: {name: 'BB', v: '11', g: '=='}}; a=o.a.v;"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;select</span> <span style="color: #e0eee0">ng-model=</span><span style="color: #00e5ee">"a"</span> <span style="color: #e0eee0">ng-options=</span><span style="color: #00e5ee">"v.v as v.name group by v.g for (k, v) in o"</span> <span style="color: #e0eee0">ng-change=</span><span style="color: #00e5ee">"show()"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;/select&gt;</span>
  <span style="color: #e0eee0">&lt;/form&gt;</span>
</pre></div>


<a id="toc28" name="toc28"></a>
<h1 style=" -moz-border-radius: 5px; -webkit-border-radius: 5px; -moz-box-shadow: 3px 3px 5px #333; -webkit-box-shadow: 3px 3px 5px #333; box-shadow: 3px 3px 5px #333;  border-radius: 5px; background-color: #69ab01; padding: 4px; color: white; line-height: 1.3em; text-shadow: 2px 2px 2px black; margin: 20px auto; font-size: medium; clear: both;">8. 模板中的过滤器</h1>

<p style="margin: 15px 0;">
这里说的过滤器，是用于对数据的格式化，或者筛选的函数。它们可以直接在模板中通过一种语法使用。对于常用功能来说，是很方便的一种机制。
</p>
<p style="margin: 15px 0;">
多个过滤器之间可以直接连续使用。
</p>

<a id="toc29" name="toc29"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">8.1. 排序 orderBy</h2>

<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">orderBy</i> 是一个排序用的过滤器标签。它可以像 <i style=" color: #d75100; font-style: normal; ">sort</i> 函数那样支持一个排序函数，也可以简单地指定一个属性名进行操作：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span><span style="color: #e0eee0">&gt;</span>
    {{ data | orderBy: 'age' }} <span style="color: #e0eee0">&lt;br</span> <span style="color: #e0eee0">/&gt;</span>
    {{ data | orderBy: '-age' }} <span style="color: #e0eee0">&lt;br</span> <span style="color: #e0eee0">/&gt;</span>
    {{ data | orderBy: '-age' | limitTo: 2 }} <span style="color: #e0eee0">&lt;br</span> <span style="color: #e0eee0">/&gt;</span>
    {{ data | orderBy: ['-age', 'name'] }} <span style="color: #e0eee0">&lt;br</span> <span style="color: #e0eee0">/&gt;</span>
  <span style="color: #e0eee0">&lt;/div&gt;</span>
  
  
  <span style="color: #e0eee0">&lt;script type=</span><span style="color: #00e5ee">"text/javascript"</span><span style="color: #e0eee0">&gt;</span>
  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">TestCtrl</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>){
    <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">data</span> <span style="color: #7fff00">=</span> [
      {<span style="color: #e0eee0">name</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'B'</span>, <span style="color: #e0eee0">age</span><span style="color: #7fff00">:</span> <span style="color: #00ffff">4</span>},  
      {<span style="color: #e0eee0">name</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'A'</span>, <span style="color: #e0eee0">age</span><span style="color: #7fff00">:</span> <span style="color: #00ffff">1</span>},  
      {<span style="color: #e0eee0">name</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'D'</span>, <span style="color: #e0eee0">age</span><span style="color: #7fff00">:</span> <span style="color: #00ffff">3</span>},  
      {<span style="color: #e0eee0">name</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'C'</span>, <span style="color: #e0eee0">age</span><span style="color: #7fff00">:</span> <span style="color: #00ffff">3</span>},  
    ];
  }
  
  <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">bootstrap</span>(<span style="color: #e0eee0">document</span>.<span style="color: #e0eee0">documentElement</span>);
  <span style="color: #e0eee0">&lt;/script&gt;</span>
</pre></div>


<a id="toc30" name="toc30"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">8.2. 过滤列表 filter</h2>

<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">filter</i> 是一个过滤内容的标签。
</p>
<p style="margin: 15px 0;">
如果参数是一个字符串，则列表成员中的任意属性值中有这个字符串，即为满足条件（忽略大小写）：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span><span style="color: #e0eee0">&gt;</span>
    {{ data | filter: 'b' }} <span style="color: #e0eee0">&lt;br</span> <span style="color: #e0eee0">/&gt;</span>
    {{ data | filter: '!B' }} <span style="color: #e0eee0">&lt;br</span> <span style="color: #e0eee0">/&gt;</span>
  <span style="color: #e0eee0">&lt;/div&gt;</span>
  
  
  <span style="color: #e0eee0">&lt;script type=</span><span style="color: #00e5ee">"text/javascript"</span><span style="color: #e0eee0">&gt;</span>
  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">TestCtrl</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>){
    <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">data</span> <span style="color: #7fff00">=</span> [
      {<span style="color: #e0eee0">name</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'B'</span>, <span style="color: #e0eee0">age</span><span style="color: #7fff00">:</span> <span style="color: #00ffff">4</span>},  
      {<span style="color: #e0eee0">name</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'A'</span>, <span style="color: #e0eee0">age</span><span style="color: #7fff00">:</span> <span style="color: #00ffff">1</span>},  
      {<span style="color: #e0eee0">name</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'D'</span>, <span style="color: #e0eee0">age</span><span style="color: #7fff00">:</span> <span style="color: #00ffff">3</span>},  
      {<span style="color: #e0eee0">name</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'C'</span>, <span style="color: #e0eee0">age</span><span style="color: #7fff00">:</span> <span style="color: #00ffff">3</span>},  
    ];
  }
  
  <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">bootstrap</span>(<span style="color: #e0eee0">document</span>.<span style="color: #e0eee0">documentElement</span>);
  <span style="color: #e0eee0">&lt;/script&gt;</span>
</pre></div>


<p style="margin: 15px 0;">
可以使用对象，来指定属性名， <i style=" color: #d75100; font-style: normal; ">$</i> 表示任意属性：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  {{ <span style="color: #e0eee0">data</span> <span style="color: #7fff00">|</span> <span style="color: #e0eee0">filter:</span> {<span style="color: #e0eee0">name:</span> <span style="color: #00e5ee">'A'</span>} }} <span style="color: #7fff00">&lt;</span><span style="color: #e0eee0">br</span> <span style="color: #7fff00">/&gt;</span>
  {{ <span style="color: #e0eee0">data</span> <span style="color: #7fff00">|</span> <span style="color: #e0eee0">filter:</span> {<span style="color: #e0eee0">$:</span> <span style="color: #00e5ee">'3'</span>} }} <span style="color: #7fff00">&lt;</span><span style="color: #e0eee0">br</span> <span style="color: #7fff00">/&gt;</span>
  {{ <span style="color: #e0eee0">data</span> <span style="color: #7fff00">|</span> <span style="color: #e0eee0">filter:</span> {<span style="color: #e0eee0">$:</span> <span style="color: #00e5ee">'!3'</span>} }} <span style="color: #7fff00">&lt;</span><span style="color: #e0eee0">br</span> <span style="color: #7fff00">/&gt;</span>
</pre></div>


<p style="margin: 15px 0;">
自定义的过滤函数也支持：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span><span style="color: #e0eee0">&gt;</span>
    {{ data | filter: f }} <span style="color: #e0eee0">&lt;br</span> <span style="color: #e0eee0">/&gt;</span>
  <span style="color: #e0eee0">&lt;/div&gt;</span>
  
  
  <span style="color: #e0eee0">&lt;script type=</span><span style="color: #00e5ee">"text/javascript"</span><span style="color: #e0eee0">&gt;</span>
  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">TestCtrl</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>){
    <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">data</span> <span style="color: #7fff00">=</span> [
      {<span style="color: #e0eee0">name</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'B'</span>, <span style="color: #e0eee0">age</span><span style="color: #7fff00">:</span> <span style="color: #00ffff">4</span>},  
      {<span style="color: #e0eee0">name</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'A'</span>, <span style="color: #e0eee0">age</span><span style="color: #7fff00">:</span> <span style="color: #00ffff">1</span>},  
      {<span style="color: #e0eee0">name</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'D'</span>, <span style="color: #e0eee0">age</span><span style="color: #7fff00">:</span> <span style="color: #00ffff">3</span>},  
      {<span style="color: #e0eee0">name</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'C'</span>, <span style="color: #e0eee0">age</span><span style="color: #7fff00">:</span> <span style="color: #00ffff">3</span>},  
    ];
  
    <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">f</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">e</span>){
      <span style="color: #90ee90">return</span> <span style="color: #e0eee0">e</span>.<span style="color: #e0eee0">age</span> <span style="color: #7fff00">&gt;</span> <span style="color: #00ffff">2</span>;
    }
  }
  
  <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">bootstrap</span>(<span style="color: #e0eee0">document</span>.<span style="color: #e0eee0">documentElement</span>);
  <span style="color: #e0eee0">&lt;/script&gt;</span>
</pre></div>


<a id="toc31" name="toc31"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">8.3. 其它</h2>

<p style="margin: 15px 0;">
时间戳格式化 <i style=" color: #d75100; font-style: normal; ">date</i> ：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span><span style="color: #e0eee0">&gt;</span>
  {{ a | date: 'yyyy-MM-dd HH:mm:ss' }}
  <span style="color: #e0eee0">&lt;/div&gt;</span>
  
  <span style="color: #e0eee0">&lt;script type=</span><span style="color: #00e5ee">"text/javascript"</span><span style="color: #e0eee0">&gt;</span>
  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">TestCtrl</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>){
    <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">a</span> <span style="color: #7fff00">=</span> ((<span style="color: #90ee90">new</span> <span style="color: #e0eee0">Date</span>().<span style="color: #e0eee0">valueOf</span>()));
  }
  
  <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">bootstrap</span>(<span style="color: #e0eee0">document</span>.<span style="color: #e0eee0">documentElement</span>);
  <span style="color: #e0eee0">&lt;/script&gt;</span>
</pre></div>


<p style="margin: 15px 0;">
列表截取 <i style=" color: #d75100; font-style: normal; ">limitTo</i> ，支持正负数：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  {{ [<span style="color: #00ffff">1</span>,<span style="color: #00ffff">2</span>,<span style="color: #00ffff">3</span>,<span style="color: #00ffff">4</span>,<span style="color: #00ffff">5</span>] <span style="color: #7fff00">|</span> <span style="color: #e0eee0">limitTo:</span> <span style="color: #00ffff">2</span> }}
  {{ [<span style="color: #00ffff">1</span>,<span style="color: #00ffff">2</span>,<span style="color: #00ffff">3</span>,<span style="color: #00ffff">4</span>,<span style="color: #00ffff">5</span>] <span style="color: #7fff00">|</span> <span style="color: #e0eee0">limitTo:</span> <span style="color: #7fff00">-</span><span style="color: #00ffff">3</span> }}
</pre></div>


<p style="margin: 15px 0;">
大小写 <i style=" color: #d75100; font-style: normal; ">lowercase</i> ， <i style=" color: #d75100; font-style: normal; ">uppercase</i> ：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  {{ <span style="color: #00e5ee">'abc'</span> <span style="color: #7fff00">|</span> <span style="color: #e0eee0">uppercase</span> }}
  {{ <span style="color: #00e5ee">'Abc'</span> <span style="color: #7fff00">|</span> <span style="color: #e0eee0">lowercase</span> }}
</pre></div>


<a id="toc32" name="toc32"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">8.4. 例子：表头排序</h2>


<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;"><span style="color: gray; padding: 0 5px 0 5px"> 1</span>   <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span><span style="color: #e0eee0">&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 2</span>     <span style="color: #e0eee0">&lt;table&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 3</span>       <span style="color: #e0eee0">&lt;tr&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 4</span>         <span style="color: #e0eee0">&lt;th</span> <span style="color: #e0eee0">ng-click=</span><span style="color: #00e5ee">"f='name'; rev=!rev"</span><span style="color: #e0eee0">&gt;</span>名字<span style="color: #e0eee0">&lt;/th&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 5</span>         <span style="color: #e0eee0">&lt;th</span> <span style="color: #e0eee0">ng-click=</span><span style="color: #00e5ee">"f='age'; rev=!rev"</span><span style="color: #e0eee0">&gt;</span>年龄<span style="color: #e0eee0">&lt;/th&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 6</span>       <span style="color: #e0eee0">&lt;/tr&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 7</span>   
<span style="color: gray; padding: 0 5px 0 5px"> 8</span>       <span style="color: #e0eee0">&lt;tr</span> <span style="color: #e0eee0">ng-repeat=</span><span style="color: #00e5ee">"o in data | orderBy: f : rev"</span><span style="color: #e0eee0">&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 9</span>         <span style="color: #e0eee0">&lt;td&gt;</span>{{ o.name }}<span style="color: #e0eee0">&lt;/td&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">10</span>         <span style="color: #e0eee0">&lt;td&gt;</span>{{ o.age }}<span style="color: #e0eee0">&lt;/td&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">11</span>       <span style="color: #e0eee0">&lt;/tr&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">12</span>     <span style="color: #e0eee0">&lt;/table&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">13</span>   <span style="color: #e0eee0">&lt;/div&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">14</span>   
<span style="color: gray; padding: 0 5px 0 5px">15</span>   <span style="color: #e0eee0">&lt;script</span> <span style="color: #e0eee0">type=</span><span style="color: #00e5ee">"text/javascript"</span><span style="color: #e0eee0">&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">16</span>   var TestCtrl = function($scope){
<span style="color: gray; padding: 0 5px 0 5px">17</span>     $scope.data = [
<span style="color: gray; padding: 0 5px 0 5px">18</span>       {name: 'B', age: 4},  
<span style="color: gray; padding: 0 5px 0 5px">19</span>       {name: 'A', age: 1},  
<span style="color: gray; padding: 0 5px 0 5px">20</span>       {name: 'D', age: 3},  
<span style="color: gray; padding: 0 5px 0 5px">21</span>       {name: 'C', age: 3},  
<span style="color: gray; padding: 0 5px 0 5px">22</span>     ];
<span style="color: gray; padding: 0 5px 0 5px">23</span>   }
<span style="color: gray; padding: 0 5px 0 5px">24</span>   
<span style="color: gray; padding: 0 5px 0 5px">25</span>   angular.bootstrap(document.documentElement);
<span style="color: gray; padding: 0 5px 0 5px">26</span>   <span style="color: #e0eee0">&lt;/script&gt;</span>
</pre></div>


<a id="toc33" name="toc33"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">8.5. 例子：搜索</h2>


<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span> <span style="color: #e0eee0">ng-init=</span><span style="color: #00e5ee">"s=data[0].name; q=''"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;div&gt;</span>
      <span style="color: #e0eee0">&lt;span&gt;</span>查找：<span style="color: #e0eee0">&lt;/span&gt;</span> <span style="color: #e0eee0">&lt;input</span> <span style="color: #e0eee0">type=</span><span style="color: #00e5ee">"text"</span> <span style="color: #e0eee0">ng-model=</span><span style="color: #00e5ee">"q"</span> <span style="color: #e0eee0">/&gt;</span>
    <span style="color: #e0eee0">&lt;/div&gt;</span>
    <span style="color: #e0eee0">&lt;select</span> <span style="color: #e0eee0">ng-multiple=</span><span style="color: #00e5ee">"true"</span> <span style="color: #e0eee0">ng-model=</span><span style="color: #00e5ee">"s"</span>
            <span style="color: #e0eee0">ng-options=</span><span style="color: #00e5ee">"o.name as o.name + '(' + o.age + ')' for o in data | filter: {name: q} | orderBy: ['age', 'name'] "</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;/select&gt;</span>
  <span style="color: #e0eee0">&lt;/div&gt;</span>
  
  <span style="color: #e0eee0">&lt;script type=</span><span style="color: #00e5ee">"text/javascript"</span><span style="color: #e0eee0">&gt;</span>
  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">TestCtrl</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>){
    <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">data</span> <span style="color: #7fff00">=</span> [
      {<span style="color: #e0eee0">name</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'B'</span>, <span style="color: #e0eee0">age</span><span style="color: #7fff00">:</span> <span style="color: #00ffff">4</span>},  
      {<span style="color: #e0eee0">name</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'A'</span>, <span style="color: #e0eee0">age</span><span style="color: #7fff00">:</span> <span style="color: #00ffff">1</span>},  
      {<span style="color: #e0eee0">name</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'D'</span>, <span style="color: #e0eee0">age</span><span style="color: #7fff00">:</span> <span style="color: #00ffff">3</span>},  
      {<span style="color: #e0eee0">name</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'C'</span>, <span style="color: #e0eee0">age</span><span style="color: #7fff00">:</span> <span style="color: #00ffff">3</span>},  
    ];
  }
  
  <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">bootstrap</span>(<span style="color: #e0eee0">document</span>.<span style="color: #e0eee0">documentElement</span>);
  <span style="color: #e0eee0">&lt;/script&gt;</span>
</pre></div>


<a id="toc34" name="toc34"></a>
<h1 style=" -moz-border-radius: 5px; -webkit-border-radius: 5px; -moz-box-shadow: 3px 3px 5px #333; -webkit-box-shadow: 3px 3px 5px #333; box-shadow: 3px 3px 5px #333;  border-radius: 5px; background-color: #69ab01; padding: 4px; color: white; line-height: 1.3em; text-shadow: 2px 2px 2px black; margin: 20px auto; font-size: medium; clear: both;">9. 锚点路由</h1>

<p style="margin: 15px 0;">
准确地说，这应该叫对 <i style=" color: #d75100; font-style: normal; ">hashchange</i> 事件的处理吧。
</p>
<p style="margin: 15px 0;">
就是指 URL 中的锚点部分发生变化时，触发预先定义的业务逻辑。比如现在是 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">/test#/x</code> ，锚点部分的值为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">#</code> 后的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">/x</code> ，它就对应了一组处理逻辑。当这部分变化时，比如变成了 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">/test#/t</code> ，这时页面是不会刷新的，但是它可以触发另外一组处理逻辑，来做一些事，也可以让页面发生变化。
</p>
<p style="margin: 15px 0;">
这种机制对于复杂的单页面来说，无疑是一种强大的业务切分手段。就算不是复杂的单页面应用，在普通页面上善用这种机制，也可以让业务逻辑更容易控制。
</p>
<p style="margin: 15px 0;">
ng 提供了完善的锚点路由功能，虽然目前我觉得相当重要的一个功能还有待完善（后面会说），但目前这功能的几部分内容，已经让我思考了很多种可能性了。
</p>
<p style="margin: 15px 0;">
ng 中的锚点路由功能是由几部分 API 共同完成的一整套方案。这其中包括了路由定义，参数定义，业务处理等。
</p>

<a id="toc35" name="toc35"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">9.1. 路由定义</h2>

<p style="margin: 15px 0;">
要使用锚点路由功能，需要在先定义它。目前，对于定义的方法，我个人只发现在“初始化”阶段可以通过 <i style=" color: #d75100; font-style: normal; ">$routeProvider</i> 这个服务来定义。
</p>
<p style="margin: 15px 0;">
在定义一个 app 时可以定义锚点路由：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;html</span> <span style="color: #e0eee0">ng-app=</span><span style="color: #00e5ee">"ngView"</span><span style="color: #e0eee0">&gt;</span>
    ... ...
  
  <span style="color: #e0eee0">&lt;div</span> ng-view<span style="color: #e0eee0">&gt;&lt;/div&gt;</span>
  
  <span style="color: #e0eee0">&lt;script</span> <span style="color: #e0eee0">type=</span><span style="color: #00e5ee">"text/javascript"</span><span style="color: #e0eee0">&gt;</span>
  
  angular.module('ngView', [],
    function($routeProvider){
      $routeProvider.when('/test',
        {
          template: 'test',
        }
      );
    }
  );
  
  <span style="color: #e0eee0">&lt;/script&gt;</span>
</pre></div>


<p style="margin: 15px 0;">
首先看 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">ng-view</code> 这个 directive ，它是一个标记“锚点作用区”的指令。目前页面上只能有一个“锚点作用区”。有人已经提了，“多个可命名”的锚点作用区的代码到官方，但是目前官方还没有接受合并，我觉得多个作用区这个功能是很重要的，希望下个发布版中能有。
</p>
<p style="margin: 15px 0;">
锚点作用区的功能，就是让锚点路由定义时的那些模板， controller 等，它们产生的 HTML 代码放在作用区内。
</p>
<p style="margin: 15px 0;">
比如上面的代码，当你刚打开页面时，页面是空白的。你手动访问 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">/#/test</code> 就可以看到页面上出现了 <i style=" color: #d75100; font-style: normal; ">'test'</i> 的字样。
</p>
<p style="margin: 15px 0;">
在 <i style=" color: #d75100; font-style: normal; ">angular.bootstrap()</i> 时也可以定义：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">bootstrap</span>(<span style="color: #e0eee0">document</span>.<span style="color: #e0eee0">documentElement</span>, [
    <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$routeProvider</span>){
      <span style="color: #e0eee0">$routeProvider</span>.<span style="color: #e0eee0">when</span>(<span style="color: #00e5ee">'/test'</span>,
        {
          <span style="color: #e0eee0">template</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'test'</span>
        }
      );
    }
  ]);
</pre></div>


<a id="toc36" name="toc36"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">9.2. 参数定义</h2>

<p style="margin: 15px 0;">
在作路由定义时，可以匹配一个规则，规则中可以定义路径中的某些部分作为参数之用，然后使用 <i style=" color: #d75100; font-style: normal; ">$routeParams</i> 服务获取到指定参数。比如 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">/#/book/test</code> 中， <i style=" color: #d75100; font-style: normal; ">test</i> 作为参数传入到 controller 中：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #7fff00">&lt;</span><span style="color: #e0eee0">div</span> <span style="color: #e0eee0">ng</span><span style="color: #7fff00">-</span><span style="color: #e0eee0">view</span><span style="color: #7fff00">&gt;&lt;</span>/div&gt;
  
  
  <span style="color: #7fff00">&lt;</span><span style="color: #e0eee0">script</span> <span style="color: #e0eee0">type</span><span style="color: #7fff00">=</span><span style="color: #00e5ee">"text/javascript"</span><span style="color: #7fff00">&gt;</span>
  
  <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'ngView'</span>, [],
    <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$routeProvider</span>){
      <span style="color: #e0eee0">$routeProvider</span>.<span style="color: #e0eee0">when</span>(<span style="color: #00e5ee">'/book/:title'</span>,
        {
          <span style="color: #e0eee0">template</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'{{ title }}'</span>,
          <span style="color: #e0eee0">controller</span><span style="color: #7fff00">:</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">$routeParams</span>){
            <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">title</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$routeParams</span>.<span style="color: #e0eee0">title</span>;
          }
        }
      );
    }
  );
  
  <span style="color: #7fff00">&lt;</span>/script&gt;
</pre></div>


<p style="margin: 15px 0;">
访问： <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">/#/book/test</code>
</p>
<p style="margin: 15px 0;">
不需要预定义模式，也可以像普通 GET 请求那样获取到相关参数：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'ngView'</span>, [],
    <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$routeProvider</span>){
      <span style="color: #e0eee0">$routeProvider</span>.<span style="color: #e0eee0">when</span>(<span style="color: #00e5ee">'/book'</span>,
        {
          <span style="color: #e0eee0">template</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'{{ title }}'</span>,
          <span style="color: #e0eee0">controller</span><span style="color: #7fff00">:</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">$routeParams</span>){
            <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">title</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$routeParams</span>.<span style="color: #e0eee0">title</span>;
          }
        }
      );
    }
  );
</pre></div>


<p style="margin: 15px 0;">
访问： <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">/#/book?title=test</code>
</p>

<a id="toc37" name="toc37"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">9.3. 业务处理</h2>

<p style="margin: 15px 0;">
简单来说，当一个锚点路由定义被匹配时，会根据模板生成一个 <i style=" color: #d75100; font-style: normal; ">$scope</i> ，同时相应的一个 controller 就会被触发。最后模板的结果会被填充到 <i style=" color: #d75100; font-style: normal; ">ng-view</i> 中去。
</p>
<p style="margin: 15px 0;">
从上面的例子中可以看到，最直接的方式，我们可以在模板中双向绑定数据，而数据的来源，在 controller 中控制。在 controller 中，又可以使用到像 <i style=" color: #d75100; font-style: normal; ">$scope</i> ， <i style=" color: #d75100; font-style: normal; ">$routeParams</i> 这些服务。
</p>
<p style="margin: 15px 0;">
这里先提一下另外一种与锚点路由相关的服务， <i style=" color: #d75100; font-style: normal; ">$route</i> 。这个服务里锚点路由在定义时，及匹配过程中的信息。比如我们搞怪一下：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'ngView'</span>, [],
    <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$routeProvider</span>){
      <span style="color: #e0eee0">$routeProvider</span>.<span style="color: #e0eee0">when</span>(<span style="color: #00e5ee">'/a'</span>,
        {
          <span style="color: #e0eee0">template</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'{{ title }}'</span>,
          <span style="color: #e0eee0">controller</span><span style="color: #7fff00">:</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>){
            <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">title</span> <span style="color: #7fff00">=</span> <span style="color: #00e5ee">'a'</span>;
          }
        }
      );
  
      <span style="color: #e0eee0">$routeProvider</span>.<span style="color: #e0eee0">when</span>(<span style="color: #00e5ee">'/b'</span>,
        {
          <span style="color: #e0eee0">template</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'{{ title }}'</span>,
          <span style="color: #e0eee0">controller</span><span style="color: #7fff00">:</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">$route</span>){
            <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">$route</span>);
            <span style="color: #e0eee0">$route</span>.<span style="color: #e0eee0">routes</span>[<span style="color: #00e5ee">'/a'</span>].<span style="color: #e0eee0">controller</span>(<span style="color: #e0eee0">$scope</span>);
          }
        }
      );
    }
  );
</pre></div>


<p style="margin: 15px 0;">
回到锚点定义的业务处理中来。我们可以以字符串形式写模板，也可以直接引用外部文件作为模板：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">angular</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'ngView'</span>, <span style="color: #7fff00">[]</span>,
    <span style="color: #e0eee0">function</span>(<span style="color: #e0eee0">$routeProvider</span>){
      <span style="color: #e0eee0">$routeProvider</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">when</span>(<span style="color: #00e5ee">'/test'</span>,
        {
          <span style="color: #e0eee0">templateUrl:</span> <span style="color: #00e5ee">'tpl.html'</span>,
          <span style="color: #e0eee0">controller:</span> <span style="color: #e0eee0">function</span>(<span style="color: #e0eee0">$scope</span>){
            <span style="color: #e0eee0">$scope</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">title</span> <span style="color: #7fff00">=</span> <span style="color: #00e5ee">'a'</span>;
          }
        }
      );
    }
  );
</pre></div>


<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">tpl.html</i> 中的内容是：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  {{ <span style="color: #e0eee0">title</span> }}
</pre></div>


<p style="margin: 15px 0;">
这样的话，模板可以预定义，也可以很复杂了。
</p>
<p style="margin: 15px 0;">
现在暂时忘了模板吧，因为前面提到的，当前 <i style=" color: #d75100; font-style: normal; ">ng-view</i> 不能有多个的限制，模板的渲染机制局限性还是很大的。不过，反正会触发一个 controller ，那么在函数当中我们可以尽量地干自己喜欢的事：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  angular.module('ngView', [],
    function($routeProvider){
      $routeProvider.when('/test',
        {
          template: '{{}}',
          controller: function(){
            $('div').first().html('<span style="color: #e0eee0">&lt;b&gt;</span>OK<span style="color: #e0eee0">&lt;/b&gt;</span>');
          }
        }
      );
    }
  );
</pre></div>


<p style="margin: 15px 0;">
那个空的 <i style=" color: #d75100; font-style: normal; ">template</i> 不能省，否则 controller 不会被触发。
</p>

<a id="toc38" name="toc38"></a>
<h1 style=" -moz-border-radius: 5px; -webkit-border-radius: 5px; -moz-box-shadow: 3px 3px 5px #333; -webkit-box-shadow: 3px 3px 5px #333; box-shadow: 3px 3px 5px #333;  border-radius: 5px; background-color: #69ab01; padding: 4px; color: white; line-height: 1.3em; text-shadow: 2px 2px 2px black; margin: 20px auto; font-size: medium; clear: both;">10. 定义模板变量标识标签</h1>

<p style="margin: 15px 0;">
由于下面涉及动态内容，所以我打算起一个后端服务来做。但是我发现我使用的 Tornado 框架的模板系统，与 ng 的模板系统，都是使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">{{ }}</code> 这对符号来定义模板表达式的，这太悲剧了，不过幸好 ng 已经提供了修改方法：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">angular</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">bootstrap</span>(<span style="color: #e0eee0">document</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">documentElement</span>,
    [<span style="color: #e0eee0">function</span>(<span style="color: #e0eee0">$interpolateProvider</span>){
      <span style="color: #e0eee0">$interpolateProvider</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">startSymbol</span>(<span style="color: #00e5ee">'[['</span>);
      <span style="color: #e0eee0">$interpolateProvider</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">endSymbol</span>(<span style="color: #00e5ee">']]'</span>);
    }]);
</pre></div>


<p style="margin: 15px 0;">
使用 <i style=" color: #d75100; font-style: normal; ">$interpolateProvider</i> 服务即可。
</p>

<a id="toc39" name="toc39"></a>
<h1 style=" -moz-border-radius: 5px; -webkit-border-radius: 5px; -moz-box-shadow: 3px 3px 5px #333; -webkit-box-shadow: 3px 3px 5px #333; box-shadow: 3px 3px 5px #333;  border-radius: 5px; background-color: #69ab01; padding: 4px; color: white; line-height: 1.3em; text-shadow: 2px 2px 2px black; margin: 20px auto; font-size: medium; clear: both;">11. AJAX</h1>

<p style="margin: 15px 0;">
ng 提供了基本的 AJAX 封装，你直接面对 promise 对象，使用起来还是很方便的。
</p>

<a id="toc40" name="toc40"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">11.1. HTTP请求</h2>

<p style="margin: 15px 0;">
基本的操作由 <i style=" color: #d75100; font-style: normal; ">$http</i> 服务提供。它的使用很简单，提供一些描述请求的参数，请求就出去了，然后返回一个扩充了 <i style=" color: #d75100; font-style: normal; ">success</i> 方法和 <i style=" color: #d75100; font-style: normal; ">error</i> 方法的 <i style=" color: #d75100; font-style: normal; ">promise</i> 对象（下节介绍），你可以在这个对象中添加需要的回调函数。
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">TestCtrl</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">$http</span>){
    <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">p</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$http</span>({
      <span style="color: #e0eee0">method</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'GET'</span>,
      <span style="color: #e0eee0">url</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'/json'</span>
    });
    <span style="color: #e0eee0">p</span>.<span style="color: #e0eee0">success</span>(<span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">response</span>, <span style="color: #e0eee0">status</span>, <span style="color: #e0eee0">headers</span>, <span style="color: #e0eee0">config</span>){
        <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">name</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">response</span>.<span style="color: #e0eee0">name</span>;
    });
  }
</pre></div>


<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">$http</i> 接受的配置项有：
</p>

<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li>method 方法
</li>
<li>url 路径
</li>
<li>params GET请求的参数
</li>
<li>data post请求的参数
</li>
<li>headers 头
</li>
<li>transformRequest 请求预处理函数
</li>
<li>transformResponse 响应预处理函数
</li>
<li>cache 缓存
</li>
<li>timeout 超时毫秒，超时的请求会被取消
</li>
<li>withCredentials 跨域安全策略的一个东西 
</li>
</ul>

<p style="margin: 15px 0;">
其中的 <i style=" color: #d75100; font-style: normal; ">transformRequest</i> 和 <i style=" color: #d75100; font-style: normal; ">transformResponse</i> 及 <i style=" color: #d75100; font-style: normal; ">headers</i> 已经有定义的，如果自定义则会覆盖默认定义：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;"><span style="color: gray; padding: 0 5px 0 5px"> 1</span>   <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">$config</span> <span style="color: #7fff00">=</span> <span style="color: #90ee90">this</span>.<span style="color: #e0eee0">defaults</span> <span style="color: #7fff00">=</span> {
<span style="color: gray; padding: 0 5px 0 5px"> 2</span>     <span style="color: #507080">// transform incoming response data</span>
<span style="color: gray; padding: 0 5px 0 5px"> 3</span>     <span style="color: #e0eee0">transformResponse</span><span style="color: #7fff00">:</span> [<span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">data</span>) {
<span style="color: gray; padding: 0 5px 0 5px"> 4</span>       <span style="color: #90ee90">if</span> (<span style="color: #e0eee0">isString</span>(<span style="color: #e0eee0">data</span>)) {
<span style="color: gray; padding: 0 5px 0 5px"> 5</span>         <span style="color: #507080">// strip json vulnerability protection prefix</span>
<span style="color: gray; padding: 0 5px 0 5px"> 6</span>         <span style="color: #e0eee0">data</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">data</span>.<span style="color: #e0eee0">replace</span>(<span style="color: #e0eee0">PROTECTION_PREFIX</span>, <span style="color: #00e5ee">''</span>);
<span style="color: gray; padding: 0 5px 0 5px"> 7</span>         <span style="color: #90ee90">if</span> (<span style="color: #e0eee0">JSON_START</span>.<span style="color: #e0eee0">test</span>(<span style="color: #e0eee0">data</span>) <span style="color: #7fff00">&amp;&amp;</span> <span style="color: #e0eee0">JSON_END</span>.<span style="color: #e0eee0">test</span>(<span style="color: #e0eee0">data</span>))
<span style="color: gray; padding: 0 5px 0 5px"> 8</span>           <span style="color: #e0eee0">data</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">fromJson</span>(<span style="color: #e0eee0">data</span>, <span style="color: #90ee90">true</span>);
<span style="color: gray; padding: 0 5px 0 5px"> 9</span>       }
<span style="color: gray; padding: 0 5px 0 5px">10</span>       <span style="color: #90ee90">return</span> <span style="color: #e0eee0">data</span>;
<span style="color: gray; padding: 0 5px 0 5px">11</span>     }],
<span style="color: gray; padding: 0 5px 0 5px">12</span>   
<span style="color: gray; padding: 0 5px 0 5px">13</span>     <span style="color: #507080">// transform outgoing request data</span>
<span style="color: gray; padding: 0 5px 0 5px">14</span>     <span style="color: #e0eee0">transformRequest</span><span style="color: #7fff00">:</span> [<span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">d</span>) {
<span style="color: gray; padding: 0 5px 0 5px">15</span>       <span style="color: #90ee90">return</span> <span style="color: #e0eee0">isObject</span>(<span style="color: #e0eee0">d</span>) <span style="color: #7fff00">&amp;&amp;</span> <span style="color: #7fff00">!</span><span style="color: #e0eee0">isFile</span>(<span style="color: #e0eee0">d</span>) <span style="color: #7fff00">?</span> <span style="color: #e0eee0">toJson</span>(<span style="color: #e0eee0">d</span>) <span style="color: #7fff00">:</span> <span style="color: #e0eee0">d</span>;
<span style="color: gray; padding: 0 5px 0 5px">16</span>     }],
<span style="color: gray; padding: 0 5px 0 5px">17</span>   
<span style="color: gray; padding: 0 5px 0 5px">18</span>     <span style="color: #507080">// default headers</span>
<span style="color: gray; padding: 0 5px 0 5px">19</span>     <span style="color: #e0eee0">headers</span><span style="color: #7fff00">:</span> {
<span style="color: gray; padding: 0 5px 0 5px">20</span>       <span style="color: #e0eee0">common</span><span style="color: #7fff00">:</span> {
<span style="color: gray; padding: 0 5px 0 5px">21</span>         <span style="color: #00e5ee">'Accept'</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'application/json, text/plain, */*'</span>,
<span style="color: gray; padding: 0 5px 0 5px">22</span>         <span style="color: #00e5ee">'X-Requested-With'</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'XMLHttpRequest'</span>
<span style="color: gray; padding: 0 5px 0 5px">23</span>       },
<span style="color: gray; padding: 0 5px 0 5px">24</span>       <span style="color: #e0eee0">post</span><span style="color: #7fff00">:</span> {<span style="color: #00e5ee">'Content-Type'</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'application/json;charset=utf-8'</span>},
<span style="color: gray; padding: 0 5px 0 5px">25</span>       <span style="color: #e0eee0">put</span><span style="color: #7fff00">:</span>  {<span style="color: #00e5ee">'Content-Type'</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'application/json;charset=utf-8'</span>}
<span style="color: gray; padding: 0 5px 0 5px">26</span>     }
<span style="color: gray; padding: 0 5px 0 5px">27</span>   };
</pre></div>


<p style="margin: 15px 0;">
<b style=" color: red; font-weight: normal; ">注意它默认的 POST 方法出去的 Content-Type</b>
</p>
<p style="margin: 15px 0;">
对于几个标准的 HTTP 方法，有对应的 shortcut ：
</p>

<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li>$http.delete(url, config)
</li>
<li>$http.get(url, config)
</li>
<li>$http.head(url, config)
</li>
<li>$http.jsonp(url, config)
</li>
<li>$http.post(url, data, config)
</li>
<li>$http.put(url, data, config)
</li>
</ul>

<p style="margin: 15px 0;">
注意其中的 JSONP 方法，在实现上会在页面中添加一个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">script</code> 标签，然后放出一个 GET 请求。你自己定义的，匿名回调函数，会被 ng 自已给一个全局变量。在定义请求，作为 GET 参数，你可以使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">JSON_CALLBACK</code> 这个字符串来暂时代替回调函数名，之后 ng 会为你替换成真正的函数名：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">p</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$http</span>({
    <span style="color: #e0eee0">method</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'JSONP'</span>,
    <span style="color: #e0eee0">url</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'/json'</span>,
    <span style="color: #e0eee0">params</span><span style="color: #7fff00">:</span> {<span style="color: #e0eee0">callback</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'JSON_CALLBACK'</span>}
  });
  <span style="color: #e0eee0">p</span>.<span style="color: #e0eee0">success</span>(<span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">response</span>, <span style="color: #e0eee0">status</span>, <span style="color: #e0eee0">headers</span>, <span style="color: #e0eee0">config</span>){
      <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">response</span>);
      <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">name</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">response</span>.<span style="color: #e0eee0">name</span>;
  });
</pre></div>


<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">$http</i> 有两个属性：
</p>

<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li>defaults 请求的全局配置
</li>
<li>pendingRequests 当前的请求队列状态
</li>
</ul>


<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">$http</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">defaults</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">transformRequest</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">function</span>(<span style="color: #e0eee0">data</span>){<span style="color: #e0eee0">console</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">log</span>(<span style="color: #00e5ee">'here'</span>); <span style="color: #90ee90">return</span> <span style="color: #e0eee0">data</span>;}
  <span style="color: #e0eee0">console</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">$http</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">pendingRequests</span>);
</pre></div>


<a id="toc41" name="toc41"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">11.2. 广义回调管理</h2>

<p style="margin: 15px 0;">
和其它框架一样， ng 提供了广义的异步回调管理的机制。 <i style=" color: #d75100; font-style: normal; ">$http</i> 服务是在其之上封装出来的。这个机制就是 ng 的 <i style=" color: #d75100; font-style: normal; ">$q</i> 服务。
</p>
<p style="margin: 15px 0;">
不过 ng 的这套机制总的来说实现得比较简单，按官方的说法，够用了。
</p>
<p style="margin: 15px 0;">
使用的方法，基本上是：
</p>

<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li>通过 <i style=" color: #d75100; font-style: normal; ">$q</i> 服务得到一个 <i style=" color: #d75100; font-style: normal; ">deferred</i> 实例
</li>
<li>通过 <i style=" color: #d75100; font-style: normal; ">deferred</i> 实例的 <i style=" color: #d75100; font-style: normal; ">promise</i> 属性得到一个 <i style=" color: #d75100; font-style: normal; ">promise</i> 对象
</li>
<li><i style=" color: #d75100; font-style: normal; ">promise</i> 对象负责定义回调函数
</li>
<li><i style=" color: #d75100; font-style: normal; ">deferred</i> 实例负责触发回调
</li>
</ul>


<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">TestCtrl</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$q</span>){
    <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">defer</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$q</span>.<span style="color: #e0eee0">defer</span>();
    <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">promise</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">defer</span>.<span style="color: #e0eee0">promise</span>;
    <span style="color: #e0eee0">promise</span>.<span style="color: #e0eee0">then</span>(<span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">data</span>){<span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #00e5ee">'ok, '</span> <span style="color: #7fff00">+</span> <span style="color: #e0eee0">data</span>)},
                 <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">data</span>){<span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #00e5ee">'error, '</span> <span style="color: #7fff00">+</span> <span style="color: #e0eee0">data</span>)});
    <span style="color: #507080">//defer.reject('xx');</span>
    <span style="color: #e0eee0">defer</span>.<span style="color: #e0eee0">resolve</span>(<span style="color: #00e5ee">'xx'</span>);
  }
</pre></div>


<p style="margin: 15px 0;">
了解了上面的东西，再分别看 <i style=" color: #d75100; font-style: normal; ">$q</i> ， <i style=" color: #d75100; font-style: normal; ">deferred</i> ， <i style=" color: #d75100; font-style: normal; ">promise</i> 这三个东西。
</p>

<a id="toc42" name="toc42"></a>
<h3 style=" font-size: small; margin: 0 auto; text-shadow: 1px 1px 1px gray; padding: 2px; color: #555;">11.2.1. $q</h3>

<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">$q</i> 有四个方法：
</p>

<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li><i style=" color: #d75100; font-style: normal; ">$q.all()</i> 合并多个 <i style=" color: #d75100; font-style: normal; ">promise</i> ，得到一个新的 <i style=" color: #d75100; font-style: normal; ">promise</i>
</li>
<li><i style=" color: #d75100; font-style: normal; ">$q.defer()</i> 返回一个 <i style=" color: #d75100; font-style: normal; ">deferred</i> 对象
</li>
<li><i style=" color: #d75100; font-style: normal; ">$q.reject()</i> 包装一个错误，以使回调链能正确处理下去
</li>
<li><i style=" color: #d75100; font-style: normal; ">$q.when()</i> 返回一个 <i style=" color: #d75100; font-style: normal; ">promise</i> 对象
</li>
</ul>

<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">$q.all()</i> 方法适用于并发场景很合适：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">TestCtrl</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$q</span>, <span style="color: #e0eee0">$http</span>){
    <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">p</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$http</span>.<span style="color: #e0eee0">get</span>(<span style="color: #00e5ee">'/json'</span>, {<span style="color: #e0eee0">params</span><span style="color: #7fff00">:</span> {<span style="color: #e0eee0">a</span><span style="color: #7fff00">:</span> <span style="color: #00ffff">1</span>}});
    <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">p2</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$http</span>.<span style="color: #e0eee0">get</span>(<span style="color: #00e5ee">'/json'</span>, {<span style="color: #e0eee0">params</span><span style="color: #7fff00">:</span> {<span style="color: #e0eee0">a</span><span style="color: #7fff00">:</span> <span style="color: #00ffff">2</span>}});
    <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">all</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$q</span>.<span style="color: #e0eee0">all</span>([<span style="color: #e0eee0">p</span>, <span style="color: #e0eee0">p2</span>]);
    <span style="color: #e0eee0">p</span>.<span style="color: #e0eee0">success</span>(<span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">res</span>){<span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #00e5ee">'here'</span>)});
    <span style="color: #e0eee0">all</span>.<span style="color: #e0eee0">then</span>(<span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">res</span>){<span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">res</span>[<span style="color: #00ffff">0</span>])});
  }
</pre></div>


<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">$q.reject()</i> 方法是在你捕捉异常之后，又要把这个异常在回调链中传下去时使用：
</p>
<p style="margin: 15px 0;">
要理解这东西，先看看 <i style=" color: #d75100; font-style: normal; ">promise</i> 的链式回调是如何运作的，看下面两段代码的区别：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">defer</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$q</span>.<span style="color: #e0eee0">defer</span>();
  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">p</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">defer</span>.<span style="color: #e0eee0">promise</span>;
  <span style="color: #e0eee0">p</span>.<span style="color: #e0eee0">then</span>(
    <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">data</span>){<span style="color: #90ee90">return</span> <span style="color: #00e5ee">'xxx'</span>}
  );
  <span style="color: #e0eee0">p</span>.<span style="color: #e0eee0">then</span>(
    <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">data</span>){<span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">data</span>)}
  );
  <span style="color: #e0eee0">defer</span>.<span style="color: #e0eee0">resolve</span>(<span style="color: #00e5ee">'123'</span>);
</pre></div>



<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">defer</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$q</span>.<span style="color: #e0eee0">defer</span>();
  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">p</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">defer</span>.<span style="color: #e0eee0">promise</span>;
  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">p2</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">p</span>.<span style="color: #e0eee0">then</span>(
    <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">data</span>){<span style="color: #90ee90">return</span> <span style="color: #00e5ee">'xxx'</span>}
  );
  <span style="color: #e0eee0">p2</span>.<span style="color: #e0eee0">then</span>(
    <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">data</span>){<span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">data</span>)}
  );
  <span style="color: #e0eee0">defer</span>.<span style="color: #e0eee0">resolve</span>(<span style="color: #00e5ee">'123'</span>);
</pre></div>


<p style="margin: 15px 0;">
从模型上看，前者是“并发”，后者才是“链式”。
</p>
<p style="margin: 15px 0;">
而 <i style=" color: #d75100; font-style: normal; ">$q.reject()</i> 的作用就是触发后链的 <i style=" color: #d75100; font-style: normal; ">error</i> 回调：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">defer</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$q</span>.<span style="color: #e0eee0">defer</span>();
  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">p</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">defer</span>.<span style="color: #e0eee0">promise</span>;
  <span style="color: #e0eee0">p</span>.<span style="color: #e0eee0">then</span>(
    <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">data</span>){<span style="color: #90ee90">return</span> <span style="color: #e0eee0">data</span>},
    <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">data</span>){<span style="color: #90ee90">return</span> <span style="color: #e0eee0">$q</span>.<span style="color: #e0eee0">reject</span>(<span style="color: #e0eee0">data</span>)}
  ).
  <span style="color: #e0eee0">then</span>(
    <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">data</span>){<span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #00e5ee">'ok, '</span> <span style="color: #7fff00">+</span> <span style="color: #e0eee0">data</span>)},
    <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">data</span>){<span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #00e5ee">'error, '</span> <span style="color: #7fff00">+</span> <span style="color: #e0eee0">data</span>)}
  )
  <span style="color: #e0eee0">defer</span>.<span style="color: #e0eee0">reject</span>(<span style="color: #00e5ee">'123'</span>);
</pre></div>


<p style="margin: 15px 0;">
最后的 <i style=" color: #d75100; font-style: normal; ">$q.when()</i> 是把数据封装成 <i style=" color: #d75100; font-style: normal; ">promise</i> 对象：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">p</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$q</span>.<span style="color: #e0eee0">when</span>(<span style="color: #00ffff">0</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">data</span>){<span style="color: #90ee90">return</span> <span style="color: #e0eee0">data</span>},
                     <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">data</span>){<span style="color: #90ee90">return</span> <span style="color: #e0eee0">data</span>});
  <span style="color: #e0eee0">p</span>.<span style="color: #e0eee0">then</span>(
    <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">data</span>){<span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #00e5ee">'ok, '</span> <span style="color: #7fff00">+</span> <span style="color: #e0eee0">data</span>)},
    <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">data</span>){<span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #00e5ee">'error, '</span> <span style="color: #7fff00">+</span> <span style="color: #e0eee0">data</span>)}
  );
</pre></div>


<a id="toc43" name="toc43"></a>
<h3 style=" font-size: small; margin: 0 auto; text-shadow: 1px 1px 1px gray; padding: 2px; color: #555;">11.2.2. deferred</h3>

<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">deferred</i> 对象有两个方法一个属性。
</p>

<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li><i style=" color: #d75100; font-style: normal; ">promise</i> 属性就是返回一个 <i style=" color: #d75100; font-style: normal; ">promise</i> 对象的。
</li>
<li><i style=" color: #d75100; font-style: normal; ">resolve()</i> 成功回调
</li>
<li><i style=" color: #d75100; font-style: normal; ">reject()</i> 失败回调
</li>
</ul>


<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">defer</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$q</span>.<span style="color: #e0eee0">defer</span>();
  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">promise</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">defer</span>.<span style="color: #e0eee0">promise</span>;
  <span style="color: #e0eee0">promise</span>.<span style="color: #e0eee0">then</span>(<span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">data</span>){<span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #00e5ee">'ok, '</span> <span style="color: #7fff00">+</span> <span style="color: #e0eee0">data</span>)},
               <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">data</span>){<span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #00e5ee">'error, '</span> <span style="color: #7fff00">+</span> <span style="color: #e0eee0">data</span>)});
  <span style="color: #507080">//defer.reject('xx');</span>
  <span style="color: #e0eee0">defer</span>.<span style="color: #e0eee0">resolve</span>(<span style="color: #00e5ee">'xx'</span>);
</pre></div>


<a id="toc44" name="toc44"></a>
<h3 style=" font-size: small; margin: 0 auto; text-shadow: 1px 1px 1px gray; padding: 2px; color: #555;">11.2.3. promise</h3>

<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">promise</i> 对象只有 <i style=" color: #d75100; font-style: normal; ">then()</i> 一个方法，注册成功回调函数和失败回调函数，再返回一个 <i style=" color: #d75100; font-style: normal; ">promise</i> 对象，以用于链式调用。
</p>

<a id="toc45" name="toc45"></a>
<h1 style=" -moz-border-radius: 5px; -webkit-border-radius: 5px; -moz-box-shadow: 3px 3px 5px #333; -webkit-box-shadow: 3px 3px 5px #333; box-shadow: 3px 3px 5px #333;  border-radius: 5px; background-color: #69ab01; padding: 4px; color: white; line-height: 1.3em; text-shadow: 2px 2px 2px black; margin: 20px auto; font-size: medium; clear: both;">12. 工具函数</h1>

<a id="toc46" name="toc46"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">12.1. 上下文绑定</h2>

<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">angular.bind</i> 是用来进行上下文绑定，参数动态绑定的工具函数。
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">var</span> <span style="color: #e0eee0">f</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">bind</span>({<span style="color: #e0eee0">a:</span> <span style="color: #00e5ee">'xx'</span>},
    <span style="color: #e0eee0">function</span>(){
      <span style="color: #e0eee0">console</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">this</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">a</span>);
    }
  );
  <span style="color: #e0eee0">f</span>();
</pre></div>


<p style="margin: 15px 0;">
参数动态绑定：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">var</span> <span style="color: #e0eee0">f</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">function</span>(<span style="color: #e0eee0">x</span>){<span style="color: #e0eee0">console</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">x</span>)}
  <span style="color: #e0eee0">angular</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">bind</span>({}, <span style="color: #e0eee0">f</span>, <span style="color: #00e5ee">'x'</span>)();
</pre></div>


<a id="toc47" name="toc47"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">12.2. 对象处理</h2>

<p style="margin: 15px 0;">
对象复制： <i style=" color: #d75100; font-style: normal; ">angular.copy()</i>
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">var</span> <span style="color: #e0eee0">a</span> <span style="color: #7fff00">=</span> {<span style="color: #00e5ee">'x'</span>: <span style="color: #00e5ee">'123'</span>};
  <span style="color: #e0eee0">var</span> <span style="color: #e0eee0">b</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">copy</span>(<span style="color: #e0eee0">a</span>);
  <span style="color: #e0eee0">a</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">x</span> <span style="color: #7fff00">=</span> <span style="color: #00e5ee">'456'</span>;
  <span style="color: #e0eee0">console</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">b</span>);
</pre></div>


<p style="margin: 15px 0;">
对象聚合： <i style=" color: #d75100; font-style: normal; ">angular.extend()</i>
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">var</span> <span style="color: #e0eee0">a</span> <span style="color: #7fff00">=</span> {<span style="color: #00e5ee">'x'</span>: <span style="color: #00e5ee">'123'</span>};
  <span style="color: #e0eee0">var</span> <span style="color: #e0eee0">b</span> <span style="color: #7fff00">=</span> {<span style="color: #00e5ee">'xx'</span>: <span style="color: #00e5ee">'456'</span>};
  <span style="color: #e0eee0">angular</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">extend</span>(<span style="color: #e0eee0">b</span>, <span style="color: #e0eee0">a</span>);
  <span style="color: #e0eee0">console</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">b</span>);
</pre></div>


<p style="margin: 15px 0;">
空函数： <i style=" color: #d75100; font-style: normal; ">angular.noop()</i>
</p>
<p style="margin: 15px 0;">
大小写转换： <i style=" color: #d75100; font-style: normal; ">angular.lowercase()</i> 和 <i style=" color: #d75100; font-style: normal; ">angular.uppercase()</i> 
</p>
<p style="margin: 15px 0;">
JSON转换： <i style=" color: #d75100; font-style: normal; ">angular.fromJson()</i> 和 <i style=" color: #d75100; font-style: normal; ">angular.toJson()</i> 
</p>
<p style="margin: 15px 0;">
遍历： <i style=" color: #d75100; font-style: normal; ">angular.forEach()</i> ，支持列表和对象：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">var</span> <span style="color: #e0eee0">l</span> <span style="color: #7fff00">=</span> {<span style="color: #e0eee0">a:</span> <span style="color: #00e5ee">'1'</span>, <span style="color: #e0eee0">b:</span> <span style="color: #00e5ee">'2'</span>};
  <span style="color: #e0eee0">angular</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">forEach</span>(<span style="color: #e0eee0">l</span>, <span style="color: #e0eee0">function</span>(<span style="color: #e0eee0">v</span>, <span style="color: #e0eee0">k</span>){<span style="color: #e0eee0">console</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">k</span> <span style="color: #7fff00">+</span> <span style="color: #00e5ee">': '</span> <span style="color: #7fff00">+</span> <span style="color: #e0eee0">v</span>)});
  
  <span style="color: #e0eee0">var</span> <span style="color: #e0eee0">l</span> <span style="color: #7fff00">=</span> [<span style="color: #00e5ee">'a'</span>, <span style="color: #00e5ee">'b'</span>, <span style="color: #00e5ee">'c'</span>];
  <span style="color: #e0eee0">angular</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">forEach</span>(<span style="color: #e0eee0">l</span>, <span style="color: #e0eee0">function</span>(<span style="color: #e0eee0">v</span>, <span style="color: #e0eee0">i</span>, <span style="color: #e0eee0">o</span>){<span style="color: #e0eee0">console</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">v</span>)});
  
  <span style="color: #e0eee0">var</span> <span style="color: #e0eee0">context</span> <span style="color: #7fff00">=</span> {<span style="color: #00e5ee">'t'</span>: <span style="color: #00e5ee">'xx'</span>};
  <span style="color: #e0eee0">angular</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">forEach</span>(<span style="color: #e0eee0">l</span>, <span style="color: #e0eee0">function</span>(<span style="color: #e0eee0">v</span>, <span style="color: #e0eee0">i</span>, <span style="color: #e0eee0">o</span>){<span style="color: #e0eee0">console</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">this</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">t</span>)}, <span style="color: #e0eee0">context</span>);
</pre></div>


<a id="toc48" name="toc48"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">12.3. 类型判定</h2>

<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li>angular.isArray
</li>
<li>angular.isDate
</li>
<li>angular.isDefined
</li>
<li>angular.isElement
</li>
<li>angular.isFunction
</li>
<li>angular.isNumber
</li>
<li>angular.isObject
</li>
<li>angular.isString
</li>
<li>angular.isUndefined
</li>
</ul>

<a id="toc49" name="toc49"></a>
<h1 style=" -moz-border-radius: 5px; -webkit-border-radius: 5px; -moz-box-shadow: 3px 3px 5px #333; -webkit-box-shadow: 3px 3px 5px #333; box-shadow: 3px 3px 5px #333;  border-radius: 5px; background-color: #69ab01; padding: 4px; color: white; line-height: 1.3em; text-shadow: 2px 2px 2px black; margin: 20px auto; font-size: medium; clear: both;">13. 其它服务</h1>

<a id="toc50" name="toc50"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">13.1. 日志</h2>

<p style="margin: 15px 0;">
ng 提供 <i style=" color: #d75100; font-style: normal; ">$log</i> 这个服务用于向终端输出相关信息：
</p>

<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li>error()
</li>
<li>info()
</li>
<li>log()
</li>
<li>warn()
</li>
</ul>


<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">TestCtrl</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$log</span>){
    <span style="color: #e0eee0">$log</span>.<span style="color: #e0eee0">error</span>(<span style="color: #00e5ee">'error'</span>);
    <span style="color: #e0eee0">$log</span>.<span style="color: #e0eee0">info</span>(<span style="color: #00e5ee">'info'</span>);
    <span style="color: #e0eee0">$log</span>.<span style="color: #e0eee0">log</span>(<span style="color: #00e5ee">'log'</span>);
    <span style="color: #e0eee0">$log</span>.<span style="color: #e0eee0">warn</span>(<span style="color: #00e5ee">'warn'</span>);
  }
</pre></div>


<a id="toc51" name="toc51"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">13.2. 缓存</h2>

<p style="margin: 15px 0;">
ng 提供了一个简单封装了缓存机制 <i style=" color: #d75100; font-style: normal; ">$cacheFactory</i> ，可以用来作为数据容器：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">TestCtrl</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">$cacheFactory</span>){
    <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">cache</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$cacheFactory</span>(<span style="color: #00e5ee">'s_'</span> <span style="color: #7fff00">+</span> <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">$id</span>, {<span style="color: #e0eee0">capacity</span><span style="color: #7fff00">:</span> <span style="color: #00ffff">3</span>});
  
    <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">show</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(){
      <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">cache</span>.<span style="color: #e0eee0">get</span>(<span style="color: #00e5ee">'a'</span>));
      <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">cache</span>.<span style="color: #e0eee0">info</span>());
    }
  
    <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">set</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(){
      <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">cache</span>.<span style="color: #e0eee0">put</span>((<span style="color: #90ee90">new</span> <span style="color: #e0eee0">Date</span>()).<span style="color: #e0eee0">valueOf</span>(), <span style="color: #00e5ee">'ok'</span>);
    }
  }
</pre></div>


<p style="margin: 15px 0;">
调用时，第一个参数是 id ，第二个参数是配置项，目前支持 <i style=" color: #d75100; font-style: normal; ">capacity</i> 参数，用以设置缓存能容留的最大条目数。超过这个个数，则自动清除较旧的条目。
</p>
<p style="margin: 15px 0;">
缓存实例的方法：
</p>

<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li><i style=" color: #d75100; font-style: normal; ">info()</i> 获取 id , size 信息
</li>
<li><i style=" color: #d75100; font-style: normal; ">put(k, v)</i> 设置新条目
</li>
<li><i style=" color: #d75100; font-style: normal; ">get(k)</i> 获取条目
</li>
<li><i style=" color: #d75100; font-style: normal; ">remove(k)</i> 删除条目
</li>
<li><i style=" color: #d75100; font-style: normal; ">removeAll()</i> 删除所有条目
</li>
<li><i style=" color: #d75100; font-style: normal; ">destroy()</i> 删除对本实例的引用
</li>
</ul>

<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">$http</i> 的调用当中，有一个 <i style=" color: #d75100; font-style: normal; ">cache</i> 参数，值为 <i style=" color: #d75100; font-style: normal; ">true</i> 时为自动维护的缓存。值也可以设置为一个 cache 实例。
</p>

<a id="toc52" name="toc52"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">13.3. 计时器</h2>

<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">$timeout</i> 服务是 ng 对 <i style=" color: #d75100; font-style: normal; ">window.setTimeout()</i> 的封装，它使用 <i style=" color: #d75100; font-style: normal; ">promise</i> 统一了计时器的回调行为：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">var</span> <span style="color: #e0eee0">TestCtrl</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">function</span>(<span style="color: #e0eee0">$timeout</span>){
    <span style="color: #e0eee0">var</span> <span style="color: #e0eee0">p</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$timeout</span>(<span style="color: #e0eee0">function</span>(){<span style="color: #e0eee0">console</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">log</span>(<span style="color: #00e5ee">'haha'</span>)}, <span style="color: #00ffff">5000</span>);
    <span style="color: #e0eee0">p</span><span style="color: #7fff00">.</span><span style="color: #90ee90">then</span>(<span style="color: #e0eee0">function</span>(){<span style="color: #e0eee0">console</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">log</span>(<span style="color: #00e5ee">'x'</span>)});
    <span style="color: #00e5ee">//</span><span style="color: #e0eee0">$timeout</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">cancel</span>(<span style="color: #e0eee0">p</span>);
  }
</pre></div>


<p style="margin: 15px 0;">
使用 <i style=" color: #d75100; font-style: normal; ">$timeout.cancel()</i> 可以取消计时器。
</p>

<a id="toc53" name="toc53"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">13.4. 表达式函数化</h2>

<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">$parse</i> 这个服务，为 js 提供了类似于 Python 中 <i style=" color: #d75100; font-style: normal; ">@property</i> 的能力：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">TestCtrl</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">$parse</span>){
    <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">get_name</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$parse</span>(<span style="color: #00e5ee">'name'</span>);
    <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">show</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(){<span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">get_name</span>(<span style="color: #e0eee0">$scope</span>))}
    <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">set</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(){<span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">name</span> <span style="color: #7fff00">=</span> <span style="color: #00e5ee">'123'</span>}
  }
</pre></div>


<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">$parse</i> 返回一个函数，调用这个函数时，可以传两个参数，第一个作用域，第二个是变量集，后者常用于覆盖前者的变量：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">get_name</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$parse</span>(<span style="color: #00e5ee">'name'</span>);
  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">r</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">get_name</span>({<span style="color: #e0eee0">name</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'xx'</span>}, {<span style="color: #e0eee0">name</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'abc'</span>});
  <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">r</span>);
</pre></div>


<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">$parse</i> 返回的函数，也提供了相应的 assign 功能，可以为表达式赋值（如果可以的话）：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">get_name</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$parse</span>(<span style="color: #00e5ee">'name'</span>);
  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">set_name</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">get_name</span>.<span style="color: #e0eee0">assign</span>;
  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">r</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">get_name</span>({<span style="color: #e0eee0">name</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'xx'</span>}, {<span style="color: #e0eee0">name</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'abc'</span>});
  <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">r</span>);
  
  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">s</span> <span style="color: #7fff00">=</span> {}
  <span style="color: #e0eee0">set_name</span>(<span style="color: #e0eee0">s</span>, <span style="color: #00e5ee">'123'</span>);
  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">r</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">get_name</span>(<span style="color: #e0eee0">s</span>);
  <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">r</span>);
</pre></div>


<a id="toc54" name="toc54"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">13.5. 模板单独使用</h2>

<p style="margin: 15px 0;">
ng 中的模板是很重要，也很强大的一个机制，自然少不了单独运用它的方法。不过，即使是单独使用，也是和 DOM 紧密相关的程度：
</p>

<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li>定义时必须是有 HTML 标签包裹的，这样才能创建 DOM 节点
</li>
<li>渲染时必须传入 <i style=" color: #d75100; font-style: normal; ">$scope</i> 
</li>
</ul>

<p style="margin: 15px 0;">
之后使用 <i style=" color: #d75100; font-style: normal; ">$compile</i> 就可以得到一个渲染好的节点对象了。当然， <i style=" color: #d75100; font-style: normal; ">$compile</i> 还要做其它一些工作，指令处理什么的。
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">TestCtrl</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">$element</span>,<span style="color: #e0eee0">$compile</span>){
    <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">a</span> <span style="color: #7fff00">=</span> <span style="color: #00e5ee">'123'</span>;
    <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">set</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(){
      <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">tpl</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$compile</span>(<span style="color: #00e5ee">'&lt;p&gt;hello {{ a }}&lt;/p&gt;'</span>);
      <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">e</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">tpl</span>(<span style="color: #e0eee0">$scope</span>);
      <span style="color: #e0eee0">$element</span>.<span style="color: #e0eee0">append</span>(<span style="color: #e0eee0">e</span>);
    }
  }
</pre></div>


<a id="toc55" name="toc55"></a>
<h1 style=" -moz-border-radius: 5px; -webkit-border-radius: 5px; -moz-box-shadow: 3px 3px 5px #333; -webkit-box-shadow: 3px 3px 5px #333; box-shadow: 3px 3px 5px #333;  border-radius: 5px; background-color: #69ab01; padding: 4px; color: white; line-height: 1.3em; text-shadow: 2px 2px 2px black; margin: 20px auto; font-size: medium; clear: both;">14. 自定义模块和服务</h1>

<a id="toc56" name="toc56"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">14.1. 模块和服务的概念与关系</h2>

<p style="margin: 15px 0;">
总的来说，模块是组织业务的一个框框，在一个模块当中定义多个服务。当你引入了一个模块的时候，就可以使用这个模块提供的一种或多种服务了。
</p>
<p style="margin: 15px 0;">
比如 <i style=" color: #d75100; font-style: normal; ">AngularJS</i> 本身的一个默认模块叫做 <i style=" color: #d75100; font-style: normal; ">ng</i> ，它提供了 <i style=" color: #d75100; font-style: normal; ">$http</i> ， <i style=" color: #d75100; font-style: normal; ">$q</i> 等等服务。
</p>
<p style="margin: 15px 0;">
服务只是模块提供的多种机制中的一种，其它的还有命令（ <i style=" color: #d75100; font-style: normal; ">directive</i> ），过滤器（ <i style=" color: #d75100; font-style: normal; ">filter</i> ），及其它配置信息。
</p>
<p style="margin: 15px 0;">
然后在额外的 js 文件中有一个附加的模块叫做 <i style=" color: #d75100; font-style: normal; ">ngResource</i> ， 它提供了一个 <i style=" color: #d75100; font-style: normal; ">$resource</i> 服务。
</p>
<p style="margin: 15px 0;">
定义时，我们可以在已有的模块中新定义一个服务，也可以先新定义一个模块，然后在新模块中定义新服务。
</p>
<p style="margin: 15px 0;">
使用时，服务是需要显式地的声明依赖（引入）关系的，而服务则可以让 <i style=" color: #d75100; font-style: normal; ">ng</i> 自动地做注入，然后直接使用。
</p>

<a id="toc57" name="toc57"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">14.2. 定义模块</h2>

<p style="margin: 15px 0;">
定义模块的方法是使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">angular.module</code> 。调用时声明了对其它模块的依赖，并定义了“初始化”函数。
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">my_module</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'MyModule'</span>, [], <span style="color: #bcd2ee">function</span>(){
      <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #00e5ee">'here'</span>);
  });
</pre></div>


<p style="margin: 15px 0;">
这段代码定义了一个叫做 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">MyModule</code> 的模块， <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">my_module</code> 这个引用可以在接下来做其它的一些事，比如定义服务。
</p>

<a id="toc58" name="toc58"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">14.3. 定义服务</h2>

<p style="margin: 15px 0;">
服务本身是一个任意的对象。但是 <i style=" color: #d75100; font-style: normal; ">ng</i> 提供服务的过程涉及它的依赖注入机制。在这里呢，就要先介绍一下叫 <i style=" color: #d75100; font-style: normal; ">provider</i> 的东西。
</p>
<p style="margin: 15px 0;">
简单来说， <i style=" color: #d75100; font-style: normal; ">provider</i> 是被“注入控制器”使用的一个对象，注入机制通过调用一个 <i style=" color: #d75100; font-style: normal; ">provider</i> 的 <i style=" color: #d75100; font-style: normal; ">$get()</i> 方法，把得到的东西作为参数进行相关调用（比如把得到的服务作为一个 <i style=" color: #d75100; font-style: normal; ">Controller</i> 的参数）。
</p>
<p style="margin: 15px 0;">
在这里“服务”的概念就比较不明确，对使用而言，服务仅指 <i style=" color: #d75100; font-style: normal; ">$get()</i> 方法返回的东西，但是在整体机制上，服务又要指提供了 <i style=" color: #d75100; font-style: normal; ">$get()</i> 方法的整个对象。
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #507080">//这是一个provider</span>
  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">pp</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(){
    <span style="color: #90ee90">this</span>.<span style="color: #e0eee0">$get</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(){
      <span style="color: #90ee90">return</span> {<span style="color: #00e5ee">'haha'</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'123'</span>};
    }
  }
  
  <span style="color: #507080">//我在模块的初始化过程当中, 定义了一个叫 PP 的服务</span>
  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">app</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'Demo'</span>, [], <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$provide</span>){
    <span style="color: #e0eee0">$provide</span>.<span style="color: #e0eee0">provider</span>(<span style="color: #00e5ee">'PP'</span>, <span style="color: #e0eee0">pp</span>);
  });
  
  <span style="color: #507080">//PP服务实际上就是 pp 这个 provider 的 $get() 方法返回的东西</span>
  <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">controller</span>(<span style="color: #00e5ee">'TestCtrl'</span>,
    <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">PP</span>){
      <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">PP</span>);
    }
  );
</pre></div>


<p style="margin: 15px 0;">
上面的代码是一种定义服务的方法，当然， <i style=" color: #d75100; font-style: normal; ">ng</i> 还有相关的 shortcut， <i style=" color: #d75100; font-style: normal; ">ng</i> 总有很多 shortcut 。
</p>
<p style="margin: 15px 0;">
第一个是 <i style=" color: #d75100; font-style: normal; ">factory</i> 方法，由 <i style=" color: #d75100; font-style: normal; ">$provide</i> 提供， <i style=" color: #d75100; font-style: normal; ">module</i> 的 <i style=" color: #d75100; font-style: normal; ">factory</i> 是一个引用，作用一样。这个方法直接把一个函数当成是一个对象的 <i style=" color: #d75100; font-style: normal; ">$get()</i> 方法，这样你就不用显式地定义一个 <i style=" color: #d75100; font-style: normal; ">provider</i> 了：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">app</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'Demo'</span>, [], <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$provide</span>){
    <span style="color: #e0eee0">$provide</span>.<span style="color: #e0eee0">factory</span>(<span style="color: #00e5ee">'PP'</span>, <span style="color: #bcd2ee">function</span>(){
      <span style="color: #90ee90">return</span> {<span style="color: #00e5ee">'hello'</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'123'</span>};
    });
  });
  <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">controller</span>(<span style="color: #00e5ee">'TestCtrl'</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">PP</span>){ <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">PP</span>) });
</pre></div>


<p style="margin: 15px 0;">
在 <i style=" color: #d75100; font-style: normal; ">module</i> 中使用：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">app</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'Demo'</span>, [], <span style="color: #bcd2ee">function</span>(){ });
  <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">factory</span>(<span style="color: #00e5ee">'PP'</span>, <span style="color: #bcd2ee">function</span>(){<span style="color: #90ee90">return</span> {<span style="color: #00e5ee">'abc'</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'123'</span>}});
  <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">controller</span>(<span style="color: #00e5ee">'TestCtrl'</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">PP</span>){ <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">PP</span>) });
</pre></div>


<p style="margin: 15px 0;">
第二个是 <i style=" color: #d75100; font-style: normal; ">service</i> 方法，也是由 <i style=" color: #d75100; font-style: normal; ">$provide</i> 提供， <i style=" color: #d75100; font-style: normal; ">module</i> 中有对它的同名引用。 <i style=" color: #d75100; font-style: normal; ">service</i> 和 <i style=" color: #d75100; font-style: normal; ">factory</i> 的区别在于，前者是要求提供一个“构造方法”，后者是要求提供 <i style=" color: #d75100; font-style: normal; ">$get()</i> 方法。意思就是，前者一定是得到一个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">object</code> ，后者可以是一个数字或字符串。它们的关系大概是：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">app</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'Demo'</span>, [], <span style="color: #bcd2ee">function</span>(){ });
  <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">service</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">name</span>, <span style="color: #e0eee0">constructor</span>){
    <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">factory</span>(<span style="color: #e0eee0">name</span>, <span style="color: #bcd2ee">function</span>(){
      <span style="color: #90ee90">return</span> (<span style="color: #90ee90">new</span> <span style="color: #e0eee0">constructor</span>());
    });
  }
</pre></div>


<p style="margin: 15px 0;">
这里插一句，js 中 <i style=" color: #d75100; font-style: normal; ">new</i> 的作用，以 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">new a()</code> 为例，过程相当于：
</p>

<ol style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li>创建一个空对象 obj
</li>
<li>把 obj 绑定到 a 函数的上下文当中（即 a 中的 this 现在指向 obj ）
</li>
<li>执行 a 函数
</li>
<li>返回 obj 
</li>
</ol>

<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">service</i> 方法的使用就很简单了：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">app</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'Demo'</span>, [], <span style="color: #bcd2ee">function</span>(){ });
  <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">service</span>(<span style="color: #00e5ee">'PP'</span>, <span style="color: #bcd2ee">function</span>(){
    <span style="color: #90ee90">this</span>.<span style="color: #e0eee0">abc</span> <span style="color: #7fff00">=</span> <span style="color: #00e5ee">'123'</span>;
  });
  <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">controller</span>(<span style="color: #00e5ee">'TestCtrl'</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">PP</span>){ <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">PP</span>) });
</pre></div>


<a id="toc59" name="toc59"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">14.4. 引入模块并使用服务</h2>

<p style="margin: 15px 0;">
结合上面的“定义模块”和“定义服务”，我们可以方便地组织自己的额外代码：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'MyModule'</span>, [], <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$provide</span>){
    <span style="color: #e0eee0">$provide</span>.<span style="color: #e0eee0">factory</span>(<span style="color: #00e5ee">'S1'</span>, <span style="color: #bcd2ee">function</span>(){
      <span style="color: #90ee90">return</span> <span style="color: #00e5ee">'I am S1'</span>;
    });
    <span style="color: #e0eee0">$provide</span>.<span style="color: #e0eee0">factory</span>(<span style="color: #00e5ee">'S2'</span>, <span style="color: #bcd2ee">function</span>(){
      <span style="color: #90ee90">return</span> {<span style="color: #e0eee0">see</span><span style="color: #7fff00">:</span> <span style="color: #bcd2ee">function</span>(){<span style="color: #90ee90">return</span> <span style="color: #00e5ee">'I am S2'</span>}}
    });
  });
  
  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">app</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'Demo'</span>, [<span style="color: #00e5ee">'MyModule'</span>], <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">noop</span>);
  <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">controller</span>(<span style="color: #00e5ee">'TestCtrl'</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">S1</span>, <span style="color: #e0eee0">S2</span>){
    <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">S1</span>)
    <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">S2</span>.<span style="color: #e0eee0">see</span>())
  });
</pre></div>


<a id="toc60" name="toc60"></a>
<h1 style=" -moz-border-radius: 5px; -webkit-border-radius: 5px; -moz-box-shadow: 3px 3px 5px #333; -webkit-box-shadow: 3px 3px 5px #333; box-shadow: 3px 3px 5px #333;  border-radius: 5px; background-color: #69ab01; padding: 4px; color: white; line-height: 1.3em; text-shadow: 2px 2px 2px black; margin: 20px auto; font-size: medium; clear: both;">15. 附加模块 ngResource</h1>

<a id="toc61" name="toc61"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">15.1. 使用引入与整体概念</h2>

<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">ngResource</i> 这个是 <i style=" color: #d75100; font-style: normal; ">ng</i> 官方提供的一个附加模块。附加的意思就是，如果你打算用它，那么你需要引入一人单独的 js 文件，然后在声明“根模块”时注明依赖的 <i style=" color: #d75100; font-style: normal; ">ngResource</i> 模块，接着就可以使用它提供的 <i style=" color: #d75100; font-style: normal; ">$resource</i> 服务了。完整的过程形如：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #507080">&lt;!DOCTYPE html&gt;</span>
  <span style="color: #e0eee0">&lt;html</span> <span style="color: #e0eee0">ng-app=</span><span style="color: #00e5ee">"Demo"</span><span style="color: #e0eee0">&gt;</span>
  <span style="color: #e0eee0">&lt;head&gt;</span>
  <span style="color: #e0eee0">&lt;meta</span> <span style="color: #e0eee0">charset=</span><span style="color: #00e5ee">"utf-8"</span> <span style="color: #e0eee0">/&gt;</span>
  <span style="color: #e0eee0">&lt;title&gt;</span>AngularJS<span style="color: #e0eee0">&lt;/title&gt;</span>
  <span style="color: #e0eee0">&lt;script type=</span><span style="color: #00e5ee">"text/javascript"</span> <span style="color: #e0eee0">src=</span><span style="color: #00e5ee">"http://ajax.googleapis.com/ajax/libs/angularjs/1.0.3/angular.min.js"</span><span style="color: #e0eee0">&gt;&lt;/script&gt;</span>
  <span style="color: #e0eee0">&lt;script type=</span><span style="color: #00e5ee">"text/javascript"</span> <span style="color: #e0eee0">src=</span><span style="color: #00e5ee">"http://ajax.googleapis.com/ajax/libs/angularjs/1.0.3/angular-resource.js"</span><span style="color: #e0eee0">&gt;&lt;/script&gt;</span>
  <span style="color: #e0eee0">&lt;/head&gt;</span>
  <span style="color: #e0eee0">&lt;body&gt;</span>
  
    <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span><span style="color: #e0eee0">&gt;&lt;/div&gt;</span>
  
  
  <span style="color: #e0eee0">&lt;script type=</span><span style="color: #00e5ee">"text/javascript"</span> <span style="color: #e0eee0">charset=</span><span style="color: #00e5ee">"utf-8"</span><span style="color: #e0eee0">&gt;</span>
  
  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">app</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'Demo'</span>, [<span style="color: #00e5ee">'ngResource'</span>], <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">noop</span>);
  <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">controller</span>(<span style="color: #00e5ee">'TestCtrl'</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">$resource</span>){
    <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">$resource</span>);
  });
  
  <span style="color: #e0eee0">&lt;/script&gt;</span>
  <span style="color: #e0eee0">&lt;/body&gt;</span>
  <span style="color: #e0eee0">&lt;/html&gt;</span>
</pre></div>


<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">$resource</i> 服务，整体上来说，比较像是使用类似 ORM 的方式来包装了 AJAX 调用。区别就是 ORM 是操作数据库，即拼出 SQL 语句之后，作 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">execute</code> 方法调用。而 <i style=" color: #d75100; font-style: normal; ">$resource</i> 的方式是构造出 AJAX 请求，然后发出请求。同时，AJAX 请求是需要回调处理的，这方面， <i style=" color: #d75100; font-style: normal; ">$resource</i> 的机制可以使你在一些时候省掉回调处理，当然，是否作回调处理在于业务情形及容错需求了。
</p>
<p style="margin: 15px 0;">
使用上 <i style=" color: #d75100; font-style: normal; ">$resource</i> 分成了“类”与“实例”这两个层面。一般地，类的方法调用就是直观的调用形式，通常会返回一个对象，这个对象即为“实例”。
</p>
<p style="margin: 15px 0;">
“实例”贯穿整个服务的使用过程。“实例”的数据是填充方式，即因为异步关系，回调函数没有执行时，实例已经存在，只是可能它还没有相关数据，回调执行之后，相关数据被填充到实例对象当中。实例的方法一般就是在类方法名前加一个 <i style=" color: #d75100; font-style: normal; ">$</i> ，调用上，根据定义，实例数据可能会做一些自动的参数填充，这点是区别实例与类的调用上的不同。
</p>
<p style="margin: 15px 0;">
好吧，上面这些话可能需要在看了接下来的内容之后再回过来理解。
</p>

<a id="toc62" name="toc62"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">15.2. 基本定义</h2>

<p style="margin: 15px 0;">
就像使用 ORM 一般要先定义 Model 一样，使用 <i style=" color: #d75100; font-style: normal; ">$resource</i> 需要先定义“资源”，也就是先定义一些 HTTP 请求。
</p>
<p style="margin: 15px 0;">
在业务场景上，我们假设为，我们需要操作“书”这个实体，包括创建create，获取详情read，修改update，删除delete，批量获取multi，共五个操作方法。实体属性有：唯一标识id，标题title，作者author。
</p>
<p style="margin: 15px 0;">
我们把这些操作定义成 <i style=" color: #d75100; font-style: normal; ">$resource</i> 的资源：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">app</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'Demo'</span>, [<span style="color: #00e5ee">'ngResource'</span>], <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">noop</span>);
  <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">controller</span>(<span style="color: #00e5ee">'BookCtrl'</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">$resource</span>){
    <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">actions</span> <span style="color: #7fff00">=</span> {
      <span style="color: #e0eee0">create</span><span style="color: #7fff00">:</span> {<span style="color: #e0eee0">method</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'POST'</span>, <span style="color: #e0eee0">params</span><span style="color: #7fff00">:</span> {<span style="color: #e0eee0">_method</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'create'</span>}},
      <span style="color: #e0eee0">read</span><span style="color: #7fff00">:</span> {<span style="color: #e0eee0">method</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'POST'</span>, <span style="color: #e0eee0">params</span><span style="color: #7fff00">:</span> {<span style="color: #e0eee0">_method</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'read'</span>}},
      <span style="color: #e0eee0">update</span><span style="color: #7fff00">:</span> {<span style="color: #e0eee0">method</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'POST'</span>, <span style="color: #e0eee0">params</span><span style="color: #7fff00">:</span> {<span style="color: #e0eee0">_method</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'update'</span>}},
      <span style="color: #90ee90">delete</span><span style="color: #7fff00">:</span> {<span style="color: #e0eee0">method</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'POST'</span>, <span style="color: #e0eee0">params</span><span style="color: #7fff00">:</span> {<span style="color: #e0eee0">_method</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'delete'</span>}},
      <span style="color: #e0eee0">multi</span><span style="color: #7fff00">:</span> {<span style="color: #e0eee0">method</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'POST'</span>, <span style="color: #e0eee0">params</span><span style="color: #7fff00">:</span> {<span style="color: #e0eee0">_method</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'multi'</span>}}
    }
    <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">Book</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$resource</span>(<span style="color: #00e5ee">'/book'</span>, {}, <span style="color: #e0eee0">actions</span>);
  });
</pre></div>


<p style="margin: 15px 0;">
定义是使用使用 <i style=" color: #d75100; font-style: normal; ">$resource</i> 这个函数就可以了，它接受三个参数：
</p>

<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li>url
</li>
<li>默认的params（这里的 params 即是 GET 请求的参数，POST 的参数单独叫做“postData”）
</li>
<li>方法映射
</li>
</ul>

<p style="margin: 15px 0;">
方法映射是以方法名为 key ，以一个对象为 value ，这个 value 可以有三个成员：
</p>

<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li>method, 请求方法，'GET', 'POST', 'PUT', 'DELETE' 这些
</li>
<li>params, 默认的 GET 参数
</li>
<li>isArray, 返回的数据是不是一个列表
</li>
</ul>

<a id="toc63" name="toc63"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">15.3. 基本使用</h2>

<p style="margin: 15px 0;">
在定义了资源之后，我们看如果使用这些资源，发出请求：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">book</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">Book</span>.<span style="color: #e0eee0">read</span>({<span style="color: #e0eee0">id</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'123'</span>}, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">response</span>){
    <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">response</span>);
  });
</pre></div>


<p style="margin: 15px 0;">
这里我们进行 <i style=" color: #d75100; font-style: normal; ">Book</i> 的“类”方法调用。在方法的使用上，根据官方文档：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">HTTP</span> <span style="color: #e0eee0">GET</span> <span style="color: #00e5ee">"class"</span> <span style="color: #e0eee0">actions:</span> <span style="color: #e0eee0">Resource</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">action</span>([<span style="color: #e0eee0">parameters</span>], [<span style="color: #e0eee0">success</span>], [<span style="color: #e0eee0">error</span>])
  <span style="color: #e0eee0">non</span><span style="color: #7fff00">-</span><span style="color: #e0eee0">GET</span> <span style="color: #00e5ee">"class"</span> <span style="color: #e0eee0">actions:</span> <span style="color: #e0eee0">Resource</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">action</span>([<span style="color: #e0eee0">parameters</span>], <span style="color: #e0eee0">postData</span>, [<span style="color: #e0eee0">success</span>], [<span style="color: #e0eee0">error</span>])
  <span style="color: #e0eee0">non</span><span style="color: #7fff00">-</span><span style="color: #e0eee0">GET</span> <span style="color: #e0eee0">instance</span> <span style="color: #e0eee0">actions:</span> <span style="color: #e0eee0">instance</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">$action</span>([<span style="color: #e0eee0">parameters</span>], [<span style="color: #e0eee0">success</span>], [<span style="color: #e0eee0">error</span>])
</pre></div>


<p style="margin: 15px 0;">
我们这里是第二种形式，即类方法的非 GET 请求。我们给的参数会作为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">postData</code> 传递。如果我们需要 GET 参数，并且还需要一个错误回调，那么：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">book</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">Book</span>.<span style="color: #e0eee0">read</span>({<span style="color: #e0eee0">get</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'haha'</span>}, {<span style="color: #e0eee0">id</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'123'</span>},
    <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">response</span>){
      <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">response</span>);
    },
    <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">error</span>){
      <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">error</span>);
    }
  );
</pre></div>


<p style="margin: 15px 0;">
调用之后，我们会立即得到的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">book</code> ，它是 Book 类的一个实例。这里所谓的实例，实际上就是先把所有的 <i style=" color: #d75100; font-style: normal; ">action</i> 加一个 <b style=" color: red; font-weight: normal; ">$</b> 前缀放到一个空对象里，然后把发出的参数填充进去。等请求返回了，把除 <i style=" color: #d75100; font-style: normal; ">action</i> 以外的成员删除掉，再把请求返回的数据填充到这个对象当中。所以，如果我们这样：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">book</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">Book</span>.<span style="color: #e0eee0">read</span>({<span style="color: #e0eee0">id</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'123'</span>}, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">response</span>){
    <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">book</span>);
  });
  <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">book</span>)
</pre></div>


<p style="margin: 15px 0;">
就能看到 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">book</code> 实例的变化过程了。
</p>
<p style="margin: 15px 0;">
现在我们得到一个真实的实例，看一下实例的调用过程：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #507080">//响应的数据是 {result: 0, msg: '', obj: {id: 'xxx'}}</span>
  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">book</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">Book</span>.<span style="color: #e0eee0">create</span>({<span style="color: #e0eee0">title</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'测试标题'</span>, <span style="color: #e0eee0">author</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'测试作者'</span>}, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">response</span>){
    <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">book</span>);
  });
</pre></div>


<p style="margin: 15px 0;">
可以看到，在请求回调之后， <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">book</code> 这个实例的成员已经被响应内容填充了。但是这里有一个问题，我们返回的数据，并不适合一个 book 实例。格式先不说，它把 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">title</code> 和 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">author</code> 这些信息都丢了（因为响应只返回了 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">id</code> ）。
</p>
<p style="margin: 15px 0;">
如果仅仅是格式问题，我们可以通过配置 <i style=" color: #d75100; font-style: normal; ">$http</i> 服务来解决（ AJAX 请求都要使用 <i style=" color: #d75100; font-style: normal; ">$http</i> 服务的）：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">$http</span>.<span style="color: #e0eee0">defaults</span>.<span style="color: #e0eee0">transformResponse</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">data</span>){<span style="color: #90ee90">return</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">fromJson</span>(<span style="color: #e0eee0">data</span>).<span style="color: #e0eee0">obj</span>};
</pre></div>


<p style="margin: 15px 0;">
当然，我们也可以自己来解决一下丢信息的问题：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">p</span> <span style="color: #7fff00">=</span> {<span style="color: #e0eee0">title</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'测试标题'</span>, <span style="color: #e0eee0">author</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'测试作者'</span>};
  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">book</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">Book</span>.<span style="color: #e0eee0">create</span>(<span style="color: #e0eee0">p</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">response</span>){
    <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">extend</span>(<span style="color: #e0eee0">book</span>, <span style="color: #e0eee0">p</span>);
    <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">book</span>);
  });
</pre></div>


<p style="margin: 15px 0;">
不过，始终会有一些不方便了。比较正统的方式应该是调节服务器端的响应，让服务器端也具有和前端一样的实例概念，返回的是完整的实例信息。即使这样，你也还要考虑格式的事。
</p>
<p style="margin: 15px 0;">
现在我们得到了一个真实的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">book</code> 实例了，带有 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">id</code> 信息。我们尝试一下实例的方法调用，先回过去头看一下那三种调用形式，对于实例只有第三种形式：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">non</span><span style="color: #7fff00">-</span><span style="color: #e0eee0">GET</span> <span style="color: #e0eee0">instance</span> <span style="color: #e0eee0">actions:</span> <span style="color: #e0eee0">instance</span><span style="color: #7fff00">.</span><span style="color: #e0eee0">$action</span>([<span style="color: #e0eee0">parameters</span>], [<span style="color: #e0eee0">success</span>], [<span style="color: #e0eee0">error</span>])
</pre></div>


<p style="margin: 15px 0;">
首先解决一个疑问，如果一个实例是进行一个 GET 的调用会怎么样？没有任何问题，这当然没有任何问题的，形式和上面一样。
</p>
<p style="margin: 15px 0;">
如何实例是做 POST 请求的话，从形式上看，我们无法控制请求的 <i style=" color: #d75100; font-style: normal; ">postData</i> ？是的，所有的 POST 请求，其 <i style=" color: #d75100; font-style: normal; ">postData</i> 都会被实例数据自动填充，形式上我们只能控制 <i style=" color: #d75100; font-style: normal; ">params</i> 。
</p>
<p style="margin: 15px 0;">
所以，如果是在做修改调用的话：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">book</span>.<span style="color: #e0eee0">$update</span>({<span style="color: #e0eee0">title</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'新标题'</span>, <span style="color: #e0eee0">author</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'测试作者'</span>}, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">response</span>){
    <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">book</span>);
  });
</pre></div>


<p style="margin: 15px 0;">
这样是没有意义的并且错误的。因为要修改的数据只是作为 GET 参数传递了，而 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">postData</code> 传递的数据就是当前实例的数据，并没有任何修改。
</p>
<p style="margin: 15px 0;">
正确的做法：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">book</span>.<span style="color: #e0eee0">title</span> <span style="color: #7fff00">=</span> <span style="color: #00e5ee">'新标题'</span>
  <span style="color: #e0eee0">book</span>.<span style="color: #e0eee0">$update</span>(<span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">response</span>){
    <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">book</span>);
  });
</pre></div>


<p style="margin: 15px 0;">
显然，这种情况下，回调都可以省了：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">book</span>.<span style="color: #e0eee0">title</span> <span style="color: #7fff00">=</span> <span style="color: #00e5ee">'新标题'</span>
  <span style="color: #e0eee0">book</span>.<span style="color: #e0eee0">$update</span>();
</pre></div>


<a id="toc64" name="toc64"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">15.4. 定义和使用时的占位量</h2>

<p style="margin: 15px 0;">
两方面。一是在定义时，在其 URL 中可以使用变量引用的形式（类型于定义锚点路由时那样）。第二时定义默认 <i style=" color: #d75100; font-style: normal; ">params</i> ，即 GET 参数时，可以定义为引用 <i style=" color: #d75100; font-style: normal; ">postData</i> 中的某变量。比如我们这样改一下：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">Book</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$resource</span>(<span style="color: #00e5ee">'/book/:id'</span>, {}, <span style="color: #e0eee0">actions</span>);
  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">book</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">Book</span>.<span style="color: #e0eee0">read</span>({<span style="color: #e0eee0">id</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'123'</span>}, {}, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">response</span>){
    <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">response</span>);
  });
</pre></div>


<p style="margin: 15px 0;">
在 URL 中有一个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">:id</code> ，表示对 <i style=" color: #d75100; font-style: normal; ">params</i> 中 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">id</code> 这个变量的引用。因为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">read</code> 是一个 POST 请求，根据调用形式，第一个参数是 <i style=" color: #d75100; font-style: normal; ">params</i> ，第二个参数是 <i style=" color: #d75100; font-style: normal; ">postData</i> 。这样的调用结果就是，我们会发一个 POST 请求到如下地址， <i style=" color: #d75100; font-style: normal; ">postData</i> 为空：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  /book/123?_method=read
</pre></div>


<p style="margin: 15px 0;">
再看默认的 <i style=" color: #d75100; font-style: normal; ">params</i> 中引用 <i style=" color: #d75100; font-style: normal; ">postData</i> 变量的形式：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">Book</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$resource</span>(<span style="color: #00e5ee">'/book'</span>, {<span style="color: #e0eee0">id</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'@id'</span>}, <span style="color: #e0eee0">actions</span>);
  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">book</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">Book</span>.<span style="color: #e0eee0">read</span>({<span style="color: #e0eee0">title</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'xx'</span>}, {<span style="color: #e0eee0">id</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'123'</span>}, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">response</span>){
    <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">response</span>);
  });
</pre></div>


<p style="margin: 15px 0;">
这样会出一个 POST 请求， <i style=" color: #d75100; font-style: normal; ">postData</i> 内容中有一个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">id</code> 数据，访问的 URL 是：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  /book?_method=read&amp;id=123&amp;title=xx
</pre></div>


<p style="margin: 15px 0;">
这两个机制也可以联合使用：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">Book</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$resource</span>(<span style="color: #00e5ee">'/book/:id'</span>, {<span style="color: #e0eee0">id</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'@id'</span>}, <span style="color: #e0eee0">actions</span>);
  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">book</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">Book</span>.<span style="color: #e0eee0">read</span>({<span style="color: #e0eee0">title</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'xx'</span>}, {<span style="color: #e0eee0">id</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'123'</span>}, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">response</span>){
    <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">response</span>);
  });
</pre></div>


<p style="margin: 15px 0;">
结果就是出一个 POST 请求， <i style=" color: #d75100; font-style: normal; ">postData</i> 内容中有一个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">id</code> 数据，访问的 URL 是：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  /book/123?_method=read&amp;title=xx
</pre></div>


<a id="toc65" name="toc65"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">15.5. 实例</h2>

<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">ngResource</i> 要举一个实例是比较麻烦的事。因为它必须要一个后端来支持，这里如果我用 Python 写一个简单的后端，估计要让这个后端跑起来对很多人来说都是问题。所以，我在几套公共服务的 API 中纠结考察了一番，最后使用 <a href="http://www.rememberthemilk.com/" style="color: #0184b7; text-decoration: none">www.rememberthemilk.com</a> 的 API 来做了一个简单的，可用的例子。
</p>
<p style="margin: 15px 0;">
例子见： <a href="http://zouyesheng.com/demo/ng-resource-demo.html" style="color: #0184b7; text-decoration: none">http://zouyesheng.com/demo/ng-resource-demo.html</a>  (可以直接下载看源码)
</p>
<p style="margin: 15px 0;">
先说一下 API 的情况。这里的请求调用全是跨域的，所以交互上全部是使用了 JSONP 的形式。 API 的使用有使用签名认证机制，嗯， js 中直接算 md5 是可行的，我用了一个现成的库（但是好像不能处理中文吧）。
</p>
<p style="margin: 15px 0;">
这个例子中的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">LoginCtrl</code> 大家就不用太关心了，参见官方的文档，走完流程拿到 <i style=" color: #d75100; font-style: normal; ">token</i> 完事。与 <i style=" color: #d75100; font-style: normal; ">ngResource</i> 相关的是 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">MainCtrl</code> 中的东西。
</p>
<p style="margin: 15px 0;">
其实从这个例子中就可以看出，目前 <i style=" color: #d75100; font-style: normal; ">ngResource</i> 的机制对于服务端返回的数据的格式是严重依赖的，同时也可以反映出 <i style=" color: #d75100; font-style: normal; ">$http</i> 对一些场景根本无法应对的局限。所以，我现在的想法是理解 <i style=" color: #d75100; font-style: normal; ">ngResource</i> 的思想，真正需要的人自己使用 <i style=" color: #d75100; font-style: normal; ">jQuery</i> 重新实现一遍也许更好。这应该也花不了多少时间， <i style=" color: #d75100; font-style: normal; ">ngResource</i> 的代码本来不多。
</p>
<p style="margin: 15px 0;">
我为什么说 <i style=" color: #d75100; font-style: normal; ">$http</i> 在一些场景中有局限呢。在这个例子当中，所有的请求都需要带一个签名，签名值是由请求中带的参数根据规则使用 md5 方法计算出的值。我找不到一个 hook 可以让我在请求出去之前修改这个请求（添加上签名）。所以在这个例子当中，我的做法是根据 <i style=" color: #d75100; font-style: normal; ">ngResource</i> 的请求最后会使用 <i style=" color: #d75100; font-style: normal; ">$httpBackend</i> 这个底层服务，在 module 定义时我自己复制官方的相关代码，重新定义 <i style=" color: #d75100; font-style: normal; ">$httpBackend</i> 服务，在需要的地方做我自己的修改：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">script</span>.<span style="color: #e0eee0">src</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">sign_url</span>(<span style="color: #e0eee0">url</span>);
</pre></div>


<p style="margin: 15px 0;">
不错，我就改了这一句，但我不得不复制了 50 行官方源码到我的例子中。
</p>
<p style="margin: 15px 0;">
另外一个需要说的是对返回数据的处理。因为 <i style=" color: #d75100; font-style: normal; ">ngResource</i> 会使用返回的数据直接填充实例，所以这个数据格式就很重要。
</p>
<p style="margin: 15px 0;">
首先，我们可以使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">$http.defaults.transformResponse</code> 来统一处理一下返回的数据，但是这并不能解决所有问题，可目前 <i style=" color: #d75100; font-style: normal; ">ngResource</i> 并不提供对每一个 <i style=" color: #d75100; font-style: normal; ">action</i> 的单独的后处理回调函数项。除非你的服务端是经过专门的适应性设计的，否则你用 <i style=" color: #d75100; font-style: normal; ">ngResource</i> 不可能爽。例子中，我为了获取当前列表的结果，我不得不自己去封装结果：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">list_list</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">List</span>.<span style="color: #e0eee0">getList</span>(<span style="color: #bcd2ee">function</span>(){
    <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">res</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">list_list</span>[<span style="color: #00ffff">1</span>];
    <span style="color: #90ee90">while</span>(<span style="color: #e0eee0">list_list</span>.<span style="color: #e0eee0">length</span> <span style="color: #7fff00">&gt;</span> <span style="color: #00ffff">0</span>){<span style="color: #e0eee0">list_list</span>.<span style="color: #e0eee0">pop</span>()};
    <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">forEach</span>(<span style="color: #e0eee0">res</span>.<span style="color: #e0eee0">list</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">v</span>){
      <span style="color: #e0eee0">list_list</span>.<span style="color: #e0eee0">push</span>(<span style="color: #90ee90">new</span> <span style="color: #e0eee0">List</span>({<span style="color: #e0eee0">list</span><span style="color: #7fff00">:</span> <span style="color: #e0eee0">v</span>}));
    });
    <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">list_list</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">list_list</span>;
    <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">show_add</span> <span style="color: #7fff00">=</span> <span style="color: #90ee90">true</span>;
    <span style="color: #90ee90">return</span>;
  });
</pre></div>


<a id="toc66" name="toc66"></a>
<h1 style=" -moz-border-radius: 5px; -webkit-border-radius: 5px; -moz-box-shadow: 3px 3px 5px #333; -webkit-box-shadow: 3px 3px 5px #333; box-shadow: 3px 3px 5px #333;  border-radius: 5px; background-color: #69ab01; padding: 4px; color: white; line-height: 1.3em; text-shadow: 2px 2px 2px black; margin: 20px auto; font-size: medium; clear: both;">16. AngularJS与其它框架的混用(jQuery, Dojo)</h1>

<p style="margin: 15px 0;">
这个问题似乎很多人都关心，但是事实是，如果了解了 ng 的工作方式，这本来就不是一个问题了。
</p>
<p style="margin: 15px 0;">
在我自己使用 ng 的过程当中，一直是混用 jQuery 的，以前还要加上一个 Dojo 。只要了解每种框架的工作方式，在具体的代码中每个框架都做了什么事，那么整体上控制起来就不会有问题。
</p>
<p style="margin: 15px 0;">
回到 ng 上来看，首先对于 jQuery 来说，最开始说提到过，在 DOM 操作部分， ng 与 jQuery 是兼容的，如果没有 jQuery ， ng 自己也实现了兼容的部分 API 。
</p>
<p style="margin: 15px 0;">
同时，最开始也提到过， ng 的使用最忌讳的一点就是修改 DOM 结构——你应该使用 ng 的模板机制进行数据绑定，以此来控制 DOM 
结构，而不是直接操作。换句话来说，在不动 DOM 结构的这个前提之下，你的数据随便怎么改，随便使用哪个框架来控制都是没问题的，到时如有必要使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">$scope.$digest()</code> 来通知 ng 一下即可。
</p>
<p style="margin: 15px 0;">
下面这个例子，我们使用了 jQuery 中的 <i style=" color: #d75100; font-style: normal; ">Deferred</i> ( <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">$.ajax</code> 就是返回一个 <i style=" color: #d75100; font-style: normal; ">Deferred</i> )，还使用了 ng 的 <i style=" color: #d75100; font-style: normal; ">$timeout</i> ，当然是在 ng 的结构之下：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;"><span style="color: gray; padding: 0 5px 0 5px"> 1</span>   <span style="color: #507080">&lt;!DOCTYPE html&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 2</span>   <span style="color: #e0eee0">&lt;html</span> <span style="color: #e0eee0">ng-app=</span><span style="color: #00e5ee">"Demo"</span><span style="color: #e0eee0">&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 3</span>   <span style="color: #e0eee0">&lt;head&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 4</span>   <span style="color: #e0eee0">&lt;meta</span> <span style="color: #e0eee0">charset=</span><span style="color: #00e5ee">"utf-8"</span> <span style="color: #e0eee0">/&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 5</span>   <span style="color: #e0eee0">&lt;title&gt;</span>AngularJS<span style="color: #e0eee0">&lt;/title&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 6</span>   <span style="color: #e0eee0">&lt;/head&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 7</span>   <span style="color: #e0eee0">&lt;body&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 8</span>   
<span style="color: gray; padding: 0 5px 0 5px"> 9</span>   <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span><span style="color: #e0eee0">&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">10</span>     <span style="color: #e0eee0">&lt;span</span> <span style="color: #e0eee0">ng-click=</span><span style="color: #00e5ee">"go()"</span><span style="color: #e0eee0">&gt;</span>{{ a }}<span style="color: #e0eee0">&lt;/span&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">11</span>   <span style="color: #e0eee0">&lt;/div&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">12</span>   
<span style="color: gray; padding: 0 5px 0 5px">13</span>   <span style="color: #e0eee0">&lt;script type=</span><span style="color: #00e5ee">"text/javascript"</span>
<span style="color: gray; padding: 0 5px 0 5px">14</span>     <span style="color: #e0eee0">src=</span><span style="color: #00e5ee">"http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"</span><span style="color: #e0eee0">&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">15</span>   <span style="color: #e0eee0">&lt;/script&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">16</span>   <span style="color: #e0eee0">&lt;script type=</span><span style="color: #00e5ee">"text/javascript"</span>
<span style="color: gray; padding: 0 5px 0 5px">17</span>     <span style="color: #e0eee0">src=</span><span style="color: #00e5ee">"http://ajax.googleapis.com/ajax/libs/angularjs/1.0.3/angular.min.js"</span><span style="color: #e0eee0">&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">18</span>   <span style="color: #e0eee0">&lt;/script&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">19</span>   
<span style="color: gray; padding: 0 5px 0 5px">20</span>   <span style="color: #e0eee0">&lt;script type=</span><span style="color: #00e5ee">"text/javascript"</span><span style="color: #e0eee0">&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">21</span>   <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">app</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'Demo'</span>, [], <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">noop</span>);
<span style="color: gray; padding: 0 5px 0 5px">22</span>   <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">controller</span>(<span style="color: #00e5ee">'TestCtrl'</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">$timeout</span>){
<span style="color: gray; padding: 0 5px 0 5px">23</span>     <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">a</span> <span style="color: #7fff00">=</span> <span style="color: #00e5ee">'点击我开始'</span>;
<span style="color: gray; padding: 0 5px 0 5px">24</span>   
<span style="color: gray; padding: 0 5px 0 5px">25</span>     <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">defer</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$</span>.<span style="color: #e0eee0">Deferred</span>();
<span style="color: gray; padding: 0 5px 0 5px">26</span>     <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">f</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(){
<span style="color: gray; padding: 0 5px 0 5px">27</span>       <span style="color: #90ee90">if</span>(<span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">a</span> <span style="color: #7fff00">==</span> <span style="color: #00e5ee">''</span>){<span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">a</span> <span style="color: #7fff00">=</span> <span style="color: #00e5ee">'已停止'</span>; <span style="color: #90ee90">return</span>}
<span style="color: gray; padding: 0 5px 0 5px">28</span>       <span style="color: #e0eee0">defer</span>.<span style="color: #e0eee0">done</span>(<span style="color: #bcd2ee">function</span>(){
<span style="color: gray; padding: 0 5px 0 5px">29</span>         <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">a</span>.<span style="color: #e0eee0">length</span> <span style="color: #7fff00">&lt;</span> <span style="color: #00ffff">10</span> <span style="color: #7fff00">?</span> <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">a</span> <span style="color: #7fff00">+=</span> <span style="color: #00e5ee">'&gt;'</span> <span style="color: #7fff00">:</span> <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">a</span> <span style="color: #7fff00">=</span> <span style="color: #00e5ee">'&gt;'</span>;
<span style="color: gray; padding: 0 5px 0 5px">30</span>         <span style="color: #e0eee0">$timeout</span>(<span style="color: #e0eee0">f</span>, <span style="color: #00ffff">100</span>);
<span style="color: gray; padding: 0 5px 0 5px">31</span>       });
<span style="color: gray; padding: 0 5px 0 5px">32</span>     }
<span style="color: gray; padding: 0 5px 0 5px">33</span>     <span style="color: #e0eee0">defer</span>.<span style="color: #e0eee0">done</span>(<span style="color: #bcd2ee">function</span>(){<span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">a</span> <span style="color: #7fff00">=</span> <span style="color: #00e5ee">'&gt;'</span>; <span style="color: #e0eee0">f</span>()});
<span style="color: gray; padding: 0 5px 0 5px">34</span>   
<span style="color: gray; padding: 0 5px 0 5px">35</span>     <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">go</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(){
<span style="color: gray; padding: 0 5px 0 5px">36</span>       <span style="color: #e0eee0">defer</span>.<span style="color: #e0eee0">resolve</span>();
<span style="color: gray; padding: 0 5px 0 5px">37</span>       <span style="color: #e0eee0">$timeout</span>(<span style="color: #bcd2ee">function</span>(){<span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">a</span> <span style="color: #7fff00">=</span> <span style="color: #00e5ee">''</span>}, <span style="color: #00ffff">5000</span>);
<span style="color: gray; padding: 0 5px 0 5px">38</span>     }
<span style="color: gray; padding: 0 5px 0 5px">39</span>   });
<span style="color: gray; padding: 0 5px 0 5px">40</span>   <span style="color: #e0eee0">&lt;/script&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">41</span>   <span style="color: #e0eee0">&lt;/body&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">42</span>   <span style="color: #e0eee0">&lt;/html&gt;</span>
</pre></div>


<p style="margin: 15px 0;">
再把 Dojo 加进来看与 DOM 结构相关的例子。之前说过，使用 ng 就最好不要手动修改 DOM 结构，但这里说两点：
</p>

<ol style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li>对于整个页面，你可以只在局部使用 ng ，不使用 ng 的地方你可以随意控制 DOM 。
</li>
<li>如果 DOM 结构有变动，你可以在 DOM 结构定下来之后再初始化 ng 。
</li>
</ol>

<p style="margin: 15px 0;">
下面这个例子使用了 <i style=" color: #d75100; font-style: normal; ">AngularJS</i> ， <i style=" color: #d75100; font-style: normal; ">jQuery</i> ， <i style=" color: #d75100; font-style: normal; ">Dojo</i> ：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;"><span style="color: gray; padding: 0 5px 0 5px"> 1</span>   <span style="color: #507080">&lt;!DOCTYPE html&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 2</span>   <span style="color: #e0eee0">&lt;html&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 3</span>   <span style="color: #e0eee0">&lt;head&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 4</span>   <span style="color: #e0eee0">&lt;meta</span> <span style="color: #e0eee0">charset=</span><span style="color: #00e5ee">"utf-8"</span> <span style="color: #e0eee0">/&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 5</span>   <span style="color: #e0eee0">&lt;title&gt;</span>AngularJS<span style="color: #e0eee0">&lt;/title&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 6</span>   <span style="color: #e0eee0">&lt;link</span> <span style="color: #e0eee0">rel=</span><span style="color: #00e5ee">"stylesheet"</span>
<span style="color: gray; padding: 0 5px 0 5px"> 7</span>     <span style="color: #e0eee0">href=</span><span style="color: #00e5ee">"http://ajax.googleapis.com/ajax/libs/dojo/1.9.1/dijit/themes/claro/claro.css"</span> <span style="color: #e0eee0">media=</span><span style="color: #00e5ee">"screen"</span> <span style="color: #e0eee0">/&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 8</span>   <span style="color: #e0eee0">&lt;/head&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 9</span>   <span style="color: #e0eee0">&lt;body</span> <span style="color: #e0eee0">class=</span><span style="color: #00e5ee">"claro"</span><span style="color: #e0eee0">&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">10</span>   
<span style="color: gray; padding: 0 5px 0 5px">11</span>   <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span> <span style="color: #e0eee0">id=</span><span style="color: #00e5ee">"test_ctrl"</span><span style="color: #e0eee0">&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">12</span>   
<span style="color: gray; padding: 0 5px 0 5px">13</span>     <span style="color: #e0eee0">&lt;p</span> <span style="color: #e0eee0">ng-show=</span><span style="color: #00e5ee">"!btn_disable"</span><span style="color: #e0eee0">&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">14</span>       <span style="color: #e0eee0">&lt;button</span> <span style="color: #e0eee0">ng-click=</span><span style="color: #00e5ee">"change()"</span><span style="color: #e0eee0">&gt;</span>调用dojo修改按钮<span style="color: #e0eee0">&lt;/button&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">15</span>     <span style="color: #e0eee0">&lt;/p&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">16</span>   
<span style="color: gray; padding: 0 5px 0 5px">17</span>     <span style="color: #e0eee0">&lt;p</span> <span style="color: #e0eee0">id=</span><span style="color: #00e5ee">"btn_wrapper"</span><span style="color: #e0eee0">&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">18</span>       <span style="color: #e0eee0">&lt;button</span> <span style="color: #e0eee0">data-dojo-type=</span><span style="color: #00e5ee">"dijit/form/Button"</span> <span style="color: #e0eee0">type=</span><span style="color: #00e5ee">"button"</span><span style="color: #e0eee0">&gt;</span>{{ a }}<span style="color: #e0eee0">&lt;/button&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">19</span>     <span style="color: #e0eee0">&lt;/p&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">20</span>   
<span style="color: gray; padding: 0 5px 0 5px">21</span>     <span style="color: #e0eee0">&lt;p&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">22</span>       <span style="color: #e0eee0">&lt;input</span> <span style="color: #e0eee0">ng-model=</span><span style="color: #00e5ee">"dialog_text"</span> <span style="color: #e0eee0">ng-init=</span><span style="color: #00e5ee">"dialog_text='对话框内容'"</span> <span style="color: #e0eee0">/&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">23</span>       <span style="color: #e0eee0">&lt;button</span> <span style="color: #e0eee0">ng-click=</span><span style="color: #00e5ee">"dialog(dialog_text)"</span><span style="color: #e0eee0">&gt;</span>显示对话框<span style="color: #e0eee0">&lt;/button&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">24</span>     <span style="color: #e0eee0">&lt;/p&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">25</span>   
<span style="color: gray; padding: 0 5px 0 5px">26</span>     <span style="color: #e0eee0">&lt;p</span> <span style="color: #e0eee0">ng-show=</span><span style="color: #00e5ee">"show_edit_text"</span> <span style="color: #e0eee0">style=</span><span style="color: #00e5ee">"display: none;"</span><span style="color: #e0eee0">&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">27</span>       <span style="color: #e0eee0">&lt;span&gt;</span>需要编辑的内容:<span style="color: #e0eee0">&lt;/span&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">28</span>       <span style="color: #e0eee0">&lt;input</span> <span style="color: #e0eee0">ng-model=</span><span style="color: #00e5ee">"text"</span> <span style="color: #e0eee0">/&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">29</span>     <span style="color: #e0eee0">&lt;/p&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">30</span>   
<span style="color: gray; padding: 0 5px 0 5px">31</span>     <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">id=</span><span style="color: #00e5ee">"editor_wrapper"</span><span style="color: #e0eee0">&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">32</span>       <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">data-dojo-type=</span><span style="color: #00e5ee">"dijit/Editor"</span> <span style="color: #e0eee0">id=</span><span style="color: #00e5ee">"editor"</span><span style="color: #e0eee0">&gt;&lt;/div&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">33</span>     <span style="color: #e0eee0">&lt;/div&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">34</span>   
<span style="color: gray; padding: 0 5px 0 5px">35</span>   <span style="color: #e0eee0">&lt;/div&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">36</span>   
<span style="color: gray; padding: 0 5px 0 5px">37</span>   
<span style="color: gray; padding: 0 5px 0 5px">38</span>   <span style="color: #e0eee0">&lt;script type=</span><span style="color: #00e5ee">"text/javascript"</span>
<span style="color: gray; padding: 0 5px 0 5px">39</span>     <span style="color: #e0eee0">src=</span><span style="color: #00e5ee">"http://ajax.googleapis.com/ajax/libs/dojo/1.9.1/dojo/dojo.js"</span><span style="color: #e0eee0">&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">40</span>   <span style="color: #e0eee0">&lt;/script&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">41</span>   <span style="color: #e0eee0">&lt;script type=</span><span style="color: #00e5ee">"text/javascript"</span>
<span style="color: gray; padding: 0 5px 0 5px">42</span>     <span style="color: #e0eee0">src=</span><span style="color: #00e5ee">"http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"</span><span style="color: #e0eee0">&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">43</span>   <span style="color: #e0eee0">&lt;/script&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">44</span>   <span style="color: #e0eee0">&lt;script type=</span><span style="color: #00e5ee">"text/javascript"</span>
<span style="color: gray; padding: 0 5px 0 5px">45</span>     <span style="color: #e0eee0">src=</span><span style="color: #00e5ee">"http://ajax.googleapis.com/ajax/libs/angularjs/1.0.3/angular.min.js"</span><span style="color: #e0eee0">&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">46</span>   <span style="color: #e0eee0">&lt;/script&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">47</span>   
<span style="color: gray; padding: 0 5px 0 5px">48</span>   <span style="color: #e0eee0">&lt;script type=</span><span style="color: #00e5ee">"text/javascript"</span><span style="color: #e0eee0">&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">49</span>   
<span style="color: gray; padding: 0 5px 0 5px">50</span>   <span style="color: #e0eee0">require</span>([<span style="color: #00e5ee">'dojo/parser'</span>, <span style="color: #00e5ee">'dijit/Editor'</span>], <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">parser</span>){
<span style="color: gray; padding: 0 5px 0 5px">51</span>     <span style="color: #e0eee0">parser</span>.<span style="color: #e0eee0">parse</span>(<span style="color: #e0eee0">$</span>(<span style="color: #00e5ee">'#editor_wrapper'</span>)[<span style="color: #00ffff">0</span>]).<span style="color: #e0eee0">then</span>(<span style="color: #bcd2ee">function</span>(){
<span style="color: gray; padding: 0 5px 0 5px">52</span>       <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">app</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'Demo'</span>, [], <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">noop</span>);
<span style="color: gray; padding: 0 5px 0 5px">53</span>   
<span style="color: gray; padding: 0 5px 0 5px">54</span>       <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">controller</span>(<span style="color: #00e5ee">'TestCtrl'</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">$timeout</span>){
<span style="color: gray; padding: 0 5px 0 5px">55</span>         <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">a</span> <span style="color: #7fff00">=</span> <span style="color: #00e5ee">'我是ng, 也是dojo'</span>;
<span style="color: gray; padding: 0 5px 0 5px">56</span>         <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">show_edit_text</span> <span style="color: #7fff00">=</span> <span style="color: #90ee90">true</span>;
<span style="color: gray; padding: 0 5px 0 5px">57</span>   
<span style="color: gray; padding: 0 5px 0 5px">58</span>         <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">change</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(){
<span style="color: gray; padding: 0 5px 0 5px">59</span>           <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">a</span> <span style="color: #7fff00">=</span> <span style="color: #00e5ee">'DOM结构已经改变(不建议这样做)'</span>;
<span style="color: gray; padding: 0 5px 0 5px">60</span>           <span style="color: #e0eee0">require</span>([<span style="color: #00e5ee">'dojo/parser'</span>, <span style="color: #00e5ee">'dijit/form/Button'</span>, <span style="color: #00e5ee">'dojo/domReady!'</span>],
<span style="color: gray; padding: 0 5px 0 5px">61</span>             <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">parser</span>){
<span style="color: gray; padding: 0 5px 0 5px">62</span>               <span style="color: #e0eee0">parser</span>.<span style="color: #e0eee0">parse</span>(<span style="color: #e0eee0">$</span>(<span style="color: #00e5ee">'#btn_wrapper'</span>)[<span style="color: #00ffff">0</span>]);
<span style="color: gray; padding: 0 5px 0 5px">63</span>               <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">btn_disable</span> <span style="color: #7fff00">=</span> <span style="color: #90ee90">true</span>;
<span style="color: gray; padding: 0 5px 0 5px">64</span>             }
<span style="color: gray; padding: 0 5px 0 5px">65</span>           );
<span style="color: gray; padding: 0 5px 0 5px">66</span>         }
<span style="color: gray; padding: 0 5px 0 5px">67</span>   
<span style="color: gray; padding: 0 5px 0 5px">68</span>         <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">dialog</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">text</span>){
<span style="color: gray; padding: 0 5px 0 5px">69</span>           <span style="color: #e0eee0">require</span>([<span style="color: #00e5ee">"dijit/Dialog"</span>, <span style="color: #00e5ee">"dojo/domReady!"</span>], <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">Dialog</span>){
<span style="color: gray; padding: 0 5px 0 5px">70</span>             <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">dialog</span> <span style="color: #7fff00">=</span> <span style="color: #90ee90">new</span> <span style="color: #e0eee0">Dialog</span>({
<span style="color: gray; padding: 0 5px 0 5px">71</span>                 <span style="color: #e0eee0">title</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">"对话框哦"</span>,
<span style="color: gray; padding: 0 5px 0 5px">72</span>                 <span style="color: #e0eee0">content</span><span style="color: #7fff00">:</span> <span style="color: #e0eee0">text</span>,
<span style="color: gray; padding: 0 5px 0 5px">73</span>                 <span style="color: #e0eee0">style</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">"width: 300px"</span>
<span style="color: gray; padding: 0 5px 0 5px">74</span>             });
<span style="color: gray; padding: 0 5px 0 5px">75</span>             <span style="color: #e0eee0">dialog</span>.<span style="color: #e0eee0">show</span>();
<span style="color: gray; padding: 0 5px 0 5px">76</span>           });
<span style="color: gray; padding: 0 5px 0 5px">77</span>         }
<span style="color: gray; padding: 0 5px 0 5px">78</span>   
<span style="color: gray; padding: 0 5px 0 5px">79</span>         <span style="color: #e0eee0">require</span>([<span style="color: #00e5ee">'dijit/registry'</span>], <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">registry</span>){
<span style="color: gray; padding: 0 5px 0 5px">80</span>           <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">editor</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">registry</span>.<span style="color: #e0eee0">byId</span>(<span style="color: #00e5ee">'editor'</span>);
<span style="color: gray; padding: 0 5px 0 5px">81</span>           <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">$watch</span>(<span style="color: #00e5ee">'text'</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">new_v</span>){
<span style="color: gray; padding: 0 5px 0 5px">82</span>             <span style="color: #e0eee0">editor</span>.<span style="color: #e0eee0">setValue</span>(<span style="color: #e0eee0">new_v</span>);
<span style="color: gray; padding: 0 5px 0 5px">83</span>           });
<span style="color: gray; padding: 0 5px 0 5px">84</span>         });
<span style="color: gray; padding: 0 5px 0 5px">85</span>   
<span style="color: gray; padding: 0 5px 0 5px">86</span>       });
<span style="color: gray; padding: 0 5px 0 5px">87</span>   
<span style="color: gray; padding: 0 5px 0 5px">88</span>       <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">bootstrap</span>(<span style="color: #e0eee0">document</span>, [<span style="color: #00e5ee">'Demo'</span>]);
<span style="color: gray; padding: 0 5px 0 5px">89</span>     });
<span style="color: gray; padding: 0 5px 0 5px">90</span>   
<span style="color: gray; padding: 0 5px 0 5px">91</span>   });
<span style="color: gray; padding: 0 5px 0 5px">92</span>   
<span style="color: gray; padding: 0 5px 0 5px">93</span>   <span style="color: #e0eee0">&lt;/script&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">94</span>   <span style="color: #e0eee0">&lt;/body&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px">95</span>   <span style="color: #e0eee0">&lt;/html&gt;</span>
</pre></div>


<a id="toc67" name="toc67"></a>
<h1 style=" -moz-border-radius: 5px; -webkit-border-radius: 5px; -moz-box-shadow: 3px 3px 5px #333; -webkit-box-shadow: 3px 3px 5px #333; box-shadow: 3px 3px 5px #333;  border-radius: 5px; background-color: #69ab01; padding: 4px; color: white; line-height: 1.3em; text-shadow: 2px 2px 2px black; margin: 20px auto; font-size: medium; clear: both;">17. 自定义过滤器</h1>

<p style="margin: 15px 0;">
先来回顾一下 ng 中的一些概念：
</p>

<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li><i style=" color: #d75100; font-style: normal; ">module</i> ，代码的组织单元，其它东西都是在定义在具体的模块中的。
</li>
<li><i style=" color: #d75100; font-style: normal; ">app</i> ，业务概念，可能会用到多个模块。
</li>
<li><i style=" color: #d75100; font-style: normal; ">service</i> ，仅在数据层面实现特定业务功能的代码封装。
</li>
<li><i style=" color: #d75100; font-style: normal; ">controller</i> ，与 DOM 结构相关联的东西，即是一种业务封装概念，又体现了项目组织的层级结构。
</li>
<li><i style=" color: #d75100; font-style: normal; ">filter</i> ，改变输入数据的一种机制。
</li>
<li><i style=" color: #d75100; font-style: normal; ">directive</i> ，与 DOM 结构相关联的，特定功能的封装形式。
</li>
</ul>

<p style="margin: 15px 0;">
上面的这几个概念基本上就是 ng 的全部。每一部分都可以自由定义，使用时通过各要素的相互配合来实现我们的业务需求。
</p>
<p style="margin: 15px 0;">
我们从最开始一致打交道的东西基本上都是 <i style=" color: #d75100; font-style: normal; ">controller</i> 层面的东西。在前面，也介绍了 <i style=" color: #d75100; font-style: normal; ">module</i> 和 <i style=" color: #d75100; font-style: normal; ">service</i> 的自定义。剩下的会介绍 <i style=" color: #d75100; font-style: normal; ">filter</i> 和 <i style=" color: #d75100; font-style: normal; ">directive</i> 的定义。基本上这几部分的定义形式都是一样的，原理上是通过 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">provider</code> 来做注入形式的声明，在实际操作过程中，又有很多 shortcut 式的声明方式。
</p>
<p style="margin: 15px 0;">
过滤器的自定义是最简单的，就是一个函数，接受输入，然后返回结果。在考虑过滤器时，我觉得很重要的一点： <b style=" color: red; font-weight: normal; ">无状态</b> 。
</p>
<p style="margin: 15px 0;">
具体来说，过滤器就是一个函数，函数的本质含义就是确定的输入一定得到确定的输出。虽然 <i style=" color: #d75100; font-style: normal; ">filter</i> 是定义在 <i style=" color: #d75100; font-style: normal; ">module</i> 当中的，而且 <i style=" color: #d75100; font-style: normal; ">filter</i> 又是在 <i style=" color: #d75100; font-style: normal; ">controller</i> 的 DOM 范围内使用的，但是，它和具体的 <i style=" color: #d75100; font-style: normal; ">module</i> ， <i style=" color: #d75100; font-style: normal; ">controller</i> ， <i style=" color: #d75100; font-style: normal; ">scope</i> 这些概念都没有关系（虽然在这里你可以使用 js 的闭包机制玩些花样），它仅仅是一个函数，而已。换句话说，它没有任何上下文关联的能力。
</p>
<p style="margin: 15px 0;">
过滤器基本的定义方式：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">app</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'Demo'</span>, [], <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">noop</span>);
  <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">filter</span>(<span style="color: #00e5ee">'map'</span>, <span style="color: #bcd2ee">function</span>(){
    <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">filter</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">input</span>){
      <span style="color: #90ee90">return</span> <span style="color: #e0eee0">input</span> <span style="color: #7fff00">+</span> <span style="color: #00e5ee">'...'</span>;
    };
    <span style="color: #90ee90">return</span> <span style="color: #e0eee0">filter</span>;
  });
</pre></div>


<p style="margin: 15px 0;">
上面的代码定义了一个叫做 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">map</code> 的过滤器。使用时：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;p&gt;</span>示例数据: {{ a|map }}<span style="color: #e0eee0">&lt;/p&gt;</span>
</pre></div>


<p style="margin: 15px 0;">
过滤器也可以带参数，多个参数之间使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">:</code> 分割，看一个完整的例子：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;"><span style="color: gray; padding: 0 5px 0 5px"> 1</span>   <span style="color: #7fff00">&lt;</span><span style="color: #e0eee0">div</span> <span style="color: #e0eee0">ng</span><span style="color: #7fff00">-</span><span style="color: #e0eee0">controller</span><span style="color: #7fff00">=</span><span style="color: #00e5ee">"TestCtrl"</span><span style="color: #7fff00">&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 2</span>   <span style="color: #7fff00">&lt;</span><span style="color: #e0eee0">p</span><span style="color: #7fff00">&gt;</span>示例数据<span style="color: #7fff00">:</span> {{ <span style="color: #e0eee0">a</span><span style="color: #7fff00">|</span><span style="color: #e0eee0">map</span><span style="color: #7fff00">:</span><span style="color: #e0eee0">map_value</span><span style="color: #7fff00">:</span><span style="color: #00e5ee">'&gt;&gt;'</span><span style="color: #7fff00">:</span><span style="color: #00e5ee">'(no)'</span> }}<span style="color: #7fff00">&lt;</span>/p&gt;
<span style="color: gray; padding: 0 5px 0 5px"> 3</span>   <span style="color: #7fff00">&lt;</span><span style="color: #e0eee0">p</span><span style="color: #7fff00">&gt;</span>示例数据<span style="color: #7fff00">:</span> {{ <span style="color: #e0eee0">b</span><span style="color: #7fff00">|</span><span style="color: #e0eee0">map</span><span style="color: #7fff00">:</span><span style="color: #e0eee0">map_value</span><span style="color: #7fff00">:</span><span style="color: #00e5ee">'&gt;&gt;'</span><span style="color: #7fff00">:</span><span style="color: #00e5ee">'(no)'</span> }}<span style="color: #7fff00">&lt;</span>/p&gt;
<span style="color: gray; padding: 0 5px 0 5px"> 4</span>   <span style="color: #7fff00">&lt;</span>/div&gt;
<span style="color: gray; padding: 0 5px 0 5px"> 5</span>   
<span style="color: gray; padding: 0 5px 0 5px"> 6</span>   
<span style="color: gray; padding: 0 5px 0 5px"> 7</span>   <span style="color: #7fff00">&lt;</span><span style="color: #e0eee0">script</span> <span style="color: #e0eee0">type</span><span style="color: #7fff00">=</span><span style="color: #00e5ee">"text/javascript"</span><span style="color: #7fff00">&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 8</span>   
<span style="color: gray; padding: 0 5px 0 5px"> 9</span>   <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">app</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'Demo'</span>, [], <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">noop</span>);
<span style="color: gray; padding: 0 5px 0 5px">10</span>   <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">controller</span>(<span style="color: #00e5ee">'TestCtrl'</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>){
<span style="color: gray; padding: 0 5px 0 5px">11</span>     <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">map_value</span> <span style="color: #7fff00">=</span> {
<span style="color: gray; padding: 0 5px 0 5px">12</span>       <span style="color: #e0eee0">a</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'一'</span>,
<span style="color: gray; padding: 0 5px 0 5px">13</span>       <span style="color: #e0eee0">b</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'二'</span>,
<span style="color: gray; padding: 0 5px 0 5px">14</span>       <span style="color: #e0eee0">c</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'三'</span>
<span style="color: gray; padding: 0 5px 0 5px">15</span>     }
<span style="color: gray; padding: 0 5px 0 5px">16</span>     <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">a</span> <span style="color: #7fff00">=</span> <span style="color: #00e5ee">'a'</span>;
<span style="color: gray; padding: 0 5px 0 5px">17</span>   });
<span style="color: gray; padding: 0 5px 0 5px">18</span>   
<span style="color: gray; padding: 0 5px 0 5px">19</span>   <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">filter</span>(<span style="color: #00e5ee">'map'</span>, <span style="color: #bcd2ee">function</span>(){
<span style="color: gray; padding: 0 5px 0 5px">20</span>     <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">filter</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">input</span>, <span style="color: #e0eee0">map_value</span>, <span style="color: #e0eee0">append</span>, <span style="color: #e0eee0">default_value</span>){
<span style="color: gray; padding: 0 5px 0 5px">21</span>       <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">r</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">map_value</span>[<span style="color: #e0eee0">input</span>];
<span style="color: gray; padding: 0 5px 0 5px">22</span>       <span style="color: #90ee90">if</span>(<span style="color: #e0eee0">r</span> <span style="color: #7fff00">===</span> <span style="color: #90ee90">undefined</span>){ <span style="color: #90ee90">return</span> <span style="color: #e0eee0">default_value</span> <span style="color: #7fff00">+</span> <span style="color: #e0eee0">append</span> }
<span style="color: gray; padding: 0 5px 0 5px">23</span>       <span style="color: #90ee90">else</span> { <span style="color: #90ee90">return</span> <span style="color: #e0eee0">r</span> <span style="color: #7fff00">+</span> <span style="color: #e0eee0">append</span> }
<span style="color: gray; padding: 0 5px 0 5px">24</span>     };
<span style="color: gray; padding: 0 5px 0 5px">25</span>     <span style="color: #90ee90">return</span> <span style="color: #e0eee0">filter</span>;
<span style="color: gray; padding: 0 5px 0 5px">26</span>   });
<span style="color: gray; padding: 0 5px 0 5px">27</span>   
<span style="color: gray; padding: 0 5px 0 5px">28</span>   <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">bootstrap</span>(<span style="color: #e0eee0">document</span>, [<span style="color: #00e5ee">'Demo'</span>]);
<span style="color: gray; padding: 0 5px 0 5px">29</span>   <span style="color: #7fff00">&lt;</span>/script&gt;
</pre></div>


<a id="toc68" name="toc68"></a>
<h1 style=" -moz-border-radius: 5px; -webkit-border-radius: 5px; -moz-box-shadow: 3px 3px 5px #333; -webkit-box-shadow: 3px 3px 5px #333; box-shadow: 3px 3px 5px #333;  border-radius: 5px; background-color: #69ab01; padding: 4px; color: white; line-height: 1.3em; text-shadow: 2px 2px 2px black; margin: 20px auto; font-size: medium; clear: both;">18. 自定义指令directive</h1>

<p style="margin: 15px 0;">
这是 ng 最强大的一部分，也是最复杂最让人头疼的部分。
</p>
<p style="margin: 15px 0;">
目前我们看到的所谓“模板”系统，只不过是官方实现的几个指令而已。这意味着，通过自定义各种指令，我们不但可以完全定义一套“模板”系统，更可以把 HTML 页面直接打造成为一种 DSL （领域特定语言）。
</p>

<a id="toc69" name="toc69"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">18.1. 指令的使用</h2>

<p style="margin: 15px 0;">
使用指令时，它的名字可以有多种形式，把指令放在什么地方也有多种选择。
</p>
<p style="margin: 15px 0;">
通常，指令的定义名是形如 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">ngBind</code> 这样的 “camel cased” 形式。在使用时，它的引用名可以是：
</p>

<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li>ng:bind
</li>
<li>ng_bind
</li>
<li>ng-bind
</li>
<li>x-ng-bind
</li>
<li>data-ng-bind
</li>
</ul>

<p style="margin: 15px 0;">
你可以根据你自己是否有 “HTML validator” 洁癖来选择。
</p>
<p style="margin: 15px 0;">
指令可以放在多个地方，它们的作用相同：
</p>

<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li><code style="margin: auto 3px; color: #228b22; font-family: monospace; ">&lt;span my-dir="exp"&gt;&lt;/span&gt;</code> 作为标签的属性
</li>
<li><code style="margin: auto 3px; color: #228b22; font-family: monospace; ">&lt;span class="my-dir: exp;"&gt;&lt;/span&gt;</code> 作为标签类属性的值
</li>
<li><code style="margin: auto 3px; color: #228b22; font-family: monospace; ">&lt;my-dir&gt;&lt;/my-dir&gt;</code> 作为标签
</li>
<li><code style="margin: auto 3px; color: #228b22; font-family: monospace; ">&lt;!-- directive: my-dir exp --&gt;</code> 作为注释
</li>
</ul>

<p style="margin: 15px 0;">
这些方式可以使用指令定义中的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">restrict</code> 属性来控制。
</p>
<p style="margin: 15px 0;">
可以看出，指令即可以作为标签使用，也可以作为属性使用。仔细考虑一下，这在类 XML 的结构当中真算得上是一种神奇的机制。
</p>

<a id="toc70" name="toc70"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">18.2. 指令的执行过程</h2>

<p style="margin: 15px 0;">
ng 中对指令的解析与执行过程是这样的：
</p>

<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li>浏览器得到 HTML 字符串内容，解析得到 DOM 结构。
</li>
<li>ng 引入，把 DOM 结构扔给 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">$compile</code> 函数处理：
    <ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
    <li>找出 DOM 结构中有变量占位符
    </li>
    <li>匹配找出 DOM 中包含的所有指令引用
    </li>
    <li>把指令关联到 DOM 
    </li>
    <li>关联到 DOM 的多个指令按权重排列
    </li>
    <li>执行指令中的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">compile</code> 函数（改变 DOM 结构，返回 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">link</code> 函数）
    </li>
    <li>得到的所有 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">link</code> 函数组成一个列表作为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">$compile</code> 函数的返回
    </li>
    </ul>
</li>
<li>执行 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">link</code> 函数（连接模板的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">scope</code>）。
</li>
</ul>

<a id="toc71" name="toc71"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">18.3. 基本的自定义方法</h2>

<p style="margin: 15px 0;">
自定义一个指令可以非常非常的复杂，但是其基本的调用形式，同自定义服务大概是相同的：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #7fff00">&lt;</span><span style="color: #e0eee0">p</span> <span style="color: #e0eee0">show</span> <span style="color: #e0eee0">style</span><span style="color: #7fff00">=</span><span style="color: #00e5ee">"font-size: 12px;"</span><span style="color: #7fff00">&gt;&lt;</span>/p&gt;
  
  <span style="color: #7fff00">&lt;</span><span style="color: #e0eee0">script</span> <span style="color: #e0eee0">type</span><span style="color: #7fff00">=</span><span style="color: #00e5ee">"text/javascript"</span><span style="color: #7fff00">&gt;</span>
  
  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">app</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'Demo'</span>, [], <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">noop</span>);
  
  <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">directive</span>(<span style="color: #00e5ee">'show'</span>, <span style="color: #bcd2ee">function</span>(){
    <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">func</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">$element</span>, <span style="color: #e0eee0">$attrs</span>){
      <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">$scope</span>);
      <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">$element</span>);
      <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">$attrs</span>);
    }    
    <span style="color: #90ee90">return</span> <span style="color: #e0eee0">func</span>;
    <span style="color: #507080">//return {compile: function(){return func}}</span>
  });
  
  <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">bootstrap</span>(<span style="color: #e0eee0">document</span>, [<span style="color: #00e5ee">'Demo'</span>]);
  <span style="color: #7fff00">&lt;</span>/script&gt;
</pre></div>


<p style="margin: 15px 0;">
如果在 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">directive</code> 中直接返回一个函数，则这个函数会作为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">compile</code> 的返回值，也即是作为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">link</code> 函数使用。这里说的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">compile</code> 和 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">link</code> 都是一个指令的组成部分，一个完整的定义应该返回一个对象，这个对象包括了多个属性：
</p>

<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li>name
</li>
<li>priority
</li>
<li>terminal
</li>
<li>scope
</li>
<li>controller
</li>
<li>require
</li>
<li>restrict
</li>
<li>template
</li>
<li>templateUrl
</li>
<li>replace
</li>
<li>transclude
</li>
<li>compile
</li>
<li>link
</li>
</ul>

<p style="margin: 15px 0;">
上面的每一个属性，都可以单独探讨的。
</p>
<p style="margin: 15px 0;">
下面是一个完整的基本的指令定义例子：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;code</span> <span style="color: #e0eee0">lines&gt;</span>
  //失去焦点使用 jQuery 的扩展支持冒泡
  app.directive('ngBlur', function($parse){
    return function($scope, $element, $attr){
      var fn = $parse($attr['ngBlur']);
      $element.on('focusout', function(event){
        fn($scope, {$event: event});
      });
    }
  });
  <span style="color: #e0eee0">&lt;/code&gt;</span>
  
  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">code</span> <span style="color: #e0eee0">lines&gt;</span>
  //失去焦点使用 jQuery 的扩展支持冒泡
  app.directive('ngBlur', function($parse){
    return function($scope, $element, $attr){
      var fn = $parse($attr['ngBlur']);
      $element.on('focusout', function(event){
        fn($scope, {$event: event});
      });
    }
  });
  <span style="color: #e0eee0">&lt;/div&gt;</span>
</pre></div>



<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;"><span style="color: gray; padding: 0 5px 0 5px"> 1</span>   <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">app</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'Demo'</span>, [], <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">noop</span>);
<span style="color: gray; padding: 0 5px 0 5px"> 2</span>   
<span style="color: gray; padding: 0 5px 0 5px"> 3</span>   <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">directive</span>(<span style="color: #00e5ee">'code'</span>, <span style="color: #bcd2ee">function</span>(){
<span style="color: gray; padding: 0 5px 0 5px"> 4</span>     <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">func</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">$element</span>, <span style="color: #e0eee0">$attrs</span>){
<span style="color: gray; padding: 0 5px 0 5px"> 5</span>   
<span style="color: gray; padding: 0 5px 0 5px"> 6</span>       <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">html</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$element</span>.<span style="color: #e0eee0">text</span>();
<span style="color: gray; padding: 0 5px 0 5px"> 7</span>       <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">lines</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">html</span>.<span style="color: #e0eee0">split</span>(<span style="color: #00e5ee">'\n'</span>);
<span style="color: gray; padding: 0 5px 0 5px"> 8</span>   
<span style="color: gray; padding: 0 5px 0 5px"> 9</span>       <span style="color: #507080">//处理首尾空白</span>
<span style="color: gray; padding: 0 5px 0 5px">10</span>       <span style="color: #90ee90">if</span>(<span style="color: #e0eee0">lines</span>[<span style="color: #00ffff">0</span>] <span style="color: #7fff00">==</span> <span style="color: #00e5ee">''</span>){<span style="color: #e0eee0">lines</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">lines</span>.<span style="color: #e0eee0">slice</span>(<span style="color: #00ffff">1</span>, <span style="color: #e0eee0">lines</span>.<span style="color: #e0eee0">length</span> <span style="color: #7fff00">-</span> <span style="color: #00ffff">1</span>)}
<span style="color: gray; padding: 0 5px 0 5px">11</span>       <span style="color: #90ee90">if</span>(<span style="color: #e0eee0">lines</span>[<span style="color: #e0eee0">lines</span>.<span style="color: #e0eee0">length</span><span style="color: #7fff00">-</span><span style="color: #00ffff">1</span>] <span style="color: #7fff00">==</span> <span style="color: #00e5ee">''</span>){<span style="color: #e0eee0">lines</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">lines</span>.<span style="color: #e0eee0">slice</span>(<span style="color: #00ffff">0</span>, <span style="color: #e0eee0">lines</span>.<span style="color: #e0eee0">length</span> <span style="color: #7fff00">-</span> <span style="color: #00ffff">1</span>)}
<span style="color: gray; padding: 0 5px 0 5px">12</span>   
<span style="color: gray; padding: 0 5px 0 5px">13</span>       <span style="color: #e0eee0">$element</span>.<span style="color: #e0eee0">empty</span>();
<span style="color: gray; padding: 0 5px 0 5px">14</span>   
<span style="color: gray; padding: 0 5px 0 5px">15</span>       <span style="color: #507080">//处理外框</span>
<span style="color: gray; padding: 0 5px 0 5px">16</span>       (<span style="color: #bcd2ee">function</span>(){
<span style="color: gray; padding: 0 5px 0 5px">17</span>         <span style="color: #e0eee0">$element</span>.<span style="color: #e0eee0">css</span>(<span style="color: #00e5ee">'clear'</span>, <span style="color: #00e5ee">'both'</span>);
<span style="color: gray; padding: 0 5px 0 5px">18</span>         <span style="color: #e0eee0">$element</span>.<span style="color: #e0eee0">css</span>(<span style="color: #00e5ee">'display'</span>, <span style="color: #00e5ee">'block'</span>);
<span style="color: gray; padding: 0 5px 0 5px">19</span>         <span style="color: #e0eee0">$element</span>.<span style="color: #e0eee0">css</span>(<span style="color: #00e5ee">'line-height'</span>, <span style="color: #00e5ee">'20px'</span>);
<span style="color: gray; padding: 0 5px 0 5px">20</span>         <span style="color: #e0eee0">$element</span>.<span style="color: #e0eee0">css</span>(<span style="color: #00e5ee">'height'</span>, <span style="color: #00e5ee">'200px'</span>);
<span style="color: gray; padding: 0 5px 0 5px">21</span>       })();
<span style="color: gray; padding: 0 5px 0 5px">22</span>   
<span style="color: gray; padding: 0 5px 0 5px">23</span>       <span style="color: #507080">//是否显示行号的选项</span>
<span style="color: gray; padding: 0 5px 0 5px">24</span>       <span style="color: #90ee90">if</span>(<span style="color: #00e5ee">'lines'</span> <span style="color: #90ee90">in</span> <span style="color: #e0eee0">$attrs</span>){
<span style="color: gray; padding: 0 5px 0 5px">25</span>         <span style="color: #507080">//处理行号</span>
<span style="color: gray; padding: 0 5px 0 5px">26</span>         (<span style="color: #bcd2ee">function</span>(){
<span style="color: gray; padding: 0 5px 0 5px">27</span>           <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">div</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$</span>(<span style="color: #00e5ee">'&lt;div style="width: %spx; background-color: gray; float: left; text-align: right; padding-right: 5px; margin-right: 10px;"&gt;&lt;/div&gt;'</span>
<span style="color: gray; padding: 0 5px 0 5px">28</span>                       .<span style="color: #e0eee0">replace</span>(<span style="color: #00e5ee">'%s'</span>, <span style="color: #e0eee0">String</span>(<span style="color: #e0eee0">lines</span>.<span style="color: #e0eee0">length</span>).<span style="color: #e0eee0">length</span> <span style="color: #7fff00">*</span> <span style="color: #00ffff">10</span>));
<span style="color: gray; padding: 0 5px 0 5px">29</span>           <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">s</span> <span style="color: #7fff00">=</span> <span style="color: #00e5ee">''</span>;
<span style="color: gray; padding: 0 5px 0 5px">30</span>           <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">forEach</span>(<span style="color: #e0eee0">lines</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">_</span>, <span style="color: #e0eee0">i</span>){
<span style="color: gray; padding: 0 5px 0 5px">31</span>             <span style="color: #e0eee0">s</span> <span style="color: #7fff00">+=</span> <span style="color: #00e5ee">'&lt;pre style="margin: 0;"&gt;%s&lt;/pre&gt;\n'</span>.<span style="color: #e0eee0">replace</span>(<span style="color: #00e5ee">'%s'</span>, <span style="color: #e0eee0">i</span> <span style="color: #7fff00">+</span> <span style="color: #00ffff">1</span>);
<span style="color: gray; padding: 0 5px 0 5px">32</span>           });
<span style="color: gray; padding: 0 5px 0 5px">33</span>           <span style="color: #e0eee0">div</span>.<span style="color: #e0eee0">html</span>(<span style="color: #e0eee0">s</span>);
<span style="color: gray; padding: 0 5px 0 5px">34</span>           <span style="color: #e0eee0">$element</span>.<span style="color: #e0eee0">append</span>(<span style="color: #e0eee0">div</span>);
<span style="color: gray; padding: 0 5px 0 5px">35</span>         })();
<span style="color: gray; padding: 0 5px 0 5px">36</span>       }
<span style="color: gray; padding: 0 5px 0 5px">37</span>   
<span style="color: gray; padding: 0 5px 0 5px">38</span>       <span style="color: #507080">//处理内容</span>
<span style="color: gray; padding: 0 5px 0 5px">39</span>       (<span style="color: #bcd2ee">function</span>(){
<span style="color: gray; padding: 0 5px 0 5px">40</span>         <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">div</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$</span>(<span style="color: #00e5ee">'&lt;div style="float: left;"&gt;&lt;/div&gt;'</span>);
<span style="color: gray; padding: 0 5px 0 5px">41</span>         <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">s</span> <span style="color: #7fff00">=</span> <span style="color: #00e5ee">''</span>;
<span style="color: gray; padding: 0 5px 0 5px">42</span>         <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">forEach</span>(<span style="color: #e0eee0">lines</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">l</span>){
<span style="color: gray; padding: 0 5px 0 5px">43</span>           <span style="color: #e0eee0">s</span> <span style="color: #7fff00">+=</span> <span style="color: #00e5ee">'&lt;span style="margin: 0;"&gt;%s&lt;/span&gt;&lt;br /&gt;\n'</span>.<span style="color: #e0eee0">replace</span>(<span style="color: #00e5ee">'%s'</span>, <span style="color: #e0eee0">l</span>.<span style="color: #e0eee0">replace</span>(<span style="color: #00e5ee">/\s/g</span>, <span style="color: #00e5ee">'&lt;span&gt;&amp;nbsp;&lt;/span&gt;'</span>));
<span style="color: gray; padding: 0 5px 0 5px">44</span>         });
<span style="color: gray; padding: 0 5px 0 5px">45</span>         <span style="color: #e0eee0">div</span>.<span style="color: #e0eee0">html</span>(<span style="color: #e0eee0">s</span>);
<span style="color: gray; padding: 0 5px 0 5px">46</span>         <span style="color: #e0eee0">$element</span>.<span style="color: #e0eee0">append</span>(<span style="color: #e0eee0">div</span>);
<span style="color: gray; padding: 0 5px 0 5px">47</span>       })();
<span style="color: gray; padding: 0 5px 0 5px">48</span>     }
<span style="color: gray; padding: 0 5px 0 5px">49</span>   
<span style="color: gray; padding: 0 5px 0 5px">50</span>     <span style="color: #90ee90">return</span> {<span style="color: #e0eee0">link</span><span style="color: #7fff00">:</span> <span style="color: #e0eee0">func</span>,
<span style="color: gray; padding: 0 5px 0 5px">51</span>             <span style="color: #e0eee0">restrict</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'AE'</span>}; <span style="color: #507080">//以元素或属性的形式使用命令</span>
<span style="color: gray; padding: 0 5px 0 5px">52</span>   });
<span style="color: gray; padding: 0 5px 0 5px">53</span>   
<span style="color: gray; padding: 0 5px 0 5px">54</span>   <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">bootstrap</span>(<span style="color: #e0eee0">document</span>, [<span style="color: #00e5ee">'Demo'</span>]);
</pre></div>


<p style="margin: 15px 0;">
上面这个自定义的指令，做的事情就是解析节点中的文本内容，然后修改它，再把生成的新内容填充到节点当中去。其间还涉及了节点属性值 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">lines</code> 的处理。这算是指令中最简单的一种形式。因为它是“一次性使用”，中间没有变量的处理。比如如果节点原来的文本内容是一个变量引用，类似于 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">{{ code }}</code> ，那上面的代码就不行了。这种情况麻烦得多。后面会讨论。
</p>

<a id="toc72" name="toc72"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">18.4. 属性值类型的自定义</h2>

<p style="margin: 15px 0;">
官方代码中的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">ng-show</code> 等算是我说的这种类型。使用时主要是在节点加添加一个属性值以附加额外的功能。看一个简单的例子：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;p</span> <span style="color: #e0eee0">color=</span><span style="color: #00e5ee">"red"</span><span style="color: #e0eee0">&gt;</span>有颜色的文本<span style="color: #e0eee0">&lt;/p&gt;</span>
  <span style="color: #e0eee0">&lt;color</span> <span style="color: #e0eee0">color=</span><span style="color: #00e5ee">"red"</span><span style="color: #e0eee0">&gt;</span>有颜色的文本<span style="color: #e0eee0">&lt;/color&gt;</span>
  
  <span style="color: #e0eee0">&lt;script type=</span><span style="color: #00e5ee">"text/javascript"</span><span style="color: #e0eee0">&gt;</span>
  
  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">app</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'Demo'</span>, [], <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">noop</span>);
  
  <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">directive</span>(<span style="color: #00e5ee">'color'</span>, <span style="color: #bcd2ee">function</span>(){
    <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">link</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">$element</span>, <span style="color: #e0eee0">$attrs</span>){
      <span style="color: #e0eee0">$element</span>.<span style="color: #e0eee0">css</span>(<span style="color: #00e5ee">'color'</span>, <span style="color: #e0eee0">$attrs</span>.<span style="color: #e0eee0">color</span>);
    }
    <span style="color: #90ee90">return</span> {<span style="color: #e0eee0">link</span><span style="color: #7fff00">:</span> <span style="color: #e0eee0">link</span>,
            <span style="color: #e0eee0">restrict</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'AE'</span>};
  });
  
  <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">bootstrap</span>(<span style="color: #e0eee0">document</span>, [<span style="color: #00e5ee">'Demo'</span>]);
  <span style="color: #e0eee0">&lt;/script&gt;</span>
</pre></div>


<p style="margin: 15px 0;">
我们定义了一个叫 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">color</code> 的指令，可以指定节点文本的颜色。但是这个例子还无法像 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">ng-show</code> 那样工作的，这个例子只能渲染一次，然后就无法根据变量来重新改变显示了。要响应变化，我们需要手工使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">scope</code> 的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">$watch</code> 来处理：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;"><span style="color: gray; padding: 0 5px 0 5px"> 1</span>   
<span style="color: gray; padding: 0 5px 0 5px"> 2</span>   <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span><span style="color: #e0eee0">&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 3</span>     <span style="color: #e0eee0">&lt;p</span> <span style="color: #e0eee0">color=</span><span style="color: #00e5ee">"color"</span><span style="color: #e0eee0">&gt;</span>有颜色的文本<span style="color: #e0eee0">&lt;/p&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 4</span>     <span style="color: #e0eee0">&lt;p</span> <span style="color: #e0eee0">color=</span><span style="color: #00e5ee">"'blue'"</span><span style="color: #e0eee0">&gt;</span>有颜色的文本<span style="color: #e0eee0">&lt;/p&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 5</span>   <span style="color: #e0eee0">&lt;/div&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 6</span>   
<span style="color: gray; padding: 0 5px 0 5px"> 7</span>   <span style="color: #e0eee0">&lt;script type=</span><span style="color: #00e5ee">"text/javascript"</span><span style="color: #e0eee0">&gt;</span>
<span style="color: gray; padding: 0 5px 0 5px"> 8</span>   
<span style="color: gray; padding: 0 5px 0 5px"> 9</span>   <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">app</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'Demo'</span>, [], <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">noop</span>);
<span style="color: gray; padding: 0 5px 0 5px">10</span>   
<span style="color: gray; padding: 0 5px 0 5px">11</span>   <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">directive</span>(<span style="color: #00e5ee">'color'</span>, <span style="color: #bcd2ee">function</span>(){
<span style="color: gray; padding: 0 5px 0 5px">12</span>     <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">link</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">$element</span>, <span style="color: #e0eee0">$attrs</span>){
<span style="color: gray; padding: 0 5px 0 5px">13</span>       <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">$watch</span>(<span style="color: #e0eee0">$attrs</span>.<span style="color: #e0eee0">color</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">new_v</span>){
<span style="color: gray; padding: 0 5px 0 5px">14</span>         <span style="color: #e0eee0">$element</span>.<span style="color: #e0eee0">css</span>(<span style="color: #00e5ee">'color'</span>, <span style="color: #e0eee0">new_v</span>);
<span style="color: gray; padding: 0 5px 0 5px">15</span>       });
<span style="color: gray; padding: 0 5px 0 5px">16</span>     }
<span style="color: gray; padding: 0 5px 0 5px">17</span>     <span style="color: #90ee90">return</span> <span style="color: #e0eee0">link</span>;
<span style="color: gray; padding: 0 5px 0 5px">18</span>   });
<span style="color: gray; padding: 0 5px 0 5px">19</span>   
<span style="color: gray; padding: 0 5px 0 5px">20</span>   <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">controller</span>(<span style="color: #00e5ee">'TestCtrl'</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>){
<span style="color: gray; padding: 0 5px 0 5px">21</span>     <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">color</span> <span style="color: #7fff00">=</span> <span style="color: #00e5ee">'red'</span>;
<span style="color: gray; padding: 0 5px 0 5px">22</span>   });
<span style="color: gray; padding: 0 5px 0 5px">23</span>   
<span style="color: gray; padding: 0 5px 0 5px">24</span>   <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">bootstrap</span>(<span style="color: #e0eee0">document</span>, [<span style="color: #00e5ee">'Demo'</span>]);
<span style="color: gray; padding: 0 5px 0 5px">25</span>   <span style="color: #e0eee0">&lt;/script&gt;</span>
</pre></div>


<a id="toc73" name="toc73"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">18.5. Compile的细节</h2>

<p style="margin: 15px 0;">
指令的处理过程，是 ng 的 <i style=" color: #d75100; font-style: normal; ">Compile</i> 过程的一部分，它们也是紧密联系的。继续深入指令的定义方法，首先就要对 Compile 的过程做更细致的了解。
</p>
<p style="margin: 15px 0;">
前面说过， ng 对页面的处理过程：
</p>

<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li>浏览器把 HTML 字符串解析成 DOM 结构。
</li>
<li>ng 把 DOM 结构给 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">$compile</code> ，返回一个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">link</code> 函数。
</li>
<li>传入具体的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">scope</code> 调用这个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">link</code> 函数。
</li>
<li>得到处理后的 DOM ，这个 DOM 处理了指令，连接了数据。
</li>
</ul>

<p style="margin: 15px 0;">
<code style="margin: auto 3px; color: #228b22; font-family: monospace; ">$compile</code> 最基本的使用方式：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">link</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$compile</span>(<span style="color: #00e5ee">'&lt;p&gt;{{ text }}&lt;/p&gt;'</span>);
  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">node</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">link</span>(<span style="color: #e0eee0">$scope</span>);
  <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">node</span>);
</pre></div>


<p style="margin: 15px 0;">
上面的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">$compile</code> 和 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">link</code> 调用时都有额外参数来实现其它功能。先看 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">link</code> 函数，它形如：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">scope</span>[, <span style="color: #e0eee0">cloneAttachFn</span>]
</pre></div>


<p style="margin: 15px 0;">
第二个参数 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">cloneAttachFn</code> 的作用是，表明是否复制原始节点，及对复制节点需要做的处理，下面这个例子说明了它的作用：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span><span style="color: #e0eee0">&gt;&lt;/div&gt;</span>
  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">id=</span><span style="color: #00e5ee">"a"</span><span style="color: #e0eee0">&gt;</span>A {{ text }}<span style="color: #e0eee0">&lt;/div&gt;</span>
  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">id=</span><span style="color: #00e5ee">"b"</span><span style="color: #e0eee0">&gt;</span>B <span style="color: #e0eee0">&lt;/div&gt;</span>
</pre></div>



<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">controller</span>(<span style="color: #00e5ee">'TestCtrl'</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">$compile</span>){
    <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">link</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$compile</span>(<span style="color: #e0eee0">$</span>(<span style="color: #00e5ee">'#a'</span>));
  
    <span style="color: #507080">//true参数表示新建一个完全隔离的scope,而不是继承的child scope</span>
    <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">scope</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">$new</span>(<span style="color: #90ee90">true</span>);
    <span style="color: #e0eee0">scope</span>.<span style="color: #e0eee0">text</span> <span style="color: #7fff00">=</span> <span style="color: #00e5ee">'12345'</span>;
  
    <span style="color: #507080">//var node = link(scope, function(){});</span>
    <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">node</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">link</span>(<span style="color: #e0eee0">scope</span>);
  
    <span style="color: #e0eee0">$</span>(<span style="color: #00e5ee">'#b'</span>).<span style="color: #e0eee0">append</span>(<span style="color: #e0eee0">node</span>);
  });
</pre></div>


<p style="margin: 15px 0;">
<code style="margin: auto 3px; color: #228b22; font-family: monospace; ">cloneAttachFn</code> 对节点的处理是有限制的，你可以添加 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">class</code> ，但是不能做与数据绑定有关的其它修改（修改了也无效）：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">controller</span>(<span style="color: #00e5ee">'TestCtrl'</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">$compile</span>){
    <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">link</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$compile</span>(<span style="color: #e0eee0">$</span>(<span style="color: #00e5ee">'#a'</span>));
    <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">scope</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">$new</span>(<span style="color: #90ee90">true</span>);
    <span style="color: #e0eee0">scope</span>.<span style="color: #e0eee0">text</span> <span style="color: #7fff00">=</span> <span style="color: #00e5ee">'12345'</span>;
  
    <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">node</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">link</span>(<span style="color: #e0eee0">scope</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">clone_element</span>, <span style="color: #e0eee0">scope</span>){
      <span style="color: #e0eee0">clone_element</span>.<span style="color: #e0eee0">text</span>(<span style="color: #e0eee0">clone_element</span>.<span style="color: #e0eee0">text</span>() <span style="color: #7fff00">+</span> <span style="color: #00e5ee">' ...'</span>); <span style="color: #507080">//无效</span>
      <span style="color: #e0eee0">clone_element</span>.<span style="color: #e0eee0">text</span>(<span style="color: #00e5ee">'{{ text2 }}'</span>); <span style="color: #507080">//无效</span>
      <span style="color: #e0eee0">clone_element</span>.<span style="color: #e0eee0">addClass</span>(<span style="color: #00e5ee">'new_class'</span>);
    });
  
    <span style="color: #e0eee0">$</span>(<span style="color: #00e5ee">'#b'</span>).<span style="color: #e0eee0">append</span>(<span style="color: #e0eee0">node</span>);
  });
</pre></div>


<p style="margin: 15px 0;">
修改无效的原因是，像 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">{{ text }}</code> 这种所谓的 <i style=" color: #d75100; font-style: normal; ">Interpolate</i> 在 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">$compile</code> 中已经被处理过了，生成了相关函数（这里起作用的是 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">directive</code> 中的一个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">postLink</code> 函数），后面执行 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">link</code> 就是执行了 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">$compile</code> 生成的这些函数。当然，如果你的文本没有数据变量的引用，那修改是会有效果的。
</p>
<p style="margin: 15px 0;">
前面在说自定义指令时说过， <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">link</code> 函数是由 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">compile</code> 函数返回的，也就像前面说的，应该把改变 DOM 结构的逻辑放在 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">compile</code> 函数中做。
</p>
<p style="margin: 15px 0;">
<code style="margin: auto 3px; color: #228b22; font-family: monospace; ">$compile</code> 还有两个额外的参数：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">$compile</span>(<span style="color: #e0eee0">element</span>, <span style="color: #e0eee0">transclude</span>, <span style="color: #e0eee0">maxPriority</span>);
</pre></div>


<p style="margin: 15px 0;">
<code style="margin: auto 3px; color: #228b22; font-family: monospace; ">maxPriority</code> 是指令的权重限制，这个容易理解，后面再说。
</p>
<p style="margin: 15px 0;">
<code style="margin: auto 3px; color: #228b22; font-family: monospace; ">transclude</code> 是一个函数，这个函数会传递给 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">compile</code> 期间找到的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">directive</code> 的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">compile</code> 函数（编译节点的过程中找到了指令，指令的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">compile</code> 函数会接受编译时传递的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">transclude</code> 函数作为其参数）。
</p>
<p style="margin: 15px 0;">
但是在实际使用中，除我们手工在调用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">$compile</code> 之外，初始化时的根节点 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">compile</code> 是不会传递这个参数的。
</p>
<p style="margin: 15px 0;">
在我们定义指令时，它的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">compile</code> 函数是这个样子的：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">function</span> <span style="color: #e0eee0">compile</span>(<span style="color: #e0eee0">tElement</span>, <span style="color: #e0eee0">tAttrs</span>, <span style="color: #e0eee0">transclude</span>) { ... }
</pre></div>


<p style="margin: 15px 0;">
事实上， <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">transclude</code> 的值，就是 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">directive</code> 所在的 <b style=" color: red; font-weight: normal; ">原始</b> 节点，把原始节点重新做了编译之后得到的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">link</code> 函数（需要 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">directive</code> 定义时使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">transclude</code> 选项），后面会专门演示这个过程。所以，官方文档上也把 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">transclude</code> 函数描述成 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">link</code> 函数的样子（如果自定义的指令只用在自己手动 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">$compile</code> 的环境中，那这个函数的形式是可以随意的）：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  {<span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">Scope</span>[, <span style="color: #e0eee0">cloneAttachFn</span>]}
</pre></div>


<p style="margin: 15px 0;">
所以记住，定义指令时， <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">compile</code> 函数的第三个参数 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">transclude</code> ，就是一个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">link</code> ，装入 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">scope</code> 执行它你就得到了一个节点。
</p>

<a id="toc74" name="toc74"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">18.6. transclude的细节</h2>

<p style="margin: 15px 0;">
<code style="margin: auto 3px; color: #228b22; font-family: monospace; ">transclude</code> 有两方面的东西，一个是使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">$compile</code> 时传入的函数，另一个是定义指令的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">compile</code> 函数时接受的一个参数。虽然这里的一出一进本来是相互对应的，但是实际使用中，因为大部分时候不会手动调用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">$compile</code> ，所以，在“默认”情况下，指令接受的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">transclude</code> 又会是一个比较特殊的函数。
</p>
<p style="margin: 15px 0;">
看一个基本的例子：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">app</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'Demo'</span>, [], <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">noop</span>);
  
  <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">directive</span>(<span style="color: #00e5ee">'more'</span>, <span style="color: #bcd2ee">function</span>(){
    <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">func</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">element</span>, <span style="color: #e0eee0">attrs</span>, <span style="color: #e0eee0">transclude</span>){
      <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">sum</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">transclude</span>(<span style="color: #00ffff">1</span>, <span style="color: #00ffff">2</span>);
      <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">sum</span>);
      <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">element</span>);  
    }
  
    <span style="color: #90ee90">return</span> {<span style="color: #e0eee0">compile</span><span style="color: #7fff00">:</span> <span style="color: #e0eee0">func</span>,
            <span style="color: #e0eee0">restrict</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'E'</span>};
  });
  
  <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">controller</span>(<span style="color: #00e5ee">'TestCtrl'</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">$compile</span>, <span style="color: #e0eee0">$element</span>){
    <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">s</span> <span style="color: #7fff00">=</span> <span style="color: #00e5ee">'&lt;more&gt;123&lt;/more&gt;'</span>;
    <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">link</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$compile</span>(<span style="color: #e0eee0">s</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">a</span>, <span style="color: #e0eee0">b</span>){<span style="color: #90ee90">return</span> <span style="color: #e0eee0">a</span> <span style="color: #7fff00">+</span> <span style="color: #e0eee0">b</span>});
    <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">node</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">link</span>(<span style="color: #e0eee0">$scope</span>);
    <span style="color: #e0eee0">$element</span>.<span style="color: #e0eee0">append</span>(<span style="color: #e0eee0">node</span>);
  });
  
  <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">bootstrap</span>(<span style="color: #e0eee0">document</span>, [<span style="color: #00e5ee">'Demo'</span>]);
</pre></div>


<p style="margin: 15px 0;">
我们定义了一个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">more</code> 指令，它的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">compile</code> 函数的第三个参数，就是我们手工 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">$compile</code> 时传入的。
</p>
<p style="margin: 15px 0;">
如果不是手工 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">$compile</code> ，而是 ng 初始化时找出的指令，则 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">transclude</code> 是一个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">link</code> 函数（指令定义需要设置 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">transclude</code> 选项）：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">more&gt;</span>123<span style="color: #e0eee0">&lt;/div&gt;</span>
</pre></div>



<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">directive</span>(<span style="color: #00e5ee">'more'</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$rootScope</span>, <span style="color: #e0eee0">$document</span>){
    <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">func</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">element</span>, <span style="color: #e0eee0">attrs</span>, <span style="color: #e0eee0">link</span>){
      <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">node</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">link</span>(<span style="color: #e0eee0">$rootScope</span>);
      <span style="color: #e0eee0">node</span>.<span style="color: #e0eee0">removeAttr</span>(<span style="color: #00e5ee">'more'</span>); <span style="color: #507080">//不去掉就变死循环了</span>
      <span style="color: #e0eee0">$</span>(<span style="color: #00e5ee">'body'</span>, <span style="color: #e0eee0">$document</span>).<span style="color: #e0eee0">append</span>(<span style="color: #e0eee0">node</span>);
    }
  
    <span style="color: #90ee90">return</span> {<span style="color: #e0eee0">compile</span><span style="color: #7fff00">:</span> <span style="color: #e0eee0">func</span>,
            <span style="color: #e0eee0">transclude</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'element'</span>, <span style="color: #507080">// element是节点没,其它值是节点的内容没</span>
            <span style="color: #e0eee0">restrict</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'A'</span>};
  });
</pre></div>


<a id="toc75" name="toc75"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">18.7. 把节点内容作为变量处理的类型</h2>

<p style="margin: 15px 0;">
回顾最开始的那个代码显示的例子，那个例子只能处理一次节点内容。如果节点的内容是一个变量的话，需要用另外的思路来考虑。这里我们假设的例子是，定义一个指令 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">showLenght</code> ，它的作用是在一段文本的开头显示出这段节点文本的长度，节点文本是一个变量。指令使用的形式是：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">show-length&gt;</span>{{ text }}<span style="color: #e0eee0">&lt;/div&gt;</span>
    <span style="color: #e0eee0">&lt;button</span> <span style="color: #e0eee0">ng-click=</span><span style="color: #00e5ee">"text='xx'"</span><span style="color: #e0eee0">&gt;</span>改变<span style="color: #e0eee0">&lt;/button&gt;</span>
  <span style="color: #e0eee0">&lt;/div&gt;</span>
</pre></div>


<p style="margin: 15px 0;">
从上面的 HTML 代码中，大概清楚 ng 解析它的过程（只看 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">show-length</code> 那一行）：
</p>

<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li>解析 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">div</code> 时发现了一个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">show-length</code> 的指令。
</li>
<li>如果 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">show-length</code> 指令设置了 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">transclude</code> 属性，则 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">div</code> 的节点内容被重新编译，得到的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">link</code> 函数作为指令 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">compile</code> 函数的参数传入。
</li>
<li>如果 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">show-length</code> 指令没有设置 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">transclude</code> 属性，则继续处理它的子节点（ <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">TextNode</code> ）。
</li>
<li>不管是上面的哪种情况，都会继续处理到 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">{{ text }}</code> 这段文本。
</li>
<li>发现 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">{{ text }}</code> 是一个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">Interpolate</code> ，于是自动在此节点中添加了一个指令，这个指令的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">link</code> 函数就是为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">scope</code> 添加了一个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">$watch</code> ，实现的功能是是当 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">scope</code> 作 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">$digest</code> 的时候，就更新节点文本。
</li>
</ul>

<p style="margin: 15px 0;">
与处理 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">{{ text }}</code> 时添加的指令相同，我们实现 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">showLength</code> 的思路，也就是：
</p>

<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li>修改原来的 DOM 结构
</li>
<li>为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">scope</code> 添加 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">$watch</code> ，当 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">$digest</code> 时修改指定节点的文本，其值为指定节点文本的长度。
</li>
</ul>

<p style="margin: 15px 0;">
代码如下：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">directive</span>(<span style="color: #00e5ee">'showLength'</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$rootScope</span>, <span style="color: #e0eee0">$document</span>){
    <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">func</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">element</span>, <span style="color: #e0eee0">attrs</span>, <span style="color: #e0eee0">link</span>){
  
      <span style="color: #90ee90">return</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">scope</span>, <span style="color: #e0eee0">ielement</span>, <span style="color: #e0eee0">iattrs</span>, <span style="color: #e0eee0">controller</span>){
        <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">node</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">link</span>(<span style="color: #e0eee0">scope</span>);
        <span style="color: #e0eee0">ielement</span>.<span style="color: #e0eee0">append</span>(<span style="color: #e0eee0">node</span>);
        <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">lnode</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$</span>(<span style="color: #00e5ee">'&lt;span&gt;&lt;/span&gt;'</span>);
        <span style="color: #e0eee0">ielement</span>.<span style="color: #e0eee0">prepend</span>(<span style="color: #e0eee0">lnode</span>);
  
        <span style="color: #e0eee0">scope</span>.<span style="color: #e0eee0">$watch</span>(<span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">scope</span>){
          <span style="color: #e0eee0">lnode</span>.<span style="color: #e0eee0">text</span>(<span style="color: #e0eee0">node</span>.<span style="color: #e0eee0">text</span>().<span style="color: #e0eee0">length</span>);
        });
      };
    }
  
    <span style="color: #90ee90">return</span> {<span style="color: #e0eee0">compile</span><span style="color: #7fff00">:</span> <span style="color: #e0eee0">func</span>,
            <span style="color: #e0eee0">transclude</span><span style="color: #7fff00">:</span> <span style="color: #90ee90">true</span>, <span style="color: #507080">// element是节点没,其它值是节点的内容没</span>
            <span style="color: #e0eee0">restrict</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'A'</span>};
  });
</pre></div>


<p style="margin: 15px 0;">
上面代码中，因为设置了 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">transclude</code> 属性，我们在 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">showLength</code> 的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">link</code> 函数（就是 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">return</code> 的那个函数）中，使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">func</code> 的第三个函数来重塑了原来的文本节点，并放在我们需要的位置上。然后，我们添加自己的节点来显示长度值。最后给当前的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">scope</code> 添加 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">$watch</code> ，以更新这个长度值。
</p>

<a id="toc76" name="toc76"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">18.8. 指令定义时的参数</h2>

<p style="margin: 15px 0;">
指令定义时的参数如下：
</p>

<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li>name
</li>
<li>priority
</li>
<li>terminal
</li>
<li>scope
</li>
<li>controller
</li>
<li>require
</li>
<li>restrict
</li>
<li>template
</li>
<li>templateUrl
</li>
<li>replace
</li>
<li>transclude
</li>
<li>compile
</li>
<li>link
</li>
</ul>

<p style="margin: 15px 0;">
现在我们开始一个一个地吃掉它们……，但是并不是按顺序讲的。
</p>

<dl style="font-size: small; margin: 10px auto; padding: 10px; border-bottom: 1px dashed gray; border-top: 1px dashed gray;">
<dt style="border-left: 4px solid rgb(215, 81, 0); padding-left: 5px; margin: 5px auto;"><i style=" color: #d75100; font-style: normal; ">priority</i></dt><dd style="margin-left: 30px;">
    这个值设置指令的权重，默认是 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">0</code> 。当一个节点中有多个指令存在时，就按着权限从大到小的顺序依次执行它们的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">compile</code> 函数。相同权重顺序不定。
</dd>
<dt style="border-left: 4px solid rgb(215, 81, 0); padding-left: 5px; margin: 5px auto;"><i style=" color: #d75100; font-style: normal; ">terminal</i></dt><dd style="margin-left: 30px;">
    是否以当前指令的权重为结束界限。如果这值设置为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">true</code> ，则节点中权重小于当前指令的其它指令不会被执行。相同权重的会执行。
</dd>
<dt style="border-left: 4px solid rgb(215, 81, 0); padding-left: 5px; margin: 5px auto;"><i style=" color: #d75100; font-style: normal; ">restrict</i></dt><dd style="margin-left: 30px;">
    指令可以以哪些方式被使用，可以同时定义多种方式。
    <ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
    <li>E 元素方式 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">&lt;my-directive&gt;&lt;/my-directive&gt;</code>
    </li>
    <li>A 属性方式 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">&lt;div my-directive="exp"&gt; &lt;/div&gt;</code>
    </li>
    <li>C 类方式 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">&lt;div class="my-directive: exp;"&gt;&lt;/div&gt;</code>
    </li>
    <li>M 注释方式 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">&lt;!-- directive: my-directive exp --&gt;</code>
    </li>
    </ul>
</dd>
<dt style="border-left: 4px solid rgb(215, 81, 0); padding-left: 5px; margin: 5px auto;"><i style=" color: #d75100; font-style: normal; ">transclude</i></dt><dd style="margin-left: 30px;">
    前面已经讲过基本的用法了。可以是 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">'element'</code> 或 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">true</code> 两种值。
</dd>
<dt style="border-left: 4px solid rgb(215, 81, 0); padding-left: 5px; margin: 5px auto;"><i style=" color: #d75100; font-style: normal; ">compile</i></dt><dd style="margin-left: 30px;">
    基本的定义函数。 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">function compile(tElement, tAttrs, transclude) { ... }</code>
</dd>
<dt style="border-left: 4px solid rgb(215, 81, 0); padding-left: 5px; margin: 5px auto;"><i style=" color: #d75100; font-style: normal; ">link</i></dt><dd style="margin-left: 30px;">
    前面介绍过了。大多数时候我们不需要单独定义它。只有 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">compile</code> 未定义时 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">link</code> 才会被尝试。 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">function link(scope, iElement, iAttrs, controller) { ... }</code>
</dd>
<dt style="border-left: 4px solid rgb(215, 81, 0); padding-left: 5px; margin: 5px auto;"><i style=" color: #d75100; font-style: normal; ">scope</i></dt><dd style="margin-left: 30px;">
    scope 的形式。 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">false</code> 节点的 scope ， <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">true</code> 继承创建一个新的 scope ， <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">{}</code> 不继承创建一个新的隔离 scope 。 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">{@attr: '引用节点属性', =attr: '把节点属性值引用成scope属性值', &amp;attr: '把节点属性值包装成函数'}</code>
</dd>
<dt style="border-left: 4px solid rgb(215, 81, 0); padding-left: 5px; margin: 5px auto;"><i style=" color: #d75100; font-style: normal; ">controller</i></dt><dd style="margin-left: 30px;">
    为指令定义一个 controller ， <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">function controller($scope, $element, $attrs, $transclude) { ... }</code>
</dd>
<dt style="border-left: 4px solid rgb(215, 81, 0); padding-left: 5px; margin: 5px auto;"><i style=" color: #d75100; font-style: normal; ">name</i></dt><dd style="margin-left: 30px;">
    指令的 controller 的名字，方便其它指令引用。
</dd>
<dt style="border-left: 4px solid rgb(215, 81, 0); padding-left: 5px; margin: 5px auto;"><i style=" color: #d75100; font-style: normal; ">require</i></dt><dd style="margin-left: 30px;">
    要引用的其它指令 conroller 的名字， <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">?name</code> 忽略不存在的错误， <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">^name</code> 在父级查找。
</dd>
<dt style="border-left: 4px solid rgb(215, 81, 0); padding-left: 5px; margin: 5px auto;"><i style=" color: #d75100; font-style: normal; ">template</i></dt><dd style="margin-left: 30px;">
    模板内容。
</dd>
<dt style="border-left: 4px solid rgb(215, 81, 0); padding-left: 5px; margin: 5px auto;"><i style=" color: #d75100; font-style: normal; ">templateUrl</i></dt><dd style="margin-left: 30px;">
    从指定地址获取模板内容。
</dd>
<dt style="border-left: 4px solid rgb(215, 81, 0); padding-left: 5px; margin: 5px auto;"><i style=" color: #d75100; font-style: normal; ">replace</i></dt><dd style="margin-left: 30px;">
    是否使用模板内容替换掉整个节点， <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">true</code> 替换整个节点， <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">false</code> 替换节点内容。
</dd>
</dl>


<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;a</span> <span style="color: #e0eee0">b&gt;&lt;/a&gt;</span>
</pre></div>



<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">app</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'Demo'</span>, [], <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">noop</span>);
  
  <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">directive</span>(<span style="color: #00e5ee">'a'</span>, <span style="color: #bcd2ee">function</span>(){
    <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">func</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">element</span>, <span style="color: #e0eee0">attrs</span>, <span style="color: #e0eee0">link</span>){
      <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #00e5ee">'a'</span>);
    }
  
    <span style="color: #90ee90">return</span> {<span style="color: #e0eee0">compile</span><span style="color: #7fff00">:</span> <span style="color: #e0eee0">func</span>,
            <span style="color: #e0eee0">priority</span><span style="color: #7fff00">:</span> <span style="color: #00ffff">1</span>,
            <span style="color: #e0eee0">restrict</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'EA'</span>};
  });
  
  <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">directive</span>(<span style="color: #00e5ee">'b'</span>, <span style="color: #bcd2ee">function</span>(){
    <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">func</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">element</span>, <span style="color: #e0eee0">attrs</span>, <span style="color: #e0eee0">link</span>){
      <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #00e5ee">'b'</span>);
    }
  
    <span style="color: #90ee90">return</span> {<span style="color: #e0eee0">compile</span><span style="color: #7fff00">:</span> <span style="color: #e0eee0">func</span>,
            <span style="color: #e0eee0">priority</span><span style="color: #7fff00">:</span> <span style="color: #00ffff">2</span>,
            <span style="color: #507080">//terminal: true,</span>
            <span style="color: #e0eee0">restrict</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'A'</span>};
  });
</pre></div>


<p style="margin: 15px 0;">
上面几个参数值都是比较简单且容易理想的。
</p>
<p style="margin: 15px 0;">
再看 <i style=" color: #d75100; font-style: normal; ">scope</i> 这个参数：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">a</span> <span style="color: #e0eee0">b&gt;&lt;/div&gt;</span>
  <span style="color: #e0eee0">&lt;/div&gt;</span>
</pre></div>



<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;"><span style="color: gray; padding: 0 5px 0 5px"> 1</span>   <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">app</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'Demo'</span>, [], <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">noop</span>);
<span style="color: gray; padding: 0 5px 0 5px"> 2</span>   
<span style="color: gray; padding: 0 5px 0 5px"> 3</span>   <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">directive</span>(<span style="color: #00e5ee">'a'</span>, <span style="color: #bcd2ee">function</span>(){
<span style="color: gray; padding: 0 5px 0 5px"> 4</span>     <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">func</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">element</span>, <span style="color: #e0eee0">attrs</span>, <span style="color: #e0eee0">link</span>){
<span style="color: gray; padding: 0 5px 0 5px"> 5</span>       <span style="color: #90ee90">return</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">scope</span>){
<span style="color: gray; padding: 0 5px 0 5px"> 6</span>         <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">scope</span>);
<span style="color: gray; padding: 0 5px 0 5px"> 7</span>       }
<span style="color: gray; padding: 0 5px 0 5px"> 8</span>     }
<span style="color: gray; padding: 0 5px 0 5px"> 9</span>   
<span style="color: gray; padding: 0 5px 0 5px">10</span>     <span style="color: #90ee90">return</span> {<span style="color: #e0eee0">compile</span><span style="color: #7fff00">:</span> <span style="color: #e0eee0">func</span>,
<span style="color: gray; padding: 0 5px 0 5px">11</span>             <span style="color: #e0eee0">scope</span><span style="color: #7fff00">:</span> <span style="color: #90ee90">true</span>,
<span style="color: gray; padding: 0 5px 0 5px">12</span>             <span style="color: #e0eee0">restrict</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'A'</span>};
<span style="color: gray; padding: 0 5px 0 5px">13</span>   });
<span style="color: gray; padding: 0 5px 0 5px">14</span>   
<span style="color: gray; padding: 0 5px 0 5px">15</span>   <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">directive</span>(<span style="color: #00e5ee">'b'</span>, <span style="color: #bcd2ee">function</span>(){
<span style="color: gray; padding: 0 5px 0 5px">16</span>     <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">func</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">element</span>, <span style="color: #e0eee0">attrs</span>, <span style="color: #e0eee0">link</span>){
<span style="color: gray; padding: 0 5px 0 5px">17</span>       <span style="color: #90ee90">return</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">scope</span>){
<span style="color: gray; padding: 0 5px 0 5px">18</span>         <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">scope</span>);
<span style="color: gray; padding: 0 5px 0 5px">19</span>       }
<span style="color: gray; padding: 0 5px 0 5px">20</span>     }
<span style="color: gray; padding: 0 5px 0 5px">21</span>   
<span style="color: gray; padding: 0 5px 0 5px">22</span>     <span style="color: #90ee90">return</span> {<span style="color: #e0eee0">compile</span><span style="color: #7fff00">:</span> <span style="color: #e0eee0">func</span>,
<span style="color: gray; padding: 0 5px 0 5px">23</span>             <span style="color: #e0eee0">restrict</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'A'</span>};
<span style="color: gray; padding: 0 5px 0 5px">24</span>   });
<span style="color: gray; padding: 0 5px 0 5px">25</span>   
<span style="color: gray; padding: 0 5px 0 5px">26</span>   <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">controller</span>(<span style="color: #00e5ee">'TestCtrl'</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>){
<span style="color: gray; padding: 0 5px 0 5px">27</span>     <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">a</span> <span style="color: #7fff00">=</span> <span style="color: #00e5ee">'123'</span>;
<span style="color: gray; padding: 0 5px 0 5px">28</span>     <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">$scope</span>);
<span style="color: gray; padding: 0 5px 0 5px">29</span>   });
</pre></div>


<p style="margin: 15px 0;">
对于 <i style=" color: #d75100; font-style: normal; ">scope</i> ：
</p>

<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li>默认为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">false</code> ， <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">link</code> 函数接受的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">scope</code> 为节点所在的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">scope</code> 。
</li>
<li>为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">true</code> 时，则 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">link</code> 函数中第一个参数（还有 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">controller</code> 参数中的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">$scope</code> ）， <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">scope</code> 是节点所在的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">scope</code> 的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">child scope</code> ，并且如果节点中有多个指令，则只要其中一个指令是 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">true</code> 的设置，其它所有指令都会受影响。
</li>
</ul>

<p style="margin: 15px 0;">
这个参数还有其它取值。当其为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">{}</code> 时，则 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">link</code> 接受一个完全隔离（isolate）的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">scope</code> ，于 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">true</code> 的区别就是不会继承其它 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">scope</code> 的属性。但是这时，这个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">scope</code> 的属性却可以有很灵活的定义方式：
</p>
<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">@attr</i> 引用节点的属性。
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">a</span> <span style="color: #e0eee0">abc=</span><span style="color: #00e5ee">"here"</span> <span style="color: #e0eee0">xx=</span><span style="color: #00e5ee">"{{ a }}"</span> <span style="color: #e0eee0">c=</span><span style="color: #00e5ee">"ccc"</span><span style="color: #e0eee0">&gt;&lt;/div&gt;</span>
  <span style="color: #e0eee0">&lt;/div&gt;</span>
</pre></div>



<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">app</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'Demo'</span>, [], <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">noop</span>);
  
  <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">directive</span>(<span style="color: #00e5ee">'a'</span>, <span style="color: #bcd2ee">function</span>(){
    <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">func</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">element</span>, <span style="color: #e0eee0">attrs</span>, <span style="color: #e0eee0">link</span>){
      <span style="color: #90ee90">return</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">scope</span>){
        <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">scope</span>);
      }
    }
  
    <span style="color: #90ee90">return</span> {<span style="color: #e0eee0">compile</span><span style="color: #7fff00">:</span> <span style="color: #e0eee0">func</span>,
            <span style="color: #e0eee0">scope</span><span style="color: #7fff00">:</span> {<span style="color: #e0eee0">a</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'@abc'</span>, <span style="color: #e0eee0">b</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'@xx'</span>, <span style="color: #e0eee0">c</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'@'</span>},
            <span style="color: #e0eee0">restrict</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'A'</span>};
  });
  
  <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">controller</span>(<span style="color: #00e5ee">'TestCtrl'</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>){
    <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">a</span> <span style="color: #7fff00">=</span> <span style="color: #00e5ee">'123'</span>;
  });
</pre></div>


<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li><i style=" color: #d75100; font-style: normal; ">@abc</i> 引用 div 节点的 abc 属性。
</li>
<li><i style=" color: #d75100; font-style: normal; ">@xx</i> 引用 div 节点的 xx 属性，而 xx 属性又是一个变量绑定，于是 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">scope</code> 中 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">b</code> 属性值就和 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">TestCtrl</code> 的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">a</code> 变量绑定在一起了。
</li>
<li><i style=" color: #d75100; font-style: normal; ">@</i> 没有写 attr name ，则默认取自己的值，这里是取 div 的 c 属性。
</li>
</ul>

<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">=attr</i> 相似，只是它把节点的属性值当成节点 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">scope</code> 的属性名来使用，作用相当于上面例子中的 <i style=" color: #d75100; font-style: normal; ">@xx</i> ：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">a</span> <span style="color: #e0eee0">abc=</span><span style="color: #00e5ee">"here"</span><span style="color: #e0eee0">&gt;&lt;/div&gt;</span>
  <span style="color: #e0eee0">&lt;/div&gt;</span>
</pre></div>



<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">app</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'Demo'</span>, [], <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">noop</span>);
  
  <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">directive</span>(<span style="color: #00e5ee">'a'</span>, <span style="color: #bcd2ee">function</span>(){
    <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">func</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">element</span>, <span style="color: #e0eee0">attrs</span>, <span style="color: #e0eee0">link</span>){
      <span style="color: #90ee90">return</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">scope</span>){
        <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">scope</span>);
      }
    }
  
    <span style="color: #90ee90">return</span> {<span style="color: #e0eee0">compile</span><span style="color: #7fff00">:</span> <span style="color: #e0eee0">func</span>,
            <span style="color: #e0eee0">scope</span><span style="color: #7fff00">:</span> {<span style="color: #e0eee0">a</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'=abc'</span>},
            <span style="color: #e0eee0">restrict</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'A'</span>};
  });
  
  <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">controller</span>(<span style="color: #00e5ee">'TestCtrl'</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>){
    <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">here</span> <span style="color: #7fff00">=</span> <span style="color: #00e5ee">'123'</span>;
  });
</pre></div>


<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">&amp;attr</i> 是包装一个函数出来，这个函数以节点所在的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">scope</code> 为上下文。来看一个很爽的例子：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">a</span> <span style="color: #e0eee0">abc=</span><span style="color: #00e5ee">"here = here + 1"</span> <span style="color: #e0eee0">ng-click=</span><span style="color: #00e5ee">"show(here)"</span><span style="color: #e0eee0">&gt;</span>这里<span style="color: #e0eee0">&lt;/div&gt;</span>
    <span style="color: #e0eee0">&lt;div&gt;</span>{{ here }}<span style="color: #e0eee0">&lt;/div&gt;</span>
  <span style="color: #e0eee0">&lt;/div&gt;</span>
</pre></div>



<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;"><span style="color: gray; padding: 0 5px 0 5px"> 1</span>   <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">app</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'Demo'</span>, [], <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">noop</span>);
<span style="color: gray; padding: 0 5px 0 5px"> 2</span>   
<span style="color: gray; padding: 0 5px 0 5px"> 3</span>   <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">directive</span>(<span style="color: #00e5ee">'a'</span>, <span style="color: #bcd2ee">function</span>(){
<span style="color: gray; padding: 0 5px 0 5px"> 4</span>     <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">func</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">element</span>, <span style="color: #e0eee0">attrs</span>, <span style="color: #e0eee0">link</span>){
<span style="color: gray; padding: 0 5px 0 5px"> 5</span>       <span style="color: #90ee90">return</span> <span style="color: #bcd2ee">function</span> <span style="color: #e0eee0">llink</span>(<span style="color: #e0eee0">scope</span>){
<span style="color: gray; padding: 0 5px 0 5px"> 6</span>         <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">scope</span>);
<span style="color: gray; padding: 0 5px 0 5px"> 7</span>         <span style="color: #e0eee0">scope</span>.<span style="color: #e0eee0">a</span>();
<span style="color: gray; padding: 0 5px 0 5px"> 8</span>         <span style="color: #e0eee0">scope</span>.<span style="color: #e0eee0">b</span>();
<span style="color: gray; padding: 0 5px 0 5px"> 9</span>   
<span style="color: gray; padding: 0 5px 0 5px">10</span>         <span style="color: #e0eee0">scope</span>.<span style="color: #e0eee0">show</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">here</span>){
<span style="color: gray; padding: 0 5px 0 5px">11</span>           <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #00e5ee">'Inner, '</span> <span style="color: #7fff00">+</span> <span style="color: #e0eee0">here</span>);
<span style="color: gray; padding: 0 5px 0 5px">12</span>           <span style="color: #e0eee0">scope</span>.<span style="color: #e0eee0">a</span>({<span style="color: #e0eee0">here</span><span style="color: #7fff00">:</span> <span style="color: #00ffff">5</span>});
<span style="color: gray; padding: 0 5px 0 5px">13</span>         }
<span style="color: gray; padding: 0 5px 0 5px">14</span>       }
<span style="color: gray; padding: 0 5px 0 5px">15</span>     }
<span style="color: gray; padding: 0 5px 0 5px">16</span>   
<span style="color: gray; padding: 0 5px 0 5px">17</span>     <span style="color: #90ee90">return</span> {<span style="color: #e0eee0">compile</span><span style="color: #7fff00">:</span> <span style="color: #e0eee0">func</span>,
<span style="color: gray; padding: 0 5px 0 5px">18</span>             <span style="color: #e0eee0">scope</span><span style="color: #7fff00">:</span> {<span style="color: #e0eee0">a</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'&amp;abc'</span>, <span style="color: #e0eee0">b</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'&amp;ngClick'</span>},
<span style="color: gray; padding: 0 5px 0 5px">19</span>             <span style="color: #e0eee0">restrict</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'A'</span>};
<span style="color: gray; padding: 0 5px 0 5px">20</span>   });
<span style="color: gray; padding: 0 5px 0 5px">21</span>   
<span style="color: gray; padding: 0 5px 0 5px">22</span>   <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">controller</span>(<span style="color: #00e5ee">'TestCtrl'</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>){
<span style="color: gray; padding: 0 5px 0 5px">23</span>     <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">here</span> <span style="color: #7fff00">=</span> <span style="color: #00ffff">123</span>;
<span style="color: gray; padding: 0 5px 0 5px">24</span>     <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">$scope</span>);
<span style="color: gray; padding: 0 5px 0 5px">25</span>   
<span style="color: gray; padding: 0 5px 0 5px">26</span>     <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">show</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">here</span>){
<span style="color: gray; padding: 0 5px 0 5px">27</span>       <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">here</span>);
<span style="color: gray; padding: 0 5px 0 5px">28</span>     }
<span style="color: gray; padding: 0 5px 0 5px">29</span>   });
</pre></div>


<p style="margin: 15px 0;">
scope.a 是 <i style=" color: #d75100; font-style: normal; ">&amp;abc</i> ，即：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">scope</span>.<span style="color: #e0eee0">a</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(){<span style="color: #e0eee0">here</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">here</span> <span style="color: #7fff00">+</span> <span style="color: #00ffff">1</span>}
</pre></div>


<p style="margin: 15px 0;">
只是其中的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">here</code> 是 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">TestCtrl</code> 的。
</p>
<p style="margin: 15px 0;">
scope.b 是 <i style=" color: #d75100; font-style: normal; ">&amp;ngClick</i> ，即：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">scope</span>.<span style="color: #e0eee0">b</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(){<span style="color: #e0eee0">show</span>(<span style="color: #e0eee0">here</span>)}
</pre></div>


<p style="margin: 15px 0;">
这里的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">show()</code> 和 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">here</code> 都是 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">TestCtrl</code> 的，于是上面的代码最开始会在终端输出一个 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">124</code> 。
</p>
<p style="margin: 15px 0;">
当点击“这里”时，这时执行的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">show(here)</code> 就是 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">llink</code> 中定义的那个函数了，与 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">TestCtrl</code> 无关。但是，其间的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">scope.a({here:5})</code> ，因为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">a</code> 执行时是 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">TestCtrl</code> 的上下文，于是向 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">a</code> 传递的一个对象，里面的所有属性 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">TestCtrl</code> 就全收下了，接着执行 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">here=here+1</code> ，于是我们会在屏幕上看到 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">6</code> 。
</p>
<p style="margin: 15px 0;">
这里是一个上下文交错的环境，通过 <i style=" color: #d75100; font-style: normal; ">&amp;</i> 这种机制，让指令的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">scope</code> 与节点的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">scope</code> 发生了互动。真是鬼斧神工的设计。而实现它，只用了几行代码：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #90ee90">case</span> <span style="color: #00e5ee">'&amp;'</span><span style="color: #7fff00">:</span> {
    <span style="color: #e0eee0">parentGet</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$parse</span>(<span style="color: #e0eee0">attrs</span>[<span style="color: #e0eee0">attrName</span>]);
    <span style="color: #e0eee0">scope</span>[<span style="color: #e0eee0">scopeName</span>] <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">locals</span>) {
      <span style="color: #90ee90">return</span> <span style="color: #e0eee0">parentGet</span>(<span style="color: #e0eee0">parentScope</span>, <span style="color: #e0eee0">locals</span>);
    }
    <span style="color: #90ee90">break</span>;
  }
</pre></div>


<p style="margin: 15px 0;">
再看 <i style=" color: #d75100; font-style: normal; ">controller</i> 这个参数。这个参数的作用是提供一个 controller 的构造函数，它会在 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">compile</code> 函数之后， <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">link</code> 函数之前被执行。
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;a&gt;</span>haha<span style="color: #e0eee0">&lt;/a&gt;</span>
</pre></div>



<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;"><span style="color: gray; padding: 0 5px 0 5px"> 1</span>   <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">app</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'Demo'</span>, [], <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">noop</span>);
<span style="color: gray; padding: 0 5px 0 5px"> 2</span>   
<span style="color: gray; padding: 0 5px 0 5px"> 3</span>   <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">directive</span>(<span style="color: #00e5ee">'a'</span>, <span style="color: #bcd2ee">function</span>(){
<span style="color: gray; padding: 0 5px 0 5px"> 4</span>     <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">func</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(){
<span style="color: gray; padding: 0 5px 0 5px"> 5</span>       <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #00e5ee">'compile'</span>);
<span style="color: gray; padding: 0 5px 0 5px"> 6</span>       <span style="color: #90ee90">return</span> <span style="color: #bcd2ee">function</span>(){
<span style="color: gray; padding: 0 5px 0 5px"> 7</span>         <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #00e5ee">'link'</span>);
<span style="color: gray; padding: 0 5px 0 5px"> 8</span>       }
<span style="color: gray; padding: 0 5px 0 5px"> 9</span>     }
<span style="color: gray; padding: 0 5px 0 5px">10</span>   
<span style="color: gray; padding: 0 5px 0 5px">11</span>     <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">controller</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">$element</span>, <span style="color: #e0eee0">$attrs</span>, <span style="color: #e0eee0">$transclude</span>){
<span style="color: gray; padding: 0 5px 0 5px">12</span>       <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #00e5ee">'controller'</span>);
<span style="color: gray; padding: 0 5px 0 5px">13</span>       <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">$scope</span>);
<span style="color: gray; padding: 0 5px 0 5px">14</span>   
<span style="color: gray; padding: 0 5px 0 5px">15</span>       <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">node</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$transclude</span>(<span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">clone_element</span>, <span style="color: #e0eee0">scope</span>){
<span style="color: gray; padding: 0 5px 0 5px">16</span>         <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">clone_element</span>);
<span style="color: gray; padding: 0 5px 0 5px">17</span>         <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #00e5ee">'--'</span>);
<span style="color: gray; padding: 0 5px 0 5px">18</span>         <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">scope</span>);
<span style="color: gray; padding: 0 5px 0 5px">19</span>       });
<span style="color: gray; padding: 0 5px 0 5px">20</span>       <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">node</span>);
<span style="color: gray; padding: 0 5px 0 5px">21</span>     }
<span style="color: gray; padding: 0 5px 0 5px">22</span>   
<span style="color: gray; padding: 0 5px 0 5px">23</span>     <span style="color: #90ee90">return</span> {<span style="color: #e0eee0">compile</span><span style="color: #7fff00">:</span> <span style="color: #e0eee0">func</span>,
<span style="color: gray; padding: 0 5px 0 5px">24</span>             <span style="color: #e0eee0">controller</span><span style="color: #7fff00">:</span> <span style="color: #e0eee0">controller</span>,
<span style="color: gray; padding: 0 5px 0 5px">25</span>             <span style="color: #e0eee0">transclude</span><span style="color: #7fff00">:</span> <span style="color: #90ee90">true</span>,
<span style="color: gray; padding: 0 5px 0 5px">26</span>             <span style="color: #e0eee0">restrict</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'E'</span>}
<span style="color: gray; padding: 0 5px 0 5px">27</span>   });
</pre></div>


<p style="margin: 15px 0;">
<code style="margin: auto 3px; color: #228b22; font-family: monospace; ">controller</code> 的最后一个参数， <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">$transclude</code> ，是一个只接受 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">cloneAttachFn</code> 作为参数的一个函数。
</p>
<p style="margin: 15px 0;">
按官方的说法，这个机制的设计目的是为了让各个指令之间可以互相通信。参考普通节点的处理方式，这里也是处理指令 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">scope</code> 的合适位置。
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;a</span> <span style="color: #e0eee0">b&gt;</span>kk<span style="color: #e0eee0">&lt;/a&gt;</span>
</pre></div>



<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;"><span style="color: gray; padding: 0 5px 0 5px"> 1</span>   <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">app</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'Demo'</span>, [], <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">noop</span>);
<span style="color: gray; padding: 0 5px 0 5px"> 2</span>   
<span style="color: gray; padding: 0 5px 0 5px"> 3</span>   <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">directive</span>(<span style="color: #00e5ee">'a'</span>, <span style="color: #bcd2ee">function</span>(){
<span style="color: gray; padding: 0 5px 0 5px"> 4</span>     <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">func</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(){
<span style="color: gray; padding: 0 5px 0 5px"> 5</span>     }
<span style="color: gray; padding: 0 5px 0 5px"> 6</span>   
<span style="color: gray; padding: 0 5px 0 5px"> 7</span>     <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">controller</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">$element</span>, <span style="color: #e0eee0">$attrs</span>, <span style="color: #e0eee0">$transclude</span>){
<span style="color: gray; padding: 0 5px 0 5px"> 8</span>       <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #00e5ee">'a'</span>);
<span style="color: gray; padding: 0 5px 0 5px"> 9</span>       <span style="color: #90ee90">this</span>.<span style="color: #e0eee0">a</span> <span style="color: #7fff00">=</span> <span style="color: #00e5ee">'xx'</span>;
<span style="color: gray; padding: 0 5px 0 5px">10</span>     }
<span style="color: gray; padding: 0 5px 0 5px">11</span>   
<span style="color: gray; padding: 0 5px 0 5px">12</span>     <span style="color: #90ee90">return</span> {<span style="color: #e0eee0">compile</span><span style="color: #7fff00">:</span> <span style="color: #e0eee0">func</span>,
<span style="color: gray; padding: 0 5px 0 5px">13</span>             <span style="color: #e0eee0">name</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'not_a'</span>,
<span style="color: gray; padding: 0 5px 0 5px">14</span>             <span style="color: #e0eee0">controller</span><span style="color: #7fff00">:</span> <span style="color: #e0eee0">controller</span>,
<span style="color: gray; padding: 0 5px 0 5px">15</span>             <span style="color: #e0eee0">restrict</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'E'</span>}
<span style="color: gray; padding: 0 5px 0 5px">16</span>   });
<span style="color: gray; padding: 0 5px 0 5px">17</span>   
<span style="color: gray; padding: 0 5px 0 5px">18</span>   <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">directive</span>(<span style="color: #00e5ee">'b'</span>, <span style="color: #bcd2ee">function</span>(){
<span style="color: gray; padding: 0 5px 0 5px">19</span>     <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">func</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(){
<span style="color: gray; padding: 0 5px 0 5px">20</span>       <span style="color: #90ee90">return</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">$element</span>, <span style="color: #e0eee0">$attrs</span>, <span style="color: #e0eee0">$controller</span>){
<span style="color: gray; padding: 0 5px 0 5px">21</span>         <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">$controller</span>);
<span style="color: gray; padding: 0 5px 0 5px">22</span>       }
<span style="color: gray; padding: 0 5px 0 5px">23</span>     }
<span style="color: gray; padding: 0 5px 0 5px">24</span>   
<span style="color: gray; padding: 0 5px 0 5px">25</span>     <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">controller</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">$element</span>, <span style="color: #e0eee0">$attrs</span>, <span style="color: #e0eee0">$transclude</span>){
<span style="color: gray; padding: 0 5px 0 5px">26</span>       <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #00e5ee">'b'</span>);
<span style="color: gray; padding: 0 5px 0 5px">27</span>     }
<span style="color: gray; padding: 0 5px 0 5px">28</span>   
<span style="color: gray; padding: 0 5px 0 5px">29</span>     <span style="color: #90ee90">return</span> {<span style="color: #e0eee0">compile</span><span style="color: #7fff00">:</span> <span style="color: #e0eee0">func</span>,
<span style="color: gray; padding: 0 5px 0 5px">30</span>             <span style="color: #e0eee0">controller</span><span style="color: #7fff00">:</span> <span style="color: #e0eee0">controller</span>,
<span style="color: gray; padding: 0 5px 0 5px">31</span>             <span style="color: #e0eee0">require</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'not_a'</span>,
<span style="color: gray; padding: 0 5px 0 5px">32</span>             <span style="color: #e0eee0">restrict</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'EA'</span>}
<span style="color: gray; padding: 0 5px 0 5px">33</span>   });
</pre></div>


<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">name</i> 参数在这里可以用以为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">controller</code> 重起一个名字，以方便在 <i style=" color: #d75100; font-style: normal; ">require</i> 参数中引用。
</p>
<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">require</i> 参数可以带两种前缀（可以同时使用）：
</p>

<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li><i style=" color: #d75100; font-style: normal; ">?</i> ，如果指定的 controller 不存在，则忽略错误。即：
<p style="margin: 15px 0;"></p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">require</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'?not_b'</span>
</pre></div>


<p style="margin: 15px 0;"></p>
如果名为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">not_b</code> 的 controller 不存在时，不会直接抛出错误， <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">link</code> 函数中对应的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">$controller</code> 为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">undefined</code> 。
<p style="margin: 15px 0;"></p>
</li>
<li><i style=" color: #d75100; font-style: normal; ">^</i> ，同时在父级节点中寻找指定的 controller ，把上面的例子小改一下：
<p style="margin: 15px 0;"></p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;a&gt;&lt;b&gt;</span>kk<span style="color: #e0eee0">&lt;/b&gt;&lt;/a&gt;</span>
</pre></div>


<p style="margin: 15px 0;"></p>
把 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">a</code> 的 <i style=" color: #d75100; font-style: normal; ">require</i> 改成（否则就找不到 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">not_a</code> 这个 controller ）：
<p style="margin: 15px 0;"></p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">require</span>: <span style="color: #00e5ee">'?^not_a'</span>
</pre></div>


</li>
</ul>

<p style="margin: 15px 0;">
还剩下几个模板参数：
</p>

<dl style="font-size: small; margin: 10px auto; padding: 10px; border-bottom: 1px dashed gray; border-top: 1px dashed gray;">
<dt style="border-left: 4px solid rgb(215, 81, 0); padding-left: 5px; margin: 5px auto;"><i style=" color: #d75100; font-style: normal; ">template</i> 模板内容，这个内容会根据 <i style=" color: #d75100; font-style: normal; ">replace</i> 参数的设置替换节点或只替换节点内容。</dt><dd style="margin-left: 30px;">
</dd>
<dt style="border-left: 4px solid rgb(215, 81, 0); padding-left: 5px; margin: 5px auto;"><i style=" color: #d75100; font-style: normal; ">templateUrl</i> 模板内容，获取方式是异步请求。</dt><dd style="margin-left: 30px;">
</dd>
<dt style="border-left: 4px solid rgb(215, 81, 0); padding-left: 5px; margin: 5px auto;"><i style=" color: #d75100; font-style: normal; ">replace</i> 设置如何处理模板内容。为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">true</code> 时为替换掉指令节点，否则只替换到节点内容。</dt><dd style="margin-left: 30px;">
</dd>
</dl>


<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;h1</span> <span style="color: #e0eee0">a&gt;</span>原始内容<span style="color: #e0eee0">&lt;/h1&gt;</span>
  <span style="color: #e0eee0">&lt;/div&gt;</span>
</pre></div>



<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">app</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'Demo'</span>, [], <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">noop</span>);
  
  <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">directive</span>(<span style="color: #00e5ee">'a'</span>, <span style="color: #bcd2ee">function</span>(){
    <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">func</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(){
    }
  
    <span style="color: #90ee90">return</span> {<span style="color: #e0eee0">compile</span><span style="color: #7fff00">:</span> <span style="color: #e0eee0">func</span>,
            <span style="color: #e0eee0">template</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'&lt;p&gt;标题 {{ name }} &lt;button ng-click="name=\'</span><span style="color: #e0eee0">hahaha</span>\<span style="color: #00e5ee">'"&gt;修改&lt;/button&gt;&lt;/p&gt;'</span>,
            <span style="color: #507080">//replace: true,</span>
            <span style="color: #507080">//controller: function($scope){$scope.name = 'xxx'},</span>
            <span style="color: #507080">//scope: {},</span>
            <span style="color: #e0eee0">scope</span><span style="color: #7fff00">:</span> <span style="color: #90ee90">true</span> ,
            <span style="color: #e0eee0">controller</span><span style="color: #7fff00">:</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>){<span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">$scope</span>)},
            <span style="color: #e0eee0">restrict</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'A'</span>}
  });
  
  <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">controller</span>(<span style="color: #00e5ee">'TestCtrl'</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>){
    <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">name</span> <span style="color: #7fff00">=</span> <span style="color: #00e5ee">'123'</span>;
    <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">$scope</span>);
  });
</pre></div>


<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">template</i> 中可以包括变量引用的表达式，其 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">scope</code> 遵寻 <i style=" color: #d75100; font-style: normal; ">scope</i> 参数的作用（可能受继承关系影响）。
</p>
<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">templateUrl</i> 是异步请求模板内容，并且是获取到内容之后才开始执行指令的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">compile</code> 函数。
</p>
<p style="margin: 15px 0;">
最后说一个 <i style=" color: #d75100; font-style: normal; ">compile</i> 这个参数。它除了可以返回一个函数用为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">link</code> 函数之外，还可以返回一个对象，这个对象能包括两个成员，一个 <i style=" color: #d75100; font-style: normal; ">pre</i> ，一个 <i style=" color: #d75100; font-style: normal; ">post</i> 。实际上， <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">link</code> 函数是由两部分组成，所谓的 <i style=" color: #d75100; font-style: normal; ">preLink</i> 和 <i style=" color: #d75100; font-style: normal; ">postLink</i> 。区别在于执行顺序，特别是在指令层级嵌套的结构之下， <i style=" color: #d75100; font-style: normal; ">postLink</i> 是在所有的子级指令 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">link</code> 完成之后才最后执行的。 <i style=" color: #d75100; font-style: normal; ">compile</i> 如果只返回一个函数，则这个函数被作为 <i style=" color: #d75100; font-style: normal; ">postLink</i> 使用：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;a&gt;&lt;b&gt;&lt;/b&gt;&lt;/a&gt;</span>
</pre></div>



<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;"><span style="color: gray; padding: 0 5px 0 5px"> 1</span>   <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">app</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'Demo'</span>, [], <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">noop</span>);
<span style="color: gray; padding: 0 5px 0 5px"> 2</span>   
<span style="color: gray; padding: 0 5px 0 5px"> 3</span>   <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">directive</span>(<span style="color: #00e5ee">'a'</span>, <span style="color: #bcd2ee">function</span>(){
<span style="color: gray; padding: 0 5px 0 5px"> 4</span>     <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">func</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(){
<span style="color: gray; padding: 0 5px 0 5px"> 5</span>       <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #00e5ee">'a compile'</span>);
<span style="color: gray; padding: 0 5px 0 5px"> 6</span>       <span style="color: #90ee90">return</span> {
<span style="color: gray; padding: 0 5px 0 5px"> 7</span>         <span style="color: #e0eee0">pre</span><span style="color: #7fff00">:</span> <span style="color: #bcd2ee">function</span>(){<span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #00e5ee">'a link pre'</span>)},
<span style="color: gray; padding: 0 5px 0 5px"> 8</span>         <span style="color: #e0eee0">post</span><span style="color: #7fff00">:</span> <span style="color: #bcd2ee">function</span>(){<span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #00e5ee">'a link post'</span>)},
<span style="color: gray; padding: 0 5px 0 5px"> 9</span>       }
<span style="color: gray; padding: 0 5px 0 5px">10</span>     }
<span style="color: gray; padding: 0 5px 0 5px">11</span>   
<span style="color: gray; padding: 0 5px 0 5px">12</span>     <span style="color: #90ee90">return</span> {<span style="color: #e0eee0">compile</span><span style="color: #7fff00">:</span> <span style="color: #e0eee0">func</span>,
<span style="color: gray; padding: 0 5px 0 5px">13</span>             <span style="color: #e0eee0">restrict</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'E'</span>}
<span style="color: gray; padding: 0 5px 0 5px">14</span>   });
<span style="color: gray; padding: 0 5px 0 5px">15</span>   
<span style="color: gray; padding: 0 5px 0 5px">16</span>   <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">directive</span>(<span style="color: #00e5ee">'b'</span>, <span style="color: #bcd2ee">function</span>(){
<span style="color: gray; padding: 0 5px 0 5px">17</span>     <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">func</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(){
<span style="color: gray; padding: 0 5px 0 5px">18</span>       <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #00e5ee">'b compile'</span>);
<span style="color: gray; padding: 0 5px 0 5px">19</span>       <span style="color: #90ee90">return</span> {
<span style="color: gray; padding: 0 5px 0 5px">20</span>         <span style="color: #e0eee0">pre</span><span style="color: #7fff00">:</span> <span style="color: #bcd2ee">function</span>(){<span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #00e5ee">'b link pre'</span>)},
<span style="color: gray; padding: 0 5px 0 5px">21</span>         <span style="color: #e0eee0">post</span><span style="color: #7fff00">:</span> <span style="color: #bcd2ee">function</span>(){<span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #00e5ee">'b link post'</span>)},
<span style="color: gray; padding: 0 5px 0 5px">22</span>       }
<span style="color: gray; padding: 0 5px 0 5px">23</span>     }
<span style="color: gray; padding: 0 5px 0 5px">24</span>   
<span style="color: gray; padding: 0 5px 0 5px">25</span>     <span style="color: #90ee90">return</span> {<span style="color: #e0eee0">compile</span><span style="color: #7fff00">:</span> <span style="color: #e0eee0">func</span>,
<span style="color: gray; padding: 0 5px 0 5px">26</span>             <span style="color: #e0eee0">restrict</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'E'</span>}
<span style="color: gray; padding: 0 5px 0 5px">27</span>   });
</pre></div>


<a id="toc77" name="toc77"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">18.9. Attributes的细节</h2>

<p style="margin: 15px 0;">
节点属性被包装之后会传给 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">compile</code> 和 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">link</code> 函数。从这个操作中，我们可以得到节点的引用，可以操作节点属性，也可以为节点属性注册侦听事件。
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;test</span> <span style="color: #e0eee0">a=</span><span style="color: #00e5ee">"1"</span> <span style="color: #e0eee0">b</span> <span style="color: #e0eee0">c=</span><span style="color: #00e5ee">"xxx"</span><span style="color: #e0eee0">&gt;&lt;/test&gt;</span>
</pre></div>



<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">app</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'Demo'</span>, [], <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">noop</span>);
  
  <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">directive</span>(<span style="color: #00e5ee">'test'</span>, <span style="color: #bcd2ee">function</span>(){
    <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">func</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$element</span>, <span style="color: #e0eee0">$attrs</span>){
      <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">$attrs</span>);
    }
  
    <span style="color: #90ee90">return</span> {<span style="color: #e0eee0">compile</span><span style="color: #7fff00">:</span> <span style="color: #e0eee0">func</span>,
            <span style="color: #e0eee0">restrict</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'E'</span>}
</pre></div>


<p style="margin: 15px 0;">
整个 <i style=" color: #d75100; font-style: normal; ">Attributes</i> 对象是比较简单的，它的成员包括了：
</p>

<dl style="font-size: small; margin: 10px auto; padding: 10px; border-bottom: 1px dashed gray; border-top: 1px dashed gray;">
<dt style="border-left: 4px solid rgb(215, 81, 0); padding-left: 5px; margin: 5px auto;"><i style=" color: #d75100; font-style: normal; ">$$element</i> 属性所在的节点。</dt><dd style="margin-left: 30px;">
</dd>
<dt style="border-left: 4px solid rgb(215, 81, 0); padding-left: 5px; margin: 5px auto;"><i style=" color: #d75100; font-style: normal; ">$attr</i> 所有的属性值（类型是对象）。</dt><dd style="margin-left: 30px;">
</dd>
<dt style="border-left: 4px solid rgb(215, 81, 0); padding-left: 5px; margin: 5px auto;"><i style=" color: #d75100; font-style: normal; ">$normalize</i> 一个名字标准化的工具函数，可以把 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">ng-click</code> 变成 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">ngClick</code> 。</dt><dd style="margin-left: 30px;">
</dd>
<dt style="border-left: 4px solid rgb(215, 81, 0); padding-left: 5px; margin: 5px auto;"><i style=" color: #d75100; font-style: normal; ">$observe</i> 为属性注册侦听器的函数。</dt><dd style="margin-left: 30px;">
</dd>
<dt style="border-left: 4px solid rgb(215, 81, 0); padding-left: 5px; margin: 5px auto;"><i style=" color: #d75100; font-style: normal; ">$set</i> 设置对象属性，及节点属性的工具。</dt><dd style="margin-left: 30px;">
</dd>
</dl>

<p style="margin: 15px 0;">
除了上面这些成员，对象的成员还包括所有属性的名字。
</p>
<p style="margin: 15px 0;">
先看 <i style=" color: #d75100; font-style: normal; ">$observe</i> 的使用，基本上相当于 <i style=" color: #d75100; font-style: normal; ">$scope</i> 中的 <i style=" color: #d75100; font-style: normal; ">$watch</i> ：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;test</span> <span style="color: #e0eee0">a=</span><span style="color: #00e5ee">"{{ a }}"</span> <span style="color: #e0eee0">b</span> <span style="color: #e0eee0">c=</span><span style="color: #00e5ee">"xxx"</span><span style="color: #e0eee0">&gt;&lt;/test&gt;</span>
    <span style="color: #e0eee0">&lt;button</span> <span style="color: #e0eee0">ng-click=</span><span style="color: #00e5ee">"a=a+1"</span><span style="color: #e0eee0">&gt;</span>修改<span style="color: #e0eee0">&lt;/button&gt;</span>
  <span style="color: #e0eee0">&lt;/div&gt;</span>
</pre></div>



<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">app</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'Demo'</span>, [], <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">noop</span>);
  
  <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">directive</span>(<span style="color: #00e5ee">'test'</span>, <span style="color: #bcd2ee">function</span>(){
    <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">func</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$element</span>, <span style="color: #e0eee0">$attrs</span>){
      <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">$attrs</span>);
  
      <span style="color: #e0eee0">$attrs</span>.<span style="color: #e0eee0">$observe</span>(<span style="color: #00e5ee">'a'</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">new_v</span>){
        <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">new_v</span>);
      });
    }
  
    <span style="color: #90ee90">return</span> {<span style="color: #e0eee0">compile</span><span style="color: #7fff00">:</span> <span style="color: #e0eee0">func</span>,
            <span style="color: #e0eee0">restrict</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'E'</span>}
  });
  
  <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">controller</span>(<span style="color: #00e5ee">'TestCtrl'</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>){
    <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">a</span> <span style="color: #7fff00">=</span> <span style="color: #00ffff">123</span>;
  });
</pre></div>


<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">$set</i> 方法的定义是： <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">function(key, value, writeAttr, attrName) { ... }</code> 。
</p>

<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li><i style=" color: #d75100; font-style: normal; ">key</i> 对象的成员名。
</li>
<li><i style=" color: #d75100; font-style: normal; ">value</i> 需要设置的值。
</li>
<li><i style=" color: #d75100; font-style: normal; ">writeAttr</i> 是否同时修改 DOM 节点的属性（注意区别“节点”与“对象”），默认为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">true</code> 。
</li>
<li><i style=" color: #d75100; font-style: normal; ">attrName</i> 实际的属性名，与“标准化”之后的属性名有区别。
</li>
</ul>


<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;test</span> <span style="color: #e0eee0">a=</span><span style="color: #00e5ee">"1"</span> <span style="color: #e0eee0">ys-a=</span><span style="color: #00e5ee">"123"</span> <span style="color: #e0eee0">ng-click=</span><span style="color: #00e5ee">"show(1)"</span><span style="color: #e0eee0">&gt;</span>这里<span style="color: #e0eee0">&lt;/test&gt;</span>
  <span style="color: #e0eee0">&lt;/div&gt;</span>
</pre></div>



<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">app</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'Demo'</span>, [], <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">noop</span>);
  
  <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">directive</span>(<span style="color: #00e5ee">'test'</span>, <span style="color: #bcd2ee">function</span>(){
    <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">func</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$element</span>, <span style="color: #e0eee0">$attrs</span>){
      <span style="color: #e0eee0">$attrs</span>.<span style="color: #e0eee0">$set</span>(<span style="color: #00e5ee">'b'</span>, <span style="color: #00e5ee">'ooo'</span>);
      <span style="color: #e0eee0">$attrs</span>.<span style="color: #e0eee0">$set</span>(<span style="color: #00e5ee">'a-b'</span>, <span style="color: #00e5ee">'11'</span>);
      <span style="color: #e0eee0">$attrs</span>.<span style="color: #e0eee0">$set</span>(<span style="color: #00e5ee">'c-d'</span>, <span style="color: #00e5ee">'11'</span>, <span style="color: #90ee90">true</span>, <span style="color: #00e5ee">'c_d'</span>);
      <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">$attrs</span>);
    }
  
    <span style="color: #90ee90">return</span> {<span style="color: #e0eee0">compile</span><span style="color: #7fff00">:</span> <span style="color: #e0eee0">func</span>,
            <span style="color: #e0eee0">restrict</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'E'</span>}
  });
  
  <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">controller</span>(<span style="color: #00e5ee">'TestCtrl'</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>){
    <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">show</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">v</span>){<span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">v</span>);}
  });
</pre></div>


<p style="margin: 15px 0;">
从例子中可以看到，原始的节点属性值对，放到对象中之后，名字一定是“标准化”之后的。但是手动 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">$set</code> 的新属性，不会自动做标准化处理。
</p>

<a id="toc78" name="toc78"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">18.10. 预定义的 NgModelController</h2>

<p style="margin: 15px 0;">
在前面讲 conroller 参数的时候，提到过可以为指令定义一个 conroller 。官方的实现中，有很多已定义的指令，这些指令当中，有两个已定义的 conroller ，它们是 <i style=" color: #d75100; font-style: normal; ">NgModelController</i> 和 <i style=" color: #d75100; font-style: normal; ">FormController</i> ，对应 <i style=" color: #d75100; font-style: normal; ">ng-model</i> 和 <i style=" color: #d75100; font-style: normal; ">form</i> 这两个指令（可以参照前面的“表单控件”一章）。
</p>
<p style="margin: 15px 0;">
在使用中，除了可以通过 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">$scope</code> 来取得它们的引用之外，也可以在自定义指令中通过 <i style=" color: #d75100; font-style: normal; ">require</i> 参数直接引用，这样就可以在 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">link</code> 函数中使用 controller 去实现一些功能。
</p>
<p style="margin: 15px 0;">
先看 <i style=" color: #d75100; font-style: normal; ">NgModelController</i> 。这东西的作用有两个，一是控制 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">ViewValue</code> 与 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">ModelValue</code> 之间的转换关系（你可以实现看到的是一个值，但是存到变量里变成了另外一个值），二是与 <i style=" color: #d75100; font-style: normal; ">FormController</i> 配合做数据校验的相关逻辑。
</p>
<p style="margin: 15px 0;">
先看两个应该是最有用的属性：
</p>

<dl style="font-size: small; margin: 10px auto; padding: 10px; border-bottom: 1px dashed gray; border-top: 1px dashed gray;">
<dt style="border-left: 4px solid rgb(215, 81, 0); padding-left: 5px; margin: 5px auto;"><i style=" color: #d75100; font-style: normal; ">$formatters</i> 是一个由函数组成的列表，串行执行，作用是把变量值变成显示的值。</dt><dd style="margin-left: 30px;">
</dd>
<dt style="border-left: 4px solid rgb(215, 81, 0); padding-left: 5px; margin: 5px auto;"><i style=" color: #d75100; font-style: normal; ">$parsers</i> 与上面的方向相反，把显示的值变成变量值。</dt><dd style="margin-left: 30px;">
</dd>
</dl>

<p style="margin: 15px 0;">
假设我们在变量中要保存一个列表的类型，但是显示的东西只能是字符串，所以这两者之间需要一个转换：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;input</span> <span style="color: #e0eee0">type=</span><span style="color: #00e5ee">"text"</span> <span style="color: #e0eee0">ng-model=</span><span style="color: #00e5ee">"a"</span> <span style="color: #e0eee0">test</span> <span style="color: #e0eee0">/&gt;</span>
    <span style="color: #e0eee0">&lt;button</span> <span style="color: #e0eee0">ng-click=</span><span style="color: #00e5ee">"show(a)"</span><span style="color: #e0eee0">&gt;</span>查看<span style="color: #e0eee0">&lt;/button&gt;</span>
  <span style="color: #e0eee0">&lt;/div&gt;</span>
</pre></div>



<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;"><span style="color: gray; padding: 0 5px 0 5px"> 1</span>   <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">app</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'Demo'</span>, [], <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">noop</span>);
<span style="color: gray; padding: 0 5px 0 5px"> 2</span>   
<span style="color: gray; padding: 0 5px 0 5px"> 3</span>   <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">directive</span>(<span style="color: #00e5ee">'test'</span>, <span style="color: #bcd2ee">function</span>(){
<span style="color: gray; padding: 0 5px 0 5px"> 4</span>     <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">link</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">$element</span>, <span style="color: #e0eee0">$attrs</span>, <span style="color: #e0eee0">$ctrl</span>){
<span style="color: gray; padding: 0 5px 0 5px"> 5</span>   
<span style="color: gray; padding: 0 5px 0 5px"> 6</span>       <span style="color: #e0eee0">$ctrl</span>.<span style="color: #e0eee0">$formatters</span>.<span style="color: #e0eee0">push</span>(<span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">value</span>){
<span style="color: gray; padding: 0 5px 0 5px"> 7</span>         <span style="color: #90ee90">return</span> <span style="color: #e0eee0">value</span>.<span style="color: #e0eee0">join</span>(<span style="color: #00e5ee">','</span>);
<span style="color: gray; padding: 0 5px 0 5px"> 8</span>       });
<span style="color: gray; padding: 0 5px 0 5px"> 9</span>   
<span style="color: gray; padding: 0 5px 0 5px">10</span>       <span style="color: #e0eee0">$ctrl</span>.<span style="color: #e0eee0">$parsers</span>.<span style="color: #e0eee0">push</span>(<span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">value</span>){
<span style="color: gray; padding: 0 5px 0 5px">11</span>         <span style="color: #90ee90">return</span> <span style="color: #e0eee0">value</span>.<span style="color: #e0eee0">split</span>(<span style="color: #00e5ee">','</span>);
<span style="color: gray; padding: 0 5px 0 5px">12</span>       });
<span style="color: gray; padding: 0 5px 0 5px">13</span>     }
<span style="color: gray; padding: 0 5px 0 5px">14</span>   
<span style="color: gray; padding: 0 5px 0 5px">15</span>     <span style="color: #90ee90">return</span> {<span style="color: #e0eee0">compile</span><span style="color: #7fff00">:</span> <span style="color: #bcd2ee">function</span>(){<span style="color: #90ee90">return</span> <span style="color: #e0eee0">link</span>},
<span style="color: gray; padding: 0 5px 0 5px">16</span>             <span style="color: #e0eee0">require</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'ngModel'</span>,
<span style="color: gray; padding: 0 5px 0 5px">17</span>             <span style="color: #e0eee0">restrict</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'A'</span>}
<span style="color: gray; padding: 0 5px 0 5px">18</span>   });
<span style="color: gray; padding: 0 5px 0 5px">19</span>   
<span style="color: gray; padding: 0 5px 0 5px">20</span>   <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">controller</span>(<span style="color: #00e5ee">'TestCtrl'</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>){
<span style="color: gray; padding: 0 5px 0 5px">21</span>     <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">a</span> <span style="color: #7fff00">=</span> [];
<span style="color: gray; padding: 0 5px 0 5px">22</span>     <span style="color: #507080">//$scope.a = [1,2,3];</span>
<span style="color: gray; padding: 0 5px 0 5px">23</span>     <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">show</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">v</span>){
<span style="color: gray; padding: 0 5px 0 5px">24</span>       <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">v</span>);
<span style="color: gray; padding: 0 5px 0 5px">25</span>     }
<span style="color: gray; padding: 0 5px 0 5px">26</span>   });
</pre></div>


<p style="margin: 15px 0;">
上面在定义 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">test</code> 这个指令， <i style=" color: #d75100; font-style: normal; ">require</i> 参数指定了 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">ngModel</code> 。同时因为 DOM 结构， <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">ng-model</code> 是存在的。于是， <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">link</code> 函数中就可以获取到一个 <i style=" color: #d75100; font-style: normal; ">NgModelController</i> 的实例，即代码中的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">$ctrl</code> 。
</p>
<p style="margin: 15px 0;">
我们添加了需要的过滤函数：
</p>

<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li>从变量( <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">ModelValue</code> )到显示值( <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">ViewValue</code> )的过程， <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">$formatters</code> 属性，把一个列表变成一个字符串。
</li>
<li>从显示值到变量的过程， <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">$parsers</code> 属性，把一个字符串变成一个列表。
</li>
</ul>

<p style="margin: 15px 0;">
对于显示值和变量，还有其它的 API ，这里就不细说了。
</p>
<p style="margin: 15px 0;">
另一部分，是关于数据校验的，放到下一章同 <i style=" color: #d75100; font-style: normal; ">FormController</i> 一起讨论。
</p>

<a id="toc79" name="toc79"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">18.11. 预定义的 FormController</h2>

<p style="margin: 15px 0;">
前面的“表单控制”那章，实际上讲的就是 <i style=" color: #d75100; font-style: normal; ">FormController</i> ，只是那里是从 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">scope</code> 中获取到的引用。现在从指令定义的角度，来更清楚地了解 <i style=" color: #d75100; font-style: normal; ">FormController</i> 及 <i style=" color: #d75100; font-style: normal; ">NgModelController</i> 是如何配合工作的。
</p>
<p style="margin: 15px 0;">
先说一下， <i style=" color: #d75100; font-style: normal; ">form</i> 和 <i style=" color: #d75100; font-style: normal; ">ngForm</i> 是官方定义的两个指令，但是它们其实是同一个东西。前者只允许以标签形式使用，而后者允许 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">EAC</code> 的形式。DOM 结构中， <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">form</code> 标签不能嵌套，但是 ng 的指令没有这个限制。不管是 <i style=" color: #d75100; font-style: normal; ">form</i> 还是 <i style=" color: #d75100; font-style: normal; ">ngForm</i> ，它们的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">controller</code> 都被命名成了 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">form</code> 。 所以 <i style=" color: #d75100; font-style: normal; ">require</i> 这个参数不要写错了。
</p>
<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">FormController</i> 的几个成员是很好理解的：
</p>

<dl style="font-size: small; margin: 10px auto; padding: 10px; border-bottom: 1px dashed gray; border-top: 1px dashed gray;">
<dt style="border-left: 4px solid rgb(215, 81, 0); padding-left: 5px; margin: 5px auto;"><i style=" color: #d75100; font-style: normal; ">$pristine</i> 表单是否被动过</dt><dd style="margin-left: 30px;">
</dd>
<dt style="border-left: 4px solid rgb(215, 81, 0); padding-left: 5px; margin: 5px auto;"><i style=" color: #d75100; font-style: normal; ">$dirty</i> 表单是否没被动过</dt><dd style="margin-left: 30px;">
</dd>
<dt style="border-left: 4px solid rgb(215, 81, 0); padding-left: 5px; margin: 5px auto;"><i style=" color: #d75100; font-style: normal; ">$valid</i> 表单是否检验通过</dt><dd style="margin-left: 30px;">
</dd>
<dt style="border-left: 4px solid rgb(215, 81, 0); padding-left: 5px; margin: 5px auto;"><i style=" color: #d75100; font-style: normal; ">$invalid</i> 表单是否检验未通过</dt><dd style="margin-left: 30px;">
</dd>
<dt style="border-left: 4px solid rgb(215, 81, 0); padding-left: 5px; margin: 5px auto;"><i style=" color: #d75100; font-style: normal; ">$error</i> 表单中的错误</dt><dd style="margin-left: 30px;">
</dd>
<dt style="border-left: 4px solid rgb(215, 81, 0); padding-left: 5px; margin: 5px auto;"><i style=" color: #d75100; font-style: normal; ">$setDirty()</i> 直接设置 <i style=" color: #d75100; font-style: normal; ">$dirty</i> 及 <i style=" color: #d75100; font-style: normal; ">$pristine</i> </dt><dd style="margin-left: 30px;">
</dd>
</dl>


<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-form</span> <span style="color: #e0eee0">test&gt;</span>
      <span style="color: #e0eee0">&lt;input</span> <span style="color: #e0eee0">ng-model=</span><span style="color: #00e5ee">"a"</span> <span style="color: #e0eee0">type=</span><span style="color: #00e5ee">"email"</span> <span style="color: #e0eee0">/&gt;</span>
      <span style="color: #e0eee0">&lt;button</span> <span style="color: #e0eee0">ng-click=</span><span style="color: #00e5ee">"do()"</span><span style="color: #e0eee0">&gt;</span>查看<span style="color: #e0eee0">&lt;/button&gt;</span>
    <span style="color: #e0eee0">&lt;/div&gt;</span>
  <span style="color: #e0eee0">&lt;/div&gt;</span>
</pre></div>



<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">app</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'Demo'</span>, [], <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">noop</span>);
  
  <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">directive</span>(<span style="color: #00e5ee">'test'</span>, <span style="color: #bcd2ee">function</span>(){
    <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">link</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">$element</span>, <span style="color: #e0eee0">$attrs</span>, <span style="color: #e0eee0">$ctrl</span>){
      <span style="color: #e0eee0">$scope</span>.<span style="color: #90ee90">do</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(){
        <span style="color: #507080">//$ctrl.$setDirty();</span>
        <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">$ctrl</span>.<span style="color: #e0eee0">$pristine</span>); <span style="color: #507080">//form是否没被动过</span>
        <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">$ctrl</span>.<span style="color: #e0eee0">$dirty</span>); <span style="color: #507080">//form是否被动过</span>
        <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">$ctrl</span>.<span style="color: #e0eee0">$valid</span>); <span style="color: #507080">//form是否被检验通过</span>
        <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">$ctrl</span>.<span style="color: #e0eee0">$invalid</span>); <span style="color: #507080">//form是否有错误</span>
        <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">$ctrl</span>.<span style="color: #e0eee0">$error</span>); <span style="color: #507080">//form中有错误的字段</span>
      }
    }
  
    <span style="color: #90ee90">return</span> {<span style="color: #e0eee0">compile</span><span style="color: #7fff00">:</span> <span style="color: #bcd2ee">function</span>(){<span style="color: #90ee90">return</span> <span style="color: #e0eee0">link</span>},
            <span style="color: #e0eee0">require</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'form'</span>,
            <span style="color: #e0eee0">restrict</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'A'</span>}
  });
  
  <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">controller</span>(<span style="color: #00e5ee">'TestCtrl'</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>){
  });
</pre></div>


<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">$error</i> 这个属性，是一个对象， <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">key</code> 是错误名， <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">value</code> 部分是一个列表，其成员是对应的 <i style=" color: #d75100; font-style: normal; ">NgModelController</i> 的实例。
</p>
<p style="margin: 15px 0;">
<i style=" color: #d75100; font-style: normal; ">FormController</i> 可以自由增减它包含的那些，类似于 <i style=" color: #d75100; font-style: normal; ">NgModelController</i> 的实例。在 DOM 结构上，有 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">ng-model</code> 的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">input</code> 节点的 <i style=" color: #d75100; font-style: normal; ">NgMoelController</i> 会被自动添加。
</p>

<dl style="font-size: small; margin: 10px auto; padding: 10px; border-bottom: 1px dashed gray; border-top: 1px dashed gray;">
<dt style="border-left: 4px solid rgb(215, 81, 0); padding-left: 5px; margin: 5px auto;"><i style=" color: #d75100; font-style: normal; ">$addControl()</i> 添加一个 conroller </dt><dd style="margin-left: 30px;">
</dd>
<dt style="border-left: 4px solid rgb(215, 81, 0); padding-left: 5px; margin: 5px auto;"><i style=" color: #d75100; font-style: normal; ">$removeControl()</i> 删除一个 controller</dt><dd style="margin-left: 30px;">
</dd>
</dl>

<p style="margin: 15px 0;">
这两个手动使用机会应该不会很多。被添加的实例也可以手动实现所有的 <i style=" color: #d75100; font-style: normal; ">NgModelController</i> 的方法
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;bb</span> <span style="color: #e0eee0">/&gt;</span>
    <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-form</span> <span style="color: #e0eee0">test&gt;</span>
      <span style="color: #e0eee0">&lt;input</span> <span style="color: #e0eee0">ng-model=</span><span style="color: #00e5ee">"a"</span> <span style="color: #e0eee0">type=</span><span style="color: #00e5ee">"email"</span> <span style="color: #e0eee0">/&gt;</span>
      <span style="color: #e0eee0">&lt;button</span> <span style="color: #e0eee0">ng-click=</span><span style="color: #00e5ee">"add()"</span><span style="color: #e0eee0">&gt;</span>添加<span style="color: #e0eee0">&lt;/button&gt;</span>
    <span style="color: #e0eee0">&lt;/div&gt;</span>
  <span style="color: #e0eee0">&lt;/div&gt;</span>
</pre></div>



<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;"><span style="color: gray; padding: 0 5px 0 5px"> 1</span>   <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">app</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'Demo'</span>, [], <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">noop</span>);
<span style="color: gray; padding: 0 5px 0 5px"> 2</span>   
<span style="color: gray; padding: 0 5px 0 5px"> 3</span>   <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">directive</span>(<span style="color: #00e5ee">'test'</span>, <span style="color: #bcd2ee">function</span>(){
<span style="color: gray; padding: 0 5px 0 5px"> 4</span>     <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">link</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">$element</span>, <span style="color: #e0eee0">$attrs</span>, <span style="color: #e0eee0">$ctrl</span>){
<span style="color: gray; padding: 0 5px 0 5px"> 5</span>       <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">add</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(){
<span style="color: gray; padding: 0 5px 0 5px"> 6</span>         <span style="color: #e0eee0">$ctrl</span>.<span style="color: #e0eee0">$addControl</span>(<span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">bb</span>);
<span style="color: gray; padding: 0 5px 0 5px"> 7</span>         <span style="color: #e0eee0">console</span>.<span style="color: #e0eee0">log</span>(<span style="color: #e0eee0">$ctrl</span>);
<span style="color: gray; padding: 0 5px 0 5px"> 8</span>       }
<span style="color: gray; padding: 0 5px 0 5px"> 9</span>     }
<span style="color: gray; padding: 0 5px 0 5px">10</span>   
<span style="color: gray; padding: 0 5px 0 5px">11</span>     <span style="color: #90ee90">return</span> {<span style="color: #e0eee0">compile</span><span style="color: #7fff00">:</span> <span style="color: #bcd2ee">function</span>(){<span style="color: #90ee90">return</span> <span style="color: #e0eee0">link</span>},
<span style="color: gray; padding: 0 5px 0 5px">12</span>             <span style="color: #e0eee0">require</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'form'</span>,
<span style="color: gray; padding: 0 5px 0 5px">13</span>             <span style="color: #e0eee0">restrict</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'A'</span>}
<span style="color: gray; padding: 0 5px 0 5px">14</span>   });
<span style="color: gray; padding: 0 5px 0 5px">15</span>   
<span style="color: gray; padding: 0 5px 0 5px">16</span>   <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">directive</span>(<span style="color: #00e5ee">'bb'</span>, <span style="color: #bcd2ee">function</span>(){
<span style="color: gray; padding: 0 5px 0 5px">17</span>     <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">controller</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">$element</span>, <span style="color: #e0eee0">$attrs</span>, <span style="color: #e0eee0">$transclude</span>){
<span style="color: gray; padding: 0 5px 0 5px">18</span>       <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">bb</span> <span style="color: #7fff00">=</span> <span style="color: #90ee90">this</span>;
<span style="color: gray; padding: 0 5px 0 5px">19</span>       <span style="color: #90ee90">this</span>.<span style="color: #e0eee0">$name</span> <span style="color: #7fff00">=</span> <span style="color: #00e5ee">'bb'</span>;
<span style="color: gray; padding: 0 5px 0 5px">20</span>     }
<span style="color: gray; padding: 0 5px 0 5px">21</span>   
<span style="color: gray; padding: 0 5px 0 5px">22</span>     <span style="color: #90ee90">return</span> {<span style="color: #e0eee0">compile</span><span style="color: #7fff00">:</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">noop</span>,
<span style="color: gray; padding: 0 5px 0 5px">23</span>             <span style="color: #e0eee0">restrict</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'E'</span>,
<span style="color: gray; padding: 0 5px 0 5px">24</span>             <span style="color: #e0eee0">controller</span><span style="color: #7fff00">:</span> <span style="color: #e0eee0">controller</span>}
<span style="color: gray; padding: 0 5px 0 5px">25</span>   });
<span style="color: gray; padding: 0 5px 0 5px">26</span>   
<span style="color: gray; padding: 0 5px 0 5px">27</span>   <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">controller</span>(<span style="color: #00e5ee">'TestCtrl'</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>){
<span style="color: gray; padding: 0 5px 0 5px">28</span>   });
</pre></div>


<p style="margin: 15px 0;">
整合 <i style=" color: #d75100; font-style: normal; ">FormController</i> 和 <i style=" color: #d75100; font-style: normal; ">NgModelController</i> 就很容易扩展各种类型的字段:
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;form</span> <span style="color: #e0eee0">name=</span><span style="color: #00e5ee">"f"</span><span style="color: #e0eee0">&gt;</span>
      <span style="color: #e0eee0">&lt;input</span> <span style="color: #e0eee0">type=</span><span style="color: #00e5ee">"my"</span> <span style="color: #e0eee0">ng-model=</span><span style="color: #00e5ee">"a"</span> <span style="color: #e0eee0">/&gt;</span>
      <span style="color: #e0eee0">&lt;button</span> <span style="color: #e0eee0">ng-click=</span><span style="color: #00e5ee">"show()"</span><span style="color: #e0eee0">&gt;</span>查看<span style="color: #e0eee0">&lt;/button&gt;</span>
    <span style="color: #e0eee0">&lt;/form&gt;</span>
  <span style="color: #e0eee0">&lt;/div&gt;</span>
</pre></div>



<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;"><span style="color: gray; padding: 0 5px 0 5px"> 1</span>   var app = angular.module('Demo', [], angular.noop);
<span style="color: gray; padding: 0 5px 0 5px"> 2</span>   
<span style="color: gray; padding: 0 5px 0 5px"> 3</span>   app.directive('input', function(){
<span style="color: gray; padding: 0 5px 0 5px"> 4</span>     var link = function($scope, $element, $attrs, $ctrl){
<span style="color: gray; padding: 0 5px 0 5px"> 5</span>       console.log($attrs.type);
<span style="color: gray; padding: 0 5px 0 5px"> 6</span>       var validator = function(v){
<span style="color: gray; padding: 0 5px 0 5px"> 7</span>         if(v == '123'){
<span style="color: gray; padding: 0 5px 0 5px"> 8</span>           $ctrl.$setValidity('my', true);
<span style="color: gray; padding: 0 5px 0 5px"> 9</span>           return v;
<span style="color: gray; padding: 0 5px 0 5px">10</span>         } else {
<span style="color: gray; padding: 0 5px 0 5px">11</span>           $ctrl.$setValidity('my', false);
<span style="color: gray; padding: 0 5px 0 5px">12</span>           return undefined;
<span style="color: gray; padding: 0 5px 0 5px">13</span>         }
<span style="color: gray; padding: 0 5px 0 5px">14</span>       }
<span style="color: gray; padding: 0 5px 0 5px">15</span>   
<span style="color: gray; padding: 0 5px 0 5px">16</span>       $ctrl.$formatters.push(validator);
<span style="color: gray; padding: 0 5px 0 5px">17</span>       $ctrl.$parsers.push(validator);
<span style="color: gray; padding: 0 5px 0 5px">18</span>     }
<span style="color: gray; padding: 0 5px 0 5px">19</span>   
<span style="color: gray; padding: 0 5px 0 5px">20</span>     return {compile: function(){return link},
<span style="color: gray; padding: 0 5px 0 5px">21</span>             require: 'ngModel',
<span style="color: gray; padding: 0 5px 0 5px">22</span>             restrict: 'E'}
<span style="color: gray; padding: 0 5px 0 5px">23</span>   });
<span style="color: gray; padding: 0 5px 0 5px">24</span>   
<span style="color: gray; padding: 0 5px 0 5px">25</span>   app.controller('TestCtrl', function($scope){
<span style="color: gray; padding: 0 5px 0 5px">26</span>       $scope.show = function(){
<span style="color: gray; padding: 0 5px 0 5px">27</span>         console.log($scope.f);
<span style="color: gray; padding: 0 5px 0 5px">28</span>       }
<span style="color: gray; padding: 0 5px 0 5px">29</span>   });
</pre></div>


<p style="margin: 15px 0;">
虽然官方原来定义了几种 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">type</code> ，但这不妨碍我们继续扩展新的类型。如果新的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">type</code> 参数值不在官方的定义列表里，那会按 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">text</code> 类型先做处理，这其实什么影响都没有。剩下的，就是写我们自己的验证逻辑就行了。
</p>
<p style="margin: 15px 0;">
上面的代码是参见官方的做法，使用格式化的过程，同时在里面做有效性检查。
</p>

<a id="toc80" name="toc80"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">18.12. 示例：文本框</h2>

<p style="margin: 15px 0;">
这个例子与官网上的那个例子相似。最终是要显示一个文本框，这个文本框由标题和内容两部分组成。而且标题和内容则是引用 controller 中的变量值。
</p>
<p style="margin: 15px 0;">
HTML 部分的代码：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;ys-block</span> <span style="color: #e0eee0">title=</span><span style="color: #00e5ee">"title"</span> <span style="color: #e0eee0">text=</span><span style="color: #00e5ee">"text"</span><span style="color: #e0eee0">&gt;</span>&lt;/ys-block&gt;
    <span style="color: #e0eee0">&lt;p&gt;</span>标题: <span style="color: #e0eee0">&lt;input</span> <span style="color: #e0eee0">ng-model=</span><span style="color: #00e5ee">"title"</span> <span style="color: #e0eee0">/&gt;&lt;/p&gt;</span>
    <span style="color: #e0eee0">&lt;p&gt;</span>内容: <span style="color: #e0eee0">&lt;input</span> <span style="color: #e0eee0">ng-model=</span><span style="color: #00e5ee">"text"</span> <span style="color: #e0eee0">/&gt;&lt;/p&gt;</span>
    <span style="color: #e0eee0">&lt;ys-block</span> <span style="color: #e0eee0">title=</span><span style="color: #00e5ee">"title"</span> <span style="color: #e0eee0">text=</span><span style="color: #00e5ee">"text"</span><span style="color: #e0eee0">&gt;</span>&lt;/ys-block&gt;
  <span style="color: #e0eee0">&lt;/div&gt;</span>
</pre></div>


<p style="margin: 15px 0;">
从这个期望实现效果的 HTML 代码中，我们可以考虑设计指令的实现方式：
</p>

<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li>这个指令的使用方式是“标签”， 即 <i style=" color: #d75100; font-style: normal; ">restrict</i> 这个参数应该设置为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">E</code> 。
</li>
<li>节点的属性值是对 controller 变量的引用，那么我们应该在指令的 <i style=" color: #d75100; font-style: normal; ">scope</i> 中使用 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">=</code> 的方式来指定成员值。
</li>
<li>最终的效果显示需要进行 DOM 结构的重构，那直接使用 <i style=" color: #d75100; font-style: normal; ">template</i> 就好了。
</li>
<li>自定义的标签在最终效果中是多余的，所有 <i style=" color: #d75100; font-style: normal; ">replace</i> 应该设置为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">true</code> 。
</li>
</ul>

<p style="margin: 15px 0;">
JS 部分的代码：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">app</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'Demo'</span>, [], <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">noop</span>);
  
  <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">directive</span>(<span style="color: #00e5ee">'ysBlock'</span>, <span style="color: #bcd2ee">function</span>(){
    <span style="color: #90ee90">return</span> {<span style="color: #e0eee0">compile</span><span style="color: #7fff00">:</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">noop</span>,
            <span style="color: #e0eee0">template</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'&lt;div style="width: 200px; border: 1px solid black;"&gt;&lt;h1 style="background-color: gray; color: white; font-size: 22px;"&gt;{{ title }}&lt;/h1&gt;&lt;div&gt;{{ text }}&lt;/div&gt;&lt;/div&gt;'</span>,
            <span style="color: #e0eee0">replace</span><span style="color: #7fff00">:</span> <span style="color: #90ee90">true</span>,
            <span style="color: #e0eee0">scope</span><span style="color: #7fff00">:</span> {<span style="color: #e0eee0">title</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'=title'</span>, <span style="color: #e0eee0">text</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'=text'</span>},
            <span style="color: #e0eee0">restrict</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'E'</span>};
  });
  
  <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">controller</span>(<span style="color: #00e5ee">'TestCtrl'</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>){
    <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">title</span> <span style="color: #7fff00">=</span> <span style="color: #00e5ee">'标题在这里'</span>;
    <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">text</span> <span style="color: #7fff00">=</span> <span style="color: #00e5ee">'内容在这里'</span>;
  });
  
  <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">bootstrap</span>(<span style="color: #e0eee0">document</span>, [<span style="color: #00e5ee">'Demo'</span>]);
</pre></div>


<p style="margin: 15px 0;">
可以看到，这种简单的组件式指令，只需要作 DOM 结构的变换即可实现，连 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">compile</code> 函数都不需要写。
</p>

<a id="toc81" name="toc81"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">18.13. 示例：模板控制语句 for</h2>

<p style="margin: 15px 0;">
这个示例尝试实现一个重复语句，功能同官方的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">ngRepeat</code> ，但是使用方式类似于我们通常编程语言中的 <i style=" color: #d75100; font-style: normal; ">for</i> 语句：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span> <span style="color: #e0eee0">ng-init=</span><span style="color: #00e5ee">"obj_list=[1,2,3,4]; name='name'"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;ul&gt;</span>
      <span style="color: #e0eee0">&lt;for</span> <span style="color: #e0eee0">o</span> <span style="color: #e0eee0">in</span> <span style="color: #e0eee0">obj_list&gt;</span>
        <span style="color: #e0eee0">&lt;li&gt;</span>{{ o }}, {{ name }}<span style="color: #e0eee0">&lt;/li&gt;</span>
      <span style="color: #e0eee0">&lt;/for&gt;</span>
    <span style="color: #e0eee0">&lt;/ul&gt;</span>
    <span style="color: #e0eee0">&lt;button</span> <span style="color: #e0eee0">ng-click=</span><span style="color: #00e5ee">"obj_list=[1,2]; name='o?'"</span><span style="color: #e0eee0">&gt;</span>修改<span style="color: #e0eee0">&lt;/button&gt;</span>
  <span style="color: #e0eee0">&lt;/div&gt;</span>
</pre></div>


<p style="margin: 15px 0;">
同样，我们从上面的使用方式去考虑这个指令的实现：
</p>

<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li>这是一个完全的控制指令，所以单个节点应该只有它一个指令起作用就好了，于是权重要比较高，并且“到此为止”—— <i style=" color: #d75100; font-style: normal; ">priority</i> 设置为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">1000</code> ， <i style=" color: #d75100; font-style: normal; ">terminal</i> 设置为 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">true</code> 。
</li>
<li>使用时的语法问题。事实上浏览器会把 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">for</code> 节点补充成一个正确的 HTML 结构，即里面的属性都会变成类似 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">o=""</code> 这样。我们通过节点的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">outerHTML</code> 属性取到字符串并解析取得需要的信息。
</li>
<li>我们把 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">for</code> 节点之间的内容作为一个模板，并且通过循环多次渲染该模板之后把结果填充到合适的位置。
</li>
<li>在处理上面的那个模板时，需要不断地创建新 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">scope</code> 的，并且 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">o</code> 这个成员需要单独赋值。
</li>
</ul>

<p style="margin: 15px 0;">
注意：这里只是简单实现功能。官方的那个 <i style=" color: #d75100; font-style: normal; ">ngRepeat</i> 比较复杂，是做了专门的算法优化的。当然，这里的实现也可以是简单把 DOM 结构变成使用 <i style=" color: #d75100; font-style: normal; ">ngRepeat</i> 的形式 :)
</p>
<p style="margin: 15px 0;">
JS 部分代码：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;"><span style="color: gray; padding: 0 5px 0 5px"> 1</span>   <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">app</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'Demo'</span>, [], <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">noop</span>);
<span style="color: gray; padding: 0 5px 0 5px"> 2</span>   
<span style="color: gray; padding: 0 5px 0 5px"> 3</span>   <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">directive</span>(<span style="color: #00e5ee">'for'</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$compile</span>){
<span style="color: gray; padding: 0 5px 0 5px"> 4</span>     <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">compile</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$element</span>, <span style="color: #e0eee0">$attrs</span>, <span style="color: #e0eee0">$link</span>){
<span style="color: gray; padding: 0 5px 0 5px"> 5</span>       <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">match</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$element</span>[<span style="color: #00ffff">0</span>].<span style="color: #e0eee0">outerHTML</span>.<span style="color: #e0eee0">match</span>(<span style="color: #00e5ee">'&lt;for (.*?)=.*? in=.*? (.*?)=.*?&gt;'</span>);
<span style="color: gray; padding: 0 5px 0 5px"> 6</span>       <span style="color: #90ee90">if</span>(<span style="color: #7fff00">!</span><span style="color: #e0eee0">match</span> <span style="color: #7fff00">||</span> <span style="color: #e0eee0">match</span>.<span style="color: #e0eee0">length</span> <span style="color: #7fff00">!=</span> <span style="color: #00ffff">3</span>){<span style="color: #90ee90">throw</span> <span style="color: #e0eee0">Error</span>(<span style="color: #00e5ee">'syntax: &lt;for o in obj_list&gt;'</span>)}
<span style="color: gray; padding: 0 5px 0 5px"> 7</span>       <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">iter</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">match</span>[<span style="color: #00ffff">1</span>];
<span style="color: gray; padding: 0 5px 0 5px"> 8</span>       <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">list</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">match</span>[<span style="color: #00ffff">2</span>];
<span style="color: gray; padding: 0 5px 0 5px"> 9</span>       <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">tpl</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$compile</span>(<span style="color: #e0eee0">$</span>.<span style="color: #e0eee0">trim</span>(<span style="color: #e0eee0">$element</span>.<span style="color: #e0eee0">html</span>()));
<span style="color: gray; padding: 0 5px 0 5px">10</span>       <span style="color: #e0eee0">$element</span>.<span style="color: #e0eee0">empty</span>();
<span style="color: gray; padding: 0 5px 0 5px">11</span>   
<span style="color: gray; padding: 0 5px 0 5px">12</span>       <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">link</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">$ielement</span>, <span style="color: #e0eee0">$iattrs</span>, <span style="color: #e0eee0">$controller</span>){
<span style="color: gray; padding: 0 5px 0 5px">13</span>   
<span style="color: gray; padding: 0 5px 0 5px">14</span>         <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">new_node</span> <span style="color: #7fff00">=</span> [];
<span style="color: gray; padding: 0 5px 0 5px">15</span>   
<span style="color: gray; padding: 0 5px 0 5px">16</span>         <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">$watch</span>(<span style="color: #e0eee0">list</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">list</span>){
<span style="color: gray; padding: 0 5px 0 5px">17</span>           <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">forEach</span>(<span style="color: #e0eee0">new_node</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">n</span>){<span style="color: #e0eee0">n</span>.<span style="color: #e0eee0">remove</span>()});
<span style="color: gray; padding: 0 5px 0 5px">18</span>           <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">scp</span>, <span style="color: #e0eee0">inode</span>;
<span style="color: gray; padding: 0 5px 0 5px">19</span>           <span style="color: #90ee90">for</span>(<span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">i</span> <span style="color: #7fff00">=</span> <span style="color: #00ffff">0</span>, <span style="color: #e0eee0">ii</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">list</span>.<span style="color: #e0eee0">length</span>; <span style="color: #e0eee0">i</span> <span style="color: #7fff00">&lt;</span> <span style="color: #e0eee0">ii</span>; <span style="color: #e0eee0">i</span><span style="color: #7fff00">++</span>){
<span style="color: gray; padding: 0 5px 0 5px">20</span>             <span style="color: #e0eee0">scp</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">$new</span>();
<span style="color: gray; padding: 0 5px 0 5px">21</span>             <span style="color: #e0eee0">scp</span>[<span style="color: #e0eee0">iter</span>] <span style="color: #7fff00">=</span> <span style="color: #e0eee0">list</span>[<span style="color: #e0eee0">i</span>];
<span style="color: gray; padding: 0 5px 0 5px">22</span>             <span style="color: #e0eee0">inode</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">tpl</span>(<span style="color: #e0eee0">scp</span>, <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">noop</span>);
<span style="color: gray; padding: 0 5px 0 5px">23</span>             <span style="color: #e0eee0">$ielement</span>.<span style="color: #e0eee0">before</span>(<span style="color: #e0eee0">inode</span>);
<span style="color: gray; padding: 0 5px 0 5px">24</span>             <span style="color: #e0eee0">new_node</span>.<span style="color: #e0eee0">push</span>(<span style="color: #e0eee0">inode</span>);
<span style="color: gray; padding: 0 5px 0 5px">25</span>           }
<span style="color: gray; padding: 0 5px 0 5px">26</span>   
<span style="color: gray; padding: 0 5px 0 5px">27</span>         });
<span style="color: gray; padding: 0 5px 0 5px">28</span>       }
<span style="color: gray; padding: 0 5px 0 5px">29</span>   
<span style="color: gray; padding: 0 5px 0 5px">30</span>       <span style="color: #90ee90">return</span> <span style="color: #e0eee0">link</span>;
<span style="color: gray; padding: 0 5px 0 5px">31</span>     }
<span style="color: gray; padding: 0 5px 0 5px">32</span>     <span style="color: #90ee90">return</span> {<span style="color: #e0eee0">compile</span><span style="color: #7fff00">:</span> <span style="color: #e0eee0">compile</span>,
<span style="color: gray; padding: 0 5px 0 5px">33</span>             <span style="color: #e0eee0">priority</span><span style="color: #7fff00">:</span> <span style="color: #00ffff">1000</span>,
<span style="color: gray; padding: 0 5px 0 5px">34</span>             <span style="color: #e0eee0">terminal</span><span style="color: #7fff00">:</span> <span style="color: #90ee90">true</span>,
<span style="color: gray; padding: 0 5px 0 5px">35</span>             <span style="color: #e0eee0">restrict</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'E'</span>};
<span style="color: gray; padding: 0 5px 0 5px">36</span>   });
<span style="color: gray; padding: 0 5px 0 5px">37</span>   
<span style="color: gray; padding: 0 5px 0 5px">38</span>   <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">controller</span>(<span style="color: #00e5ee">'TestCtrl'</span>, <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">noop</span>);
<span style="color: gray; padding: 0 5px 0 5px">39</span>   <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">bootstrap</span>(<span style="color: #e0eee0">document</span>, [<span style="color: #00e5ee">'Demo'</span>]);
</pre></div>


<a id="toc82" name="toc82"></a>
<h2 style=" border-bottom: 1px solid #69ab01; color: #5e9802; padding: 2px; text-shadow: 1px 1px 1px gray; margin: 20px auto; font-size: medium;">18.14. 示例：模板控制语句 if/else</h2>

<p style="margin: 15px 0;">
这个示例是尝试实现：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;">  <span style="color: #e0eee0">&lt;div</span> <span style="color: #e0eee0">ng-controller=</span><span style="color: #00e5ee">"TestCtrl"</span><span style="color: #e0eee0">&gt;</span>
    <span style="color: #e0eee0">&lt;if</span> <span style="color: #e0eee0">true=</span><span style="color: #00e5ee">"a == 1"</span><span style="color: #e0eee0">&gt;</span>
        <span style="color: #e0eee0">&lt;p&gt;</span>判断为真, {{ name }}<span style="color: #e0eee0">&lt;/p&gt;</span>
      <span style="color: #e0eee0">&lt;else&gt;</span>
        <span style="color: #e0eee0">&lt;p&gt;</span>判断为假, {{ name }}<span style="color: #e0eee0">&lt;/p&gt;</span>
      <span style="color: #e0eee0">&lt;/else&gt;</span>
    <span style="color: #e0eee0">&lt;/if&gt;</span>
  
    <span style="color: #e0eee0">&lt;div&gt;</span>
      <span style="color: #e0eee0">&lt;p&gt;</span>a: <span style="color: #e0eee0">&lt;input</span> <span style="color: #e0eee0">ng-model=</span><span style="color: #00e5ee">"a"</span> <span style="color: #e0eee0">/&gt;&lt;/p&gt;</span>
      <span style="color: #e0eee0">&lt;p&gt;</span>name: <span style="color: #e0eee0">&lt;input</span> <span style="color: #e0eee0">ng-model=</span><span style="color: #00e5ee">"name"</span> <span style="color: #e0eee0">/&gt;&lt;/p&gt;</span>
    <span style="color: #e0eee0">&lt;/div&gt;</span>
  <span style="color: #e0eee0">&lt;/div&gt;</span>
</pre></div>


<p style="margin: 15px 0;">
考虑实现的思路：
</p>

<ul style="line-height: 1.4em; padding: 0px; padding-left: 20px; margin: auto 30px;">
<li><i style=" color: #d75100; font-style: normal; ">else</i> 与 <i style=" color: #d75100; font-style: normal; ">if</i> 是两个指令，它们是父子关系。通过 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">scope</code> 可以联系起来。至于 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">scope</code> 是在 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">link</code> 中处理还是 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">controller</code> 中处理并不重要。
</li>
<li><i style=" color: #d75100; font-style: normal; ">true</i> 属性的条件判断通过 <i style=" color: #d75100; font-style: normal; ">$parse</i> 服务很容易实现。
</li>
<li>如果最终效果要去掉 <i style=" color: #d75100; font-style: normal; ">if</i> 节点，我们可以使用注释节点来“占位”。
</li>
</ul>

<p style="margin: 15px 0;">
JS 代码：
</p>

<div class="highlight" style="background: #103040"><pre style=" white-space: pre-wrap; word-wrap: break-word; border: 1px solid #888; font-size: small; line-height: 1.5em; padding: 5px;; color: #e0eee0;"><span style="color: gray; padding: 0 5px 0 5px"> 1</span>   <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">app</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">module</span>(<span style="color: #00e5ee">'Demo'</span>, [], <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">noop</span>);
<span style="color: gray; padding: 0 5px 0 5px"> 2</span>   
<span style="color: gray; padding: 0 5px 0 5px"> 3</span>   <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">directive</span>(<span style="color: #00e5ee">'if'</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$parse</span>, <span style="color: #e0eee0">$compile</span>){
<span style="color: gray; padding: 0 5px 0 5px"> 4</span>     <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">compile</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$element</span>, <span style="color: #e0eee0">$attrs</span>){
<span style="color: gray; padding: 0 5px 0 5px"> 5</span>       <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">cond</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$parse</span>(<span style="color: #e0eee0">$attrs</span>.<span style="color: #90ee90">true</span>);
<span style="color: gray; padding: 0 5px 0 5px"> 6</span>       
<span style="color: gray; padding: 0 5px 0 5px"> 7</span>       <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">link</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">$ielement</span>, <span style="color: #e0eee0">$iattrs</span>, <span style="color: #e0eee0">$controller</span>){
<span style="color: gray; padding: 0 5px 0 5px"> 8</span>         <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">if_node</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$compile</span>(<span style="color: #e0eee0">$</span>.<span style="color: #e0eee0">trim</span>(<span style="color: #e0eee0">$ielement</span>.<span style="color: #e0eee0">html</span>()))(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">noop</span>);
<span style="color: gray; padding: 0 5px 0 5px"> 9</span>         <span style="color: #e0eee0">$ielement</span>.<span style="color: #e0eee0">empty</span>();
<span style="color: gray; padding: 0 5px 0 5px">10</span>         <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">mark</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$</span>(<span style="color: #00e5ee">'&lt;!-- IF/ELSE --&gt;'</span>);
<span style="color: gray; padding: 0 5px 0 5px">11</span>         <span style="color: #e0eee0">$element</span>.<span style="color: #e0eee0">before</span>(<span style="color: #e0eee0">mark</span>);
<span style="color: gray; padding: 0 5px 0 5px">12</span>         <span style="color: #e0eee0">$element</span>.<span style="color: #e0eee0">remove</span>();
<span style="color: gray; padding: 0 5px 0 5px">13</span>   
<span style="color: gray; padding: 0 5px 0 5px">14</span>         <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">$watch</span>(<span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">scope</span>){
<span style="color: gray; padding: 0 5px 0 5px">15</span>           <span style="color: #90ee90">if</span>(<span style="color: #e0eee0">cond</span>(<span style="color: #e0eee0">scope</span>)){
<span style="color: gray; padding: 0 5px 0 5px">16</span>             <span style="color: #e0eee0">mark</span>.<span style="color: #e0eee0">after</span>(<span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">if_node</span>);
<span style="color: gray; padding: 0 5px 0 5px">17</span>             <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">else_node</span>.<span style="color: #e0eee0">detach</span>();
<span style="color: gray; padding: 0 5px 0 5px">18</span>           } <span style="color: #90ee90">else</span> {
<span style="color: gray; padding: 0 5px 0 5px">19</span>             <span style="color: #90ee90">if</span>(<span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">else_node</span> <span style="color: #7fff00">!==</span> <span style="color: #90ee90">undefined</span>){
<span style="color: gray; padding: 0 5px 0 5px">20</span>               <span style="color: #e0eee0">mark</span>.<span style="color: #e0eee0">after</span>(<span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">else_node</span>);
<span style="color: gray; padding: 0 5px 0 5px">21</span>               <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">if_node</span>.<span style="color: #e0eee0">detach</span>();
<span style="color: gray; padding: 0 5px 0 5px">22</span>             }
<span style="color: gray; padding: 0 5px 0 5px">23</span>           }
<span style="color: gray; padding: 0 5px 0 5px">24</span>         });
<span style="color: gray; padding: 0 5px 0 5px">25</span>       }
<span style="color: gray; padding: 0 5px 0 5px">26</span>       <span style="color: #90ee90">return</span> <span style="color: #e0eee0">link</span>;
<span style="color: gray; padding: 0 5px 0 5px">27</span>     }
<span style="color: gray; padding: 0 5px 0 5px">28</span>   
<span style="color: gray; padding: 0 5px 0 5px">29</span>     <span style="color: #90ee90">return</span> {<span style="color: #e0eee0">compile</span><span style="color: #7fff00">:</span> <span style="color: #e0eee0">compile</span>,
<span style="color: gray; padding: 0 5px 0 5px">30</span>             <span style="color: #e0eee0">scope</span><span style="color: #7fff00">:</span> <span style="color: #90ee90">true</span>,
<span style="color: gray; padding: 0 5px 0 5px">31</span>             <span style="color: #e0eee0">restrict</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'E'</span>}
<span style="color: gray; padding: 0 5px 0 5px">32</span>   });
<span style="color: gray; padding: 0 5px 0 5px">33</span>   
<span style="color: gray; padding: 0 5px 0 5px">34</span>   <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">directive</span>(<span style="color: #00e5ee">'else'</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$compile</span>){
<span style="color: gray; padding: 0 5px 0 5px">35</span>     <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">compile</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$element</span>, <span style="color: #e0eee0">$attrs</span>){
<span style="color: gray; padding: 0 5px 0 5px">36</span>       
<span style="color: gray; padding: 0 5px 0 5px">37</span>       <span style="color: #bcd2ee">var</span> <span style="color: #e0eee0">link</span> <span style="color: #7fff00">=</span> <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">$ielement</span>, <span style="color: #e0eee0">$iattrs</span>, <span style="color: #e0eee0">$controller</span>){
<span style="color: gray; padding: 0 5px 0 5px">38</span>         <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">else_node</span> <span style="color: #7fff00">=</span> <span style="color: #e0eee0">$compile</span>(<span style="color: #e0eee0">$</span>.<span style="color: #e0eee0">trim</span>(<span style="color: #e0eee0">$ielement</span>.<span style="color: #e0eee0">html</span>()))(<span style="color: #e0eee0">$scope</span>, <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">noop</span>);
<span style="color: gray; padding: 0 5px 0 5px">39</span>         <span style="color: #e0eee0">$element</span>.<span style="color: #e0eee0">remove</span>();
<span style="color: gray; padding: 0 5px 0 5px">40</span>       }
<span style="color: gray; padding: 0 5px 0 5px">41</span>       <span style="color: #90ee90">return</span> <span style="color: #e0eee0">link</span>;
<span style="color: gray; padding: 0 5px 0 5px">42</span>     }
<span style="color: gray; padding: 0 5px 0 5px">43</span>   
<span style="color: gray; padding: 0 5px 0 5px">44</span>     <span style="color: #90ee90">return</span> {<span style="color: #e0eee0">compile</span><span style="color: #7fff00">:</span> <span style="color: #e0eee0">compile</span>,
<span style="color: gray; padding: 0 5px 0 5px">45</span>             <span style="color: #e0eee0">restrict</span><span style="color: #7fff00">:</span> <span style="color: #00e5ee">'E'</span>}
<span style="color: gray; padding: 0 5px 0 5px">46</span>   });
<span style="color: gray; padding: 0 5px 0 5px">47</span>   
<span style="color: gray; padding: 0 5px 0 5px">48</span>   <span style="color: #e0eee0">app</span>.<span style="color: #e0eee0">controller</span>(<span style="color: #00e5ee">'TestCtrl'</span>, <span style="color: #bcd2ee">function</span>(<span style="color: #e0eee0">$scope</span>){
<span style="color: gray; padding: 0 5px 0 5px">49</span>     <span style="color: #e0eee0">$scope</span>.<span style="color: #e0eee0">a</span> <span style="color: #7fff00">=</span> <span style="color: #00ffff">1</span>;
<span style="color: gray; padding: 0 5px 0 5px">50</span>   });
<span style="color: gray; padding: 0 5px 0 5px">51</span>   
<span style="color: gray; padding: 0 5px 0 5px">52</span>   <span style="color: #e0eee0">angular</span>.<span style="color: #e0eee0">bootstrap</span>(<span style="color: #e0eee0">document</span>, [<span style="color: #00e5ee">'Demo'</span>]);
</pre></div>


<p style="margin: 15px 0;">
代码中注意一点，就是 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">if_node</code> 在得到之时，就已经是做了变量绑定的了。错误的思路是，在 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">$watch</code> 中再去不断地得到新的 <code style="margin: auto 3px; color: #228b22; font-family: monospace; ">if_node</code> 。
</p>

<script type="text/javascript">var prettyPrint = function(){}</script>
    

<div style=" -moz-border-radius: 5px; -webkit-border-radius: 5px; -moz-box-shadow: 3px 3px 5px #333; -webkit-box-shadow: 3px 3px 5px #333; box-shadow: 3px 3px 5px #333;  border-radius: 5px; background-color: #2a9af9; padding: 4px; color: white; line-height: 1.3em; text-shadow: 2px 2px 2px black; margin: 20px auto; font-size: medium; clear: both;">评论</div>
<div id="disqus_thread"><iframe verticalscrolling="no" horizontalscrolling="no" src="AngularJS.note_files/a.html" style="width: 100% ! important; border: medium none ! important; overflow: hidden ! important; height: 4486px ! important;" role="complementary" allowtransparency="true" data-disqus-uid="2" id="dsq2" scrolling="no" width="100%" frameborder="0"></iframe><iframe style="width: 700px ! important; border: medium none ! important; overflow: hidden ! important; top: 0px ! important; position: fixed ! important; height: 29px ! important; display: none ! important;" role="alert" allowtransparency="true" data-disqus-uid="-indicator-north" id="dsq-indicator-north" scrolling="no" frameborder="0"></iframe><iframe style="width: 700px ! important; border: medium none ! important; overflow: hidden ! important; bottom: 0px ! important; position: fixed ! important; height: 29px ! important; display: none ! important;" role="alert" allowtransparency="true" data-disqus-uid="-indicator-south" id="dsq-indicator-south" scrolling="no" frameborder="0"></iframe></div>
<script type="text/javascript">
  var disqus_shortname = 'zys';
  var disqus_identifier = 'angular';
  var disqus_url = 'http://zouyesheng.com/angular.html';
  var disqus_title = 'AngularJS学习笔记';

  (function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>评论功能需要javascript的支持</noscript>
    

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-29492100-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
    

<div style="font-size: x-small; text-align: right; margin-top: 50px;">
©2010-2013 zouyesheng.com All rights reserved. Powered by <a href="https://github.com/" target="_blank">GitHub</a> , <a href="http://txt2tags.org/" target="_blank">txt2tags</a> , <a href="http://www.mathjax.org/" target="_blank">MathJax</a>
</div>
    
<!-- xhtml code generated by txt2tags 2.6 (http://txt2tags.org) -->
</div></body></html>